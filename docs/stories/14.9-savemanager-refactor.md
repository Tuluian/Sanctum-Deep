# Story 14.9: SaveManager Refactor

## Status: Draft

## Story

**As a** developer,
**I want** to refactor SaveManager to support both local and cloud storage,
**so that** save operations can sync to the cloud without changing existing code.

## Acceptance Criteria

1. SaveManager continues to work exactly as before for guests (localStorage only)
2. When logged in, saves trigger cloud sync in addition to localStorage
3. localStorage remains the primary/immediate storage (for offline support)
4. Cloud sync is non-blocking (doesn't slow down save operations)
5. SaveManager exposes methods to manually trigger cloud sync
6. Existing code using SaveManager requires no changes

## Tasks

- [ ] Add CloudSyncService integration to SaveManager
- [ ] Modify saveNow() to trigger cloud sync when logged in
- [ ] Add syncToCloud() method for manual sync
- [ ] Add loadFromCloud() method for manual fetch
- [ ] Ensure all saves are non-blocking (async cloud sync)
- [ ] Add sync status tracking (pending, syncing, synced, error)
- [ ] Test that existing functionality is unchanged

## Technical Notes

### Current SaveManager (Unchanged Interface)

The existing SaveManager API should remain unchanged:

```typescript
// Existing API - keep all of these working
SaveManager.getSoulEchoes(): number
SaveManager.addSoulEchoes(amount: number): void
SaveManager.spendSoulEchoes(amount: number): boolean
SaveManager.hasActiveRun(): boolean
SaveManager.startNewRun(...): void
SaveManager.endRun(victory: boolean): void
// ... etc
```

### Refactored SaveManager

```typescript
// src/services/SaveManager.ts

import { CloudSyncService } from './CloudSyncService';
import { AuthService } from './AuthService';

type SyncStatus = 'idle' | 'pending' | 'syncing' | 'synced' | 'error';

class SaveManagerClass {
  private saveData: SaveData;
  private syncStatus: SyncStatus = 'idle';
  private pendingSyncTimeout: number | null = null;
  private syncStatusListeners: ((status: SyncStatus) => void)[] = [];

  constructor() {
    this.saveData = this.loadFromStorage() || createDefaultSave();
  }

  // ============================================
  // SYNC STATUS
  // ============================================

  getSyncStatus(): SyncStatus {
    return this.syncStatus;
  }

  onSyncStatusChange(callback: (status: SyncStatus) => void): () => void {
    this.syncStatusListeners.push(callback);
    return () => {
      this.syncStatusListeners = this.syncStatusListeners.filter(l => l !== callback);
    };
  }

  private setSyncStatus(status: SyncStatus): void {
    this.syncStatus = status;
    this.syncStatusListeners.forEach(cb => cb(status));
  }

  // ============================================
  // CORE SAVE LOGIC
  // ============================================

  private saveNow(): void {
    this.saveData.lastSaved = Date.now();

    // Always save to localStorage (immediate, offline-first)
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(this.saveData));
    } catch (e) {
      console.error('Failed to save to localStorage:', e);
    }

    // Queue cloud sync if logged in (non-blocking)
    if (AuthService.isAuthenticated()) {
      this.queueCloudSync();
    }
  }

  private queueCloudSync(): void {
    // Debounce cloud syncs to avoid excessive API calls
    if (this.pendingSyncTimeout) {
      clearTimeout(this.pendingSyncTimeout);
    }

    this.setSyncStatus('pending');

    // Wait 2 seconds before syncing (batches rapid saves)
    this.pendingSyncTimeout = window.setTimeout(() => {
      this.performCloudSync();
    }, 2000);
  }

  private async performCloudSync(): Promise<void> {
    this.setSyncStatus('syncing');

    try {
      await CloudSyncService.pushToCloud(this.saveData);
      this.setSyncStatus('synced');
    } catch (error) {
      console.error('Cloud sync failed:', error);
      this.setSyncStatus('error');
      // Queue for retry (handled by CloudSyncService)
      CloudSyncService.queueForRetry(this.saveData);
    }
  }

  // ============================================
  // MANUAL SYNC CONTROLS
  // ============================================

  /**
   * Force immediate sync to cloud (used by "Save to Cloud" button)
   */
  async syncToCloud(): Promise<void> {
    if (!AuthService.isAuthenticated()) {
      throw new Error('Must be logged in to sync to cloud');
    }

    // Cancel any pending debounced sync
    if (this.pendingSyncTimeout) {
      clearTimeout(this.pendingSyncTimeout);
      this.pendingSyncTimeout = null;
    }

    await this.performCloudSync();
  }

  /**
   * Load save data from cloud (used on login)
   */
  async loadFromCloud(): Promise<SaveData | null> {
    if (!AuthService.isAuthenticated()) {
      return null;
    }

    return CloudSyncService.pullFromCloud();
  }

  /**
   * Replace local save with provided data (used after cloud sync)
   */
  loadSaveData(data: Omit<SaveData, 'settings'>): void {
    // Preserve local settings, replace everything else
    this.saveData = {
      ...data,
      settings: this.saveData.settings
    };

    // Save to localStorage
    localStorage.setItem(STORAGE_KEY, JSON.stringify(this.saveData));
  }

  /**
   * Get raw save data (used for cloud sync)
   */
  getSaveData(): SaveData {
    return { ...this.saveData };
  }

  // ============================================
  // EXISTING METHODS (unchanged)
  // ============================================

  getSoulEchoes(): number {
    return this.saveData.meta.soulEchoes;
  }

  addSoulEchoes(amount: number): void {
    this.saveData.meta.soulEchoes += amount;
    this.saveNow();
  }

  // ... all other existing methods remain unchanged
}
```

### Cloud Sync Service Interface

```typescript
// src/services/CloudSyncService.ts

export class CloudSyncService {
  private static offlineQueue: SaveData[] = [];

  static async pushToCloud(data: SaveData): Promise<void> {
    const response = await fetch(`${API_URL}/api/sync/push`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...AuthService.getAuthHeaders()
      },
      body: JSON.stringify({
        data: compressSaveData(data),
        timestamp: data.lastSaved
      })
    });

    if (!response.ok) {
      throw new Error(`Sync failed: ${response.status}`);
    }
  }

  static async pullFromCloud(): Promise<SaveData | null> {
    const response = await fetch(`${API_URL}/api/sync/pull`, {
      headers: AuthService.getAuthHeaders()
    });

    if (response.status === 404) {
      return null; // No cloud data
    }

    if (!response.ok) {
      throw new Error(`Pull failed: ${response.status}`);
    }

    const { data } = await response.json();
    return decompressSaveData(data);
  }

  static queueForRetry(data: SaveData): void {
    this.offlineQueue.push(data);
    localStorage.setItem('sanctum_sync_queue', JSON.stringify(this.offlineQueue));
  }

  static async processOfflineQueue(): Promise<void> {
    const queued = localStorage.getItem('sanctum_sync_queue');
    if (!queued) return;

    this.offlineQueue = JSON.parse(queued);

    for (const data of this.offlineQueue) {
      try {
        await this.pushToCloud(data);
      } catch (e) {
        // Still offline, keep in queue
        return;
      }
    }

    // All synced, clear queue
    this.offlineQueue = [];
    localStorage.removeItem('sanctum_sync_queue');
  }
}
```

### Sync Flow Diagram

```
┌─────────────────────────────────────────────────────────┐
│                      Save Operation                      │
│  (addSoulEchoes, endRun, purchaseUpgrade, etc.)         │
└─────────────────────────┬───────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                      saveNow()                           │
│  1. Update lastSaved timestamp                          │
│  2. Write to localStorage (immediate)                   │
│  3. If logged in: queueCloudSync()                      │
└─────────────────────────┬───────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                   queueCloudSync()                       │
│  1. Set status = 'pending'                              │
│  2. Debounce 2 seconds                                  │
│  3. Call performCloudSync()                             │
└─────────────────────────┬───────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                 performCloudSync()                       │
│  1. Set status = 'syncing'                              │
│  2. POST to /api/sync/push                              │
│  3. On success: status = 'synced'                       │
│  4. On failure: status = 'error', queue for retry       │
└─────────────────────────────────────────────────────────┘
```

## Definition of Done

- [ ] All existing SaveManager tests pass
- [ ] Saves trigger cloud sync when logged in
- [ ] Saves work instantly (localStorage) even when sync is slow
- [ ] Sync status is trackable for UI
- [ ] Manual syncToCloud() works
- [ ] No changes required to calling code

## Dependencies

- Story 14.4 (API Layer Setup)
- Story 14.6 or 14.7 (Auth - for testing)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-05 | 1.0 | Story created | Mary (Analyst) |
