# Story 15.3: Error Tracking & Monitoring

## Status: Draft

## Story

**As a** game developer,
**I want** production error tracking and monitoring,
**so that** I can identify and fix issues players encounter.

## Acceptance Criteria

1. Error tracking service integrated (Sentry or similar)
2. Uncaught exceptions are captured and reported
3. Source maps uploaded for readable stack traces
4. Environment (production/development) is tagged
5. User context is anonymized (no PII)
6. Error dashboard accessible to developers
7. Critical errors trigger notifications

## Tasks / Subtasks

- [ ] Set up Sentry account and project (AC: 1, 6)
  - [ ] Create Sentry account (free tier)
  - [ ] Create new project for Sanctum Ruins
  - [ ] Note DSN for configuration
- [ ] Install and configure Sentry SDK (AC: 1, 2)
  - [ ] Install `@sentry/browser` package
  - [ ] Initialize Sentry in `src/main.ts`
  - [ ] Configure DSN via environment variable
- [ ] Configure source maps (AC: 3)
  - [ ] Update Vite config to generate source maps
  - [ ] Add Sentry Vite plugin for upload
  - [ ] Configure release versioning
- [ ] Set up environment tagging (AC: 4)
  - [ ] Tag errors with `production` or `development`
  - [ ] Add app version to tags
- [ ] Configure privacy settings (AC: 5)
  - [ ] Disable default PII collection
  - [ ] Remove user IP tracking
  - [ ] Scrub sensitive data from breadcrumbs
- [ ] Set up alerts (AC: 7)
  - [ ] Configure alert rules for new issues
  - [ ] Set up email notifications
  - [ ] Define critical error thresholds

## Dev Notes

### Sentry Installation

```bash
npm install @sentry/browser @sentry/vite-plugin
```

### Sentry Initialization

```typescript
// src/main.ts (at the very top)
import * as Sentry from '@sentry/browser';

if (import.meta.env.PROD) {
  Sentry.init({
    dsn: import.meta.env.VITE_SENTRY_DSN,
    environment: import.meta.env.MODE,
    release: `sanctum-ruins@${import.meta.env.VITE_APP_VERSION}`,

    // Privacy: don't send PII
    sendDefaultPii: false,

    // Sample rate for performance (optional)
    tracesSampleRate: 0.1,

    // Filter out known non-issues
    ignoreErrors: [
      'ResizeObserver loop limit exceeded',
      'Network request failed',
    ],

    beforeSend(event) {
      // Scrub any accidental PII
      if (event.user) {
        delete event.user.ip_address;
        delete event.user.email;
      }
      return event;
    },
  });
}
```

### Vite Config for Source Maps

```typescript
// vite.config.ts
import { sentryVitePlugin } from '@sentry/vite-plugin';

export default defineConfig({
  build: {
    sourcemap: true,
  },
  plugins: [
    sentryVitePlugin({
      org: 'your-org',
      project: 'sanctum-ruins',
      authToken: process.env.SENTRY_AUTH_TOKEN,
    }),
  ],
});
```

### Environment Variables

Add to `.env.example`:
```
VITE_SENTRY_DSN=https://xxx@xxx.ingest.sentry.io/xxx
VITE_APP_VERSION=1.0.0
```

Add to GitHub Secrets for CI:
```
SENTRY_AUTH_TOKEN=xxx
```

### Manual Error Reporting (Optional)

```typescript
// For catching specific errors
try {
  riskyOperation();
} catch (error) {
  Sentry.captureException(error, {
    tags: { feature: 'combat' },
    extra: { enemyId, cardId },
  });
}
```

### Relevant Files
- `src/main.ts` (modify - add Sentry init)
- `vite.config.ts` (modify - add plugin)
- `.env.example` (modify - add variables)
- `package.json` (modify - add dependencies)

## Testing

- Test file location: N/A (manual verification)
- Verification steps:
  - Trigger an error in development, check Sentry dashboard
  - Verify stack traces show original TypeScript code
  - Verify no PII appears in error reports

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-05 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

_To be filled by Dev agent_

---

## QA Results

_To be filled by QA agent_
