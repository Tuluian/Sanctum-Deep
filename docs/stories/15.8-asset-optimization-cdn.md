# Story 15.8: Asset Optimization & CDN

## Status: Draft

## Story

**As a** player loading the game,
**I want** assets to load quickly from nearby servers,
**so that** I have fast load times regardless of my location.

## Acceptance Criteria

1. Static assets served with proper cache headers
2. Images converted to modern formats (WebP) where beneficial
3. Audio files optimized for web delivery
4. CDN evaluated and optionally configured
5. Asset versioning prevents stale cache issues
6. Total asset payload documented and optimized
7. Loading screen shows meaningful progress

## Tasks / Subtasks

- [ ] Audit current asset sizes (AC: 6)
  - [ ] Inventory all images with sizes
  - [ ] Inventory all audio files with sizes
  - [ ] Document total payload
- [ ] Optimize images (AC: 2)
  - [ ] Convert large PNGs to WebP
  - [ ] Resize oversized images to max display size
  - [ ] Compress without visible quality loss
  - [ ] Create srcset for responsive images if needed
- [ ] Optimize audio (AC: 3)
  - [ ] Convert to OGG/MP3 at appropriate bitrate
  - [ ] Remove silence from beginning/end
  - [ ] Consider audio sprites for short SFX
- [ ] Configure cache headers (AC: 1, 5)
  - [ ] Set long cache (1 year) for hashed assets
  - [ ] Set short cache for index.html
  - [ ] Verify Vite's content hashing works
- [ ] Evaluate CDN options (AC: 4)
  - [ ] Document current Heroku asset delivery
  - [ ] Research Cloudflare (free tier)
  - [ ] Research other CDN options
  - [ ] Make recommendation
- [ ] Implement loading progress (AC: 7)
  - [ ] Track asset loading progress
  - [ ] Display meaningful loading bar
  - [ ] Show loading tips/lore during load

## Dev Notes

### Current Asset Inventory

Run to get baseline:
```bash
# List all assets with sizes
find public -type f -exec ls -lh {} \; | awk '{print $5, $9}' | sort -h

# Total size
du -sh public/
du -sh public/images/
du -sh public/audio/
```

### Image Optimization

**WebP Conversion:**
```bash
# Using sharp CLI
npm install -g sharp-cli
sharp -i public/images/**/*.png -o public/images/ -f webp -q 80
```

**Recommended sizes:**
- Character portraits: 256x256 max
- Card art: 200x280 max
- Backgrounds: 1920x1080 max
- Icons: 64x64 max

**HTML with fallback:**
```html
<picture>
  <source srcset="image.webp" type="image/webp">
  <source srcset="image.png" type="image/png">
  <img src="image.png" alt="..." loading="lazy">
</picture>
```

### Audio Optimization

**Recommended settings:**
- Music: OGG Vorbis, 128kbps
- SFX: OGG Vorbis, 96kbps
- Voice: OGG Vorbis, 64kbps (mono)

**FFmpeg conversion:**
```bash
# Convert to OGG
ffmpeg -i input.mp3 -c:a libvorbis -b:a 128k output.ogg

# Trim silence
ffmpeg -i input.ogg -af silenceremove=1:0:-50dB output.ogg
```

### Cache Headers (Express/Heroku)

```javascript
// server.js
app.use(express.static('dist', {
  maxAge: '1y', // Long cache for hashed files
  etag: true,
  setHeaders: (res, path) => {
    // Short cache for HTML (not hashed)
    if (path.endsWith('.html')) {
      res.setHeader('Cache-Control', 'no-cache');
    }
  },
}));
```

### Vite Asset Hashing

Vite automatically hashes assets:
- `index-[hash].js`
- `style-[hash].css`
- Images in `assets/` folder

Verify in `vite.config.ts`:
```typescript
build: {
  assetsDir: 'assets',
  rollupOptions: {
    output: {
      assetFileNames: 'assets/[name]-[hash][extname]',
      chunkFileNames: 'assets/[name]-[hash].js',
      entryFileNames: 'assets/[name]-[hash].js',
    },
  },
}
```

### CDN Options

| CDN | Free Tier | Pros | Cons |
|-----|-----------|------|------|
| Cloudflare | Yes | Easy setup, good perf | None for our scale |
| AWS CloudFront | Limited | Deep AWS integration | More complex |
| Heroku Edge | N/A | Already using | Limited features |

**Cloudflare Setup (if chosen):**
1. Add domain to Cloudflare
2. Update DNS to Cloudflare nameservers
3. Enable caching rules
4. Enable auto-minification

### Loading Progress Implementation

```typescript
// src/utils/AssetLoader.ts
class AssetLoader {
  private loaded = 0;
  private total = 0;
  private onProgress?: (percent: number) => void;

  async loadAll(assets: string[], onProgress: (p: number) => void) {
    this.total = assets.length;
    this.onProgress = onProgress;

    await Promise.all(assets.map(async (url) => {
      await this.loadAsset(url);
      this.loaded++;
      this.onProgress?.(this.loaded / this.total);
    }));
  }

  private async loadAsset(url: string): Promise<void> {
    if (url.match(/\.(png|jpg|webp)$/)) {
      return this.loadImage(url);
    } else if (url.match(/\.(ogg|mp3)$/)) {
      return this.loadAudio(url);
    }
  }
}
```

### Relevant Files
- `public/images/` (optimize)
- `public/audio/` (optimize)
- `server.js` (cache headers)
- `vite.config.ts` (verify hashing)
- `src/utils/AssetLoader.ts` (new, optional)

## Testing

- Test file location: N/A (performance)
- Tools: Chrome DevTools Network tab, Lighthouse
- Verify:
  - Assets load from cache on refresh
  - No 304s for hashed assets (should be cache hit)
  - index.html always fetched fresh

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-05 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

_To be filled by Dev agent_

---

## QA Results

_To be filled by QA agent_
