# Story 15.4: Performance Optimization

## Status: Draft

## Story

**As a** player on various devices,
**I want** the game to load quickly and run smoothly,
**so that** I have an enjoyable experience without lag or delays.

## Acceptance Criteria

1. Initial page load under 3 seconds on 3G connection
2. Lighthouse Performance score 90+
3. JavaScript bundle size under 500KB (gzipped)
4. Images optimized and lazy-loaded where appropriate
5. Audio files compressed and loaded on demand
6. No layout shifts during load (CLS < 0.1)
7. First Contentful Paint under 1.5 seconds

## Tasks / Subtasks

- [ ] Analyze current bundle size (AC: 3)
  - [ ] Run `npm run build` and check dist/ sizes
  - [ ] Use `vite-bundle-visualizer` to identify large modules
  - [ ] Document current baseline metrics
- [ ] Configure code splitting (AC: 3, 1)
  - [ ] Split by route/screen where possible
  - [ ] Lazy load non-critical modules
  - [ ] Configure Vite chunk strategy
- [ ] Optimize images (AC: 4)
  - [ ] Convert large PNGs to WebP with fallback
  - [ ] Implement lazy loading for off-screen images
  - [ ] Add width/height attributes to prevent layout shift
  - [ ] Consider sprite sheets for small icons
- [ ] Optimize audio (AC: 5)
  - [ ] Compress audio files (OGG format)
  - [ ] Load audio on demand, not on page load
  - [ ] Implement audio sprite for short SFX
- [ ] Add compression (AC: 1, 3)
  - [ ] Enable gzip/brotli in Vite build
  - [ ] Verify Heroku serves compressed assets
- [ ] Fix layout shifts (AC: 6)
  - [ ] Add explicit dimensions to images
  - [ ] Reserve space for dynamically loaded content
  - [ ] Use font-display: swap for custom fonts
- [ ] Run Lighthouse audit (AC: 2, 7)
  - [ ] Document baseline scores
  - [ ] Address each recommendation
  - [ ] Re-test until 90+ achieved

## Dev Notes

### Bundle Analysis

```bash
# Install analyzer
npm install -D rollup-plugin-visualizer

# Add to vite.config.ts
import { visualizer } from 'rollup-plugin-visualizer';

plugins: [
  visualizer({
    filename: 'dist/stats.html',
    open: true,
  }),
]
```

### Vite Code Splitting

```typescript
// vite.config.ts
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          // Separate vendor chunks
          vendor: ['pixi.js'], // if using
        },
      },
    },
    chunkSizeWarningLimit: 500,
  },
});
```

### Image Optimization

For WebP conversion:
```bash
# Using sharp or imagemin
npx sharp-cli --input public/images/**/*.png --output public/images/ --format webp
```

HTML with fallback:
```html
<picture>
  <source srcset="image.webp" type="image/webp">
  <img src="image.png" alt="..." loading="lazy" width="100" height="100">
</picture>
```

### Audio Loading Strategy

```typescript
// Load audio only when needed
class AudioManager {
  private cache = new Map<string, HTMLAudioElement>();

  async load(key: string, src: string): Promise<void> {
    if (this.cache.has(key)) return;
    const audio = new Audio();
    audio.preload = 'auto';
    audio.src = src;
    await audio.load();
    this.cache.set(key, audio);
  }
}
```

### Compression in Vite

```typescript
// vite.config.ts
import viteCompression from 'vite-plugin-compression';

plugins: [
  viteCompression({
    algorithm: 'gzip',
    ext: '.gz',
  }),
  viteCompression({
    algorithm: 'brotliCompress',
    ext: '.br',
  }),
]
```

### Lighthouse CLI

```bash
# Install
npm install -g lighthouse

# Run audit
lighthouse http://localhost:3000 --output html --output-path ./lighthouse-report.html
```

### Performance Budget

| Metric | Target | Current |
|--------|--------|---------|
| JS Bundle (gzip) | < 500KB | TBD |
| Total Page Weight | < 2MB | TBD |
| FCP | < 1.5s | TBD |
| LCP | < 2.5s | TBD |
| CLS | < 0.1 | TBD |

### Relevant Files
- `vite.config.ts` (modify)
- `src/main.ts` (potential lazy loading)
- `public/images/` (optimize)
- `public/audio/` (optimize)
- `index.html` (add preload hints)

## Testing

- Test file location: N/A (performance testing)
- Tools: Lighthouse, WebPageTest, Chrome DevTools
- Test on throttled 3G connection in DevTools

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-05 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

_To be filled by Dev agent_

---

## QA Results

_To be filled by QA agent_
