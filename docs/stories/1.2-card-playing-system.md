# Story 1.2: Card Playing System

## Status: Draft

## Story

**As a** player,
**I want** to play cards from my hand to deal damage, gain block, and heal,
**so that** I can defeat enemies and survive combat.

## Acceptance Criteria

1. Cards can only be played if player has sufficient Resolve
2. Playing a card deducts its Resolve cost from player's current Resolve
3. Attack cards require a valid enemy target selection
4. Skill cards apply effects to player (no target required)
5. Card effects execute in order: damage → block → heal → status effects
6. Played cards move from hand to discard pile
7. Cards with multiple effects execute all effects in sequence
8. Unplayable cards (insufficient Resolve) are visually indicated

## Tasks / Subtasks

- [ ] Create card type definitions (AC: 1, 3, 4)
  - [ ] Define `Card` interface with id, name, type, cost, description, effects
  - [ ] Define `CardType` enum: ATTACK, SKILL, POWER, CURSE
  - [ ] Define `CardEffect` interface with type, amount, target
  - [ ] Define `EffectType` enum: DAMAGE, BLOCK, HEAL, APPLY_STATUS, GAIN_DEVOTION

- [ ] Implement card cost validation (AC: 1, 2)
  - [ ] `canPlayCard(card)` - returns true if player.resolve >= card.cost
  - [ ] `getPlayableCards()` - returns array of cards in hand that can be played
  - [ ] Deduct resolve cost when card is played successfully

- [ ] Implement targeting system (AC: 3, 4)
  - [ ] `requiresTarget(card)` - returns true for ATTACK cards
  - [ ] `getValidTargets(card)` - returns array of valid enemy targets (alive enemies)
  - [ ] `playCard(cardIndex, targetIndex?)` - plays card with optional target
  - [ ] Reject card play if attack card has no valid target

- [ ] Implement card effect engine (AC: 5, 7)
  - [ ] `executeEffect(effect, target?)` - executes single effect
  - [ ] `executeCardEffects(card, target?)` - executes all effects in sequence
  - [ ] Effect order: DAMAGE first, then BLOCK, then HEAL, then others
  - [ ] Each effect resolves completely before next begins

- [ ] Implement damage calculation (AC: 5)
  - [ ] `dealDamage(target, amount)` - applies damage to enemy
  - [ ] Damage reduces target block first, remainder hits HP
  - [ ] Target HP cannot go below 0
  - [ ] Return actual damage dealt for logging

- [ ] Implement block gain (AC: 5)
  - [ ] `gainBlock(amount)` - adds block to player
  - [ ] Block stacks with existing block
  - [ ] No cap on block (for now)

- [ ] Implement healing (AC: 5)
  - [ ] `heal(amount)` - restores player HP
  - [ ] Healing capped at maxHp
  - [ ] Return actual amount healed for logging

- [ ] Implement card movement (AC: 6)
  - [ ] Remove played card from hand array
  - [ ] Add played card to discard pile array
  - [ ] Maintain card instance IDs for tracking

- [ ] Implement draw system
  - [ ] `drawCards(count)` - draws cards from draw pile to hand
  - [ ] If draw pile empty, shuffle discard pile into draw pile
  - [ ] `shuffleDeck(cards)` - randomizes card order
  - [ ] Standard draw is 5 cards at turn start

- [ ] Write unit tests for card playing
  - [ ] Test card cannot be played with insufficient Resolve
  - [ ] Test Resolve is deducted after playing card
  - [ ] Test attack card requires target
  - [ ] Test skill card works without target
  - [ ] Test damage reduces enemy block then HP
  - [ ] Test healing caps at max HP
  - [ ] Test card moves to discard after play
  - [ ] Test multi-effect cards execute all effects

## Dev Notes

### Card Structure (from IDEAS.txt)

```typescript
interface Card {
  id: string;           // Unique card definition ID (e.g., 'smite')
  instanceId: string;   // Unique instance ID (e.g., 'smite_0')
  name: string;         // Display name
  type: CardType;       // ATTACK, SKILL, POWER, CURSE
  cost: number;         // Resolve cost (0-3 typically)
  description: string;  // Effect description text
  effects: CardEffect[];
}

interface CardEffect {
  type: EffectType;
  amount: number;
  target?: 'self' | 'enemy' | 'all_enemies';
}

enum EffectType {
  DAMAGE = 'DAMAGE',
  BLOCK = 'BLOCK',
  HEAL = 'HEAL',
  APPLY_STATUS = 'APPLY_STATUS',
  GAIN_DEVOTION = 'GAIN_DEVOTION'
}
```

### Damage Calculation Logic

```typescript
function dealDamage(enemy: EnemyState, amount: number): number {
  const blockedDamage = Math.min(amount, enemy.block);
  enemy.block -= blockedDamage;

  const hpDamage = amount - blockedDamage;
  enemy.hp = Math.max(0, enemy.hp - hpDamage);

  return hpDamage; // Return damage that hit HP
}
```

### Effect Execution Order

Per IDEAS.txt, when a card has multiple effects, execute in this order:
1. DAMAGE effects (to allow "deal damage, then heal based on damage" patterns later)
2. BLOCK effects
3. HEAL effects
4. Status effects (APPLY_STATUS)
5. Resource effects (GAIN_DEVOTION)

### Prototype Reference

The existing `sanctum-deep-mobile.html` has these relevant methods:
- `playCard(cardIndex, targetIndex)` - basic implementation
- `applyEffect(effect, target)` - switch statement for effect types
- `dealDamage(enemy, damage)` - damage calculation with block

### File Structure

```
src/
  combat/
    types.ts           - Card and effect types (extend from Story 1.1)
    CombatEngine.ts    - Add card playing methods
    CardEffects.ts     - Effect execution logic
  cards/
    CardDatabase.ts    - Card definitions (Story 1.3)
  tests/
    combat/
      CardPlaying.test.ts
```

### Integration with Story 1.1

This story extends the CombatEngine from Story 1.1:
- Add `playCard()` method to CombatEngine
- Emit state change events when cards are played
- Check `canPlayerAct()` before allowing card plays

## Testing

### Test File Location
`src/tests/combat/CardPlaying.test.ts`

### Key Test Scenarios

1. **Resolve Validation**: Card with cost 2 cannot be played with 1 Resolve
2. **Resolve Deduction**: Playing 1-cost card reduces Resolve from 3 to 2
3. **Target Requirement**: Attack card fails without target, succeeds with target
4. **Skill Cards**: Shield of Faith works without target selection
5. **Damage Flow**: 8 damage vs 5 block = 5 blocked + 3 HP damage
6. **Heal Cap**: Healing 10 at 70/75 HP results in 75/75 HP
7. **Multi-Effect**: Consecrate deals damage AND heals in one play
8. **Card Movement**: Card is in discard pile after being played

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-03 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_
