# Story 14.16: Create Account Prompt for Guests

## Status: Draft

## Story

**As a** guest player who just won a run,
**I want** to be gently reminded to create an account,
**so that** I don't lose my hard-earned progress.

## Acceptance Criteria

1. After first victory as guest, show "Save your progress" prompt
2. Prompt is dismissible ("Not now" option)
3. Prompt doesn't appear every time (max once per session, or once per X victories)
4. Prompt shows what would be saved (Soul Echoes earned, achievements)
5. Prompt leads to auth screen
6. Logged-in users never see this prompt
7. Prompt is not intrusive during active gameplay

## Tasks

- [ ] Create GuestAccountPrompt component
- [ ] Add trigger after first guest victory
- [ ] Implement dismissal with session memory
- [ ] Show progress summary in prompt
- [ ] Link to auth screen with return navigation
- [ ] Track prompt shown state in sessionStorage

## Technical Notes

### When to Show Prompt

```typescript
// Track prompt state
const PROMPT_SHOWN_KEY = 'sanctum_account_prompt_shown';

function shouldShowAccountPrompt(): boolean {
  // Never show for logged-in users
  if (AuthService.isAuthenticated()) return false;

  // Check if already shown this session
  if (sessionStorage.getItem(PROMPT_SHOWN_KEY)) return false;

  // Show after first victory
  const stats = SaveManager.getStatistics();
  return stats.totalWins >= 1;
}

function markPromptShown(): void {
  sessionStorage.setItem(PROMPT_SHOWN_KEY, 'true');
}
```

### Integration Point

Show the prompt on the victory screen:

```typescript
// src/ui/screens/VictoryScreen.ts

function renderVictoryScreen(soulEchoesEarned: number): void {
  const container = document.getElementById('screen-container');

  container.innerHTML = `
    <div class="victory-screen">
      <h1>Victory!</h1>
      <!-- ... victory content ... -->
    </div>
  `;

  // Check if we should prompt for account
  if (shouldShowAccountPrompt()) {
    setTimeout(() => {
      showAccountPrompt(soulEchoesEarned);
    }, 2000); // Delay so player can enjoy victory moment
  }
}
```

### Account Prompt Component

```typescript
// src/ui/components/GuestAccountPrompt.ts

function showAccountPrompt(recentEchoes: number): void {
  markPromptShown();

  const stats = SaveManager.getStatistics();
  const meta = SaveManager.getSaveData().meta;

  const modal = document.createElement('div');
  modal.className = 'account-prompt-overlay';
  modal.innerHTML = `
    <div class="account-prompt">
      <div class="prompt-header">
        <span class="prompt-icon">☁️</span>
        <h2>Save Your Progress?</h2>
      </div>

      <p class="prompt-message">
        You're playing as a guest. Create a free account to save your progress
        to the cloud and play on any device.
      </p>

      <div class="progress-preview">
        <h3>Your Progress</h3>
        <div class="progress-stats">
          <div class="stat-item">
            <span class="stat-value">${meta.soulEchoes}</span>
            <span class="stat-label">Soul Echoes</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">${meta.unlockedAchievements.length}</span>
            <span class="stat-label">Achievements</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">${stats.totalWins}</span>
            <span class="stat-label">Victories</span>
          </div>
        </div>
      </div>

      <div class="prompt-warning">
        ⚠️ Without an account, clearing your browser data will erase your progress.
      </div>

      <div class="prompt-buttons">
        <button class="btn primary" onclick="handleCreateAccount()">
          Create Free Account
        </button>
        <button class="btn secondary" onclick="dismissAccountPrompt()">
          Not Now
        </button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  // Close on overlay click
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      dismissAccountPrompt();
    }
  });
}

function dismissAccountPrompt(): void {
  const modal = document.querySelector('.account-prompt-overlay');
  if (modal) {
    modal.classList.add('closing');
    setTimeout(() => modal.remove(), 300);
  }
}

function handleCreateAccount(): void {
  dismissAccountPrompt();
  showAuthScreen('victory'); // Return to victory screen after auth
}

// Expose to window
(window as any).handleCreateAccount = handleCreateAccount;
(window as any).dismissAccountPrompt = dismissAccountPrompt;
```

### CSS Styles

```css
.account-prompt-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.75);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  animation: fadeIn 0.3s ease;
}

.account-prompt-overlay.closing {
  animation: fadeOut 0.3s ease forwards;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes fadeOut {
  from { opacity: 1; }
  to { opacity: 0; }
}

.account-prompt {
  background: var(--color-surface);
  border-radius: 16px;
  padding: 2rem;
  max-width: 400px;
  width: 90%;
  text-align: center;
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.prompt-header {
  margin-bottom: 1rem;
}

.prompt-icon {
  font-size: 3rem;
  display: block;
  margin-bottom: 0.5rem;
}

.prompt-header h2 {
  font-size: 1.5rem;
  margin: 0;
}

.prompt-message {
  color: var(--color-muted);
  font-size: 0.9375rem;
  line-height: 1.5;
  margin-bottom: 1.5rem;
}

.progress-preview {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  padding: 1rem;
  margin-bottom: 1rem;
}

.progress-preview h3 {
  font-size: 0.75rem;
  text-transform: uppercase;
  color: var(--color-muted);
  margin: 0 0 0.75rem 0;
}

.progress-stats {
  display: flex;
  justify-content: space-around;
}

.stat-item {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.stat-value {
  font-size: 1.5rem;
  font-weight: bold;
  color: var(--color-accent);
}

.stat-label {
  font-size: 0.75rem;
  color: var(--color-muted);
}

.prompt-warning {
  font-size: 0.8125rem;
  color: var(--color-warning);
  margin-bottom: 1.5rem;
  padding: 0.75rem;
  background: rgba(255, 193, 7, 0.1);
  border-radius: 8px;
}

.prompt-buttons {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.prompt-buttons .btn {
  width: 100%;
  padding: 0.875rem;
  font-size: 1rem;
}

.prompt-buttons .btn.secondary {
  background: transparent;
  color: var(--color-muted);
}
```

### Frequency Control

To avoid annoying players, limit how often the prompt appears:

```typescript
// Alternative: Show every 3 victories instead of once per session
const PROMPT_VICTORY_THRESHOLD = 3;

function shouldShowAccountPrompt(): boolean {
  if (AuthService.isAuthenticated()) return false;

  const stats = SaveManager.getStatistics();
  const lastPromptVictories = parseInt(
    localStorage.getItem('account_prompt_at_victories') || '0'
  );

  // Show if this is their first win, or every 3 wins after dismissing
  if (stats.totalWins === 1) return true;
  if (stats.totalWins - lastPromptVictories >= PROMPT_VICTORY_THRESHOLD) return true;

  return false;
}

function markPromptShown(): void {
  localStorage.setItem(
    'account_prompt_at_victories',
    SaveManager.getStatistics().totalWins.toString()
  );
}
```

## Definition of Done

- [ ] Prompt appears after first guest victory
- [ ] Prompt shows progress summary
- [ ] "Create Account" leads to auth screen
- [ ] "Not Now" dismisses without nagging again
- [ ] Logged-in users never see prompt
- [ ] Prompt is visually appealing and not intrusive

## Dependencies

- Story 14.14 (Login/Register Screen)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-05 | 1.0 | Story created | Mary (Analyst) |
