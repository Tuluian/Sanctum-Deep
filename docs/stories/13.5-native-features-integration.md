# Story 13.5: Native iOS Features Integration

## Status: In Progress

## Story

**As a** mobile player,
**I want** native iOS features integrated into the game,
**so that** the app feels polished and uses platform capabilities.

## Acceptance Criteria

1. Push notifications for daily rewards/reminders (optional)
2. Game Center achievements integration (optional)
3. iCloud save sync across devices
4. Share sheet for sharing victories
5. Handoff support (continue on another Apple device)
6. Spotlight indexing for quick access
7. App shortcuts (Siri Shortcuts) for quick run start
8. Widget for daily challenge status (optional, future)

## Background

These features enhance the iOS experience but are **lower priority** than core gameplay. Implement based on available time and business value.

**Recommended MVP iOS Features**: 3 (iCloud saves), 4 (Share sheet)
**Nice to Have**: 1 (Push), 2 (Game Center), 5-7

## Tasks / Subtasks

### Priority 1: Core Native Features

- [x] iCloud save sync (AC: 3)
  - [x] Install `@capacitor/preferences`
  - [x] Migrate LocalStorage to iCloud-backed storage (CloudSaveService)
  - [x] Handle conflict resolution (latest wins)
  - [ ] Test cross-device sync (requires device)
  - [x] Fallback to local if iCloud unavailable

- [x] Share victories (AC: 4)
  - [x] Install `@capacitor/share`
  - [ ] Create shareable victory card image (future enhancement)
  - [x] Include run stats (class, turns, cards played)
  - [x] Share to Messages, Twitter, etc.

### Priority 2: Engagement Features

- [ ] Push notifications (AC: 1)
  - [ ] Install `@capacitor/push-notifications`
  - [ ] Request notification permission
  - [ ] Daily reminder: "Your next run awaits!"
  - [ ] Lapsed player re-engagement
  - [ ] Respect user preferences (easy opt-out)

- [ ] Game Center achievements (AC: 2)
  - [ ] Configure Game Center in Xcode
  - [ ] Define achievements in App Store Connect:
    - First Victory (beat Act 3)
    - Class Master (beat game with each class)
    - Card Collector (unlock 100 cards)
    - etc.
  - [ ] Integrate achievement triggers in game

### Priority 3: Polish Features

- [ ] Handoff support (AC: 5)
  - [ ] Configure NSUserActivity
  - [ ] Enable continuing run on Mac/iPad
  - [ ] Requires iCloud saves working

- [ ] Spotlight indexing (AC: 6)
  - [ ] Index saved runs
  - [ ] Index class information
  - [ ] Enable searching "Sanctum" to launch

- [ ] Siri Shortcuts (AC: 7)
  - [ ] "Start a new run"
  - [ ] "Continue my run"
  - [ ] Configure App Intents

## Dev Notes

### iCloud Save Implementation

```typescript
// Using @capacitor/preferences for basic key-value sync
import { Preferences } from '@capacitor/preferences';

// Preferences automatically sync via iCloud on iOS
await Preferences.set({
  key: 'gameState',
  value: JSON.stringify(gameState)
});

const { value } = await Preferences.get({ key: 'gameState' });
```

For more complex sync, consider:
- CloudKit via native plugin
- Firebase with offline support
- Custom backend with Apple Sign In

### Share Implementation

```typescript
import { Share } from '@capacitor/share';

async shareVictory(runStats: RunStats): Promise<void> {
  await Share.share({
    title: 'Victory in Sanctum Ruins!',
    text: `I beat the ${runStats.boss} with ${runStats.className} in ${runStats.turns} turns!`,
    url: 'https://sanctumruins.com',
    dialogTitle: 'Share your victory'
  });
}
```

### Push Notification Best Practices
- Request permission contextually (not on first launch)
- Explain value before requesting
- Respect "Don't Allow" - don't nag
- Allow easy disable in settings
- Limit to 1-2 notifications per day max

### Game Center Achievement Examples

| Achievement | Description | Points |
|-------------|-------------|--------|
| First Steps | Complete Act 1 | 10 |
| Hollow Victory | Defeat the Hollow God | 50 |
| Cleric Master | Beat the game as Cleric | 25 |
| Knight Master | Beat the game as Knight | 25 |
| Collector | Unlock 100 cards | 30 |
| Speed Runner | Win in under 100 turns | 50 |
| Flawless | Win without taking damage in a combat | 25 |

### Relevant Capacitor Plugins
- `@capacitor/share` - Share sheet
- `@capacitor/preferences` - iCloud-backed storage
- `@capacitor/push-notifications` - Push notifications
- `capacitor-game-connect` - Game Center (community plugin)
- Native Swift for Handoff, Spotlight, Shortcuts

### Relevant Files
- `src/services/CloudSaveService.ts` (new)
- `src/services/ShareService.ts` (new)
- `src/services/PushNotificationService.ts` (new)
- `ios/App/App/AppDelegate.swift` - native integrations

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-04 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

_To be filled by Dev agent_

---

## QA Results

_To be filled by QA agent_
