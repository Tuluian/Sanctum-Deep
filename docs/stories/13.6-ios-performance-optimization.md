# Story 13.6: iOS Performance & Quality Optimization

## Status: In Progress

## Story

**As a** mobile player,
**I want** the game to run smoothly on my iPhone/iPad,
**so that** gameplay is responsive and battery-friendly.

## Acceptance Criteria

1. Consistent 60fps gameplay on iPhone 12 and newer
2. Acceptable 30fps on iPhone 8/SE (minimum supported)
3. Memory usage under 150MB during gameplay
4. App launch time under 3 seconds
5. Battery impact reasonable (no rapid drain during gameplay)
6. No WebView rendering glitches or white flashes
7. Offline play works fully (no network required for gameplay)
8. App works on iOS 15+ (2-3 versions back)

## Tasks / Subtasks

- [ ] Performance profiling (AC: 1, 2)
  - [ ] Profile with Xcode Instruments
  - [ ] Identify rendering bottlenecks
  - [ ] Measure frame times on target devices
  - [ ] Optimize DOM/CSS animations
- [ ] Memory optimization (AC: 3)
  - [ ] Profile memory with Instruments
  - [ ] Lazy load non-critical assets
  - [ ] Clean up unused objects during gameplay
  - [ ] Optimize image sizes for retina displays
- [ ] Launch time optimization (AC: 4)
  - [ ] Measure cold start time
  - [ ] Defer non-critical initialization
  - [ ] Preload critical assets only
  - [ ] Consider splash screen caching
- [ ] Battery optimization (AC: 5)
  - [ ] Reduce unnecessary re-renders
  - [ ] Pause animations when app backgrounded
  - [ ] Use requestAnimationFrame efficiently
  - [ ] Profile GPU usage
- [x] WebView stability (AC: 6)
  - [x] Configure WKWebView properly
  - [x] Set background color to prevent white flash (#1a1a2e in capacitor.config.ts)
  - [x] Handle orientation changes smoothly (CSS safe areas)
  - [ ] Test webview caching
- [x] Offline support (AC: 7)
  - [x] Verify no network calls for gameplay (fully client-side)
  - [x] Cache all assets locally (service worker + Vite build)
  - [ ] Handle offline gracefully (show message for IAP)
  - [ ] Test airplane mode
- [ ] iOS version support (AC: 8)
  - [ ] Set minimum deployment target iOS 15.0
  - [ ] Test on iOS 15, 16, 17, 18
  - [ ] Handle deprecated APIs

## Dev Notes

### Target Devices

**Tier 1 (60fps required)**
- iPhone 12, 13, 14, 15 series
- iPad Pro (all generations)
- iPad Air (4th gen+)

**Tier 2 (30fps acceptable)**
- iPhone 8, X, XR, 11
- iPhone SE (2nd, 3rd gen)
- iPad (8th, 9th, 10th gen)

**Not Supported**
- iPhone 7 and earlier
- iPad 5th gen and earlier
- Requires iOS 15+

### Performance Checklist

```typescript
// Avoid in hot paths
- DOM queries in render loops
- Large object cloning
- Synchronous layout thrashing
- Excessive event listeners

// Prefer
- RAF for animations
- CSS transforms over layout changes
- Event delegation
- Object pooling for particles
```

### WKWebView Configuration

```swift
// In AppDelegate.swift or ViewController
let config = WKWebViewConfiguration()
config.preferences.javaScriptEnabled = true
config.allowsInlineMediaPlayback = true

// Prevent white flash
webView.isOpaque = false
webView.backgroundColor = UIColor.black
webView.scrollView.backgroundColor = UIColor.black
```

### Memory Budget
- **Total app memory**: < 150MB
- **Images**: Optimize with WebP, lazy load
- **Audio**: Compress, stream large files
- **State**: Minimize object retention

### Launch Time Targets
| Metric | Target |
|--------|--------|
| Cold start | < 3s |
| Warm start | < 1s |
| Time to interactive | < 4s |

### Battery Testing
- Play for 30 minutes, note battery drain
- Compare to similar games
- Target: < 10% drain per 30 min session
- Monitor with Xcode Energy Log

### Capacitor Performance Tips
- Use `Capacitor.isNativePlatform()` for platform checks
- Avoid excessive bridge calls
- Batch native plugin calls when possible
- Use HTTP caching for assets

### Testing Matrix

| Device | iOS | Target FPS | Status |
|--------|-----|------------|--------|
| iPhone 15 Pro | 17 | 60 | |
| iPhone 13 | 17 | 60 | |
| iPhone 12 | 16 | 60 | |
| iPhone SE 3 | 17 | 30 | |
| iPhone 8 | 16 | 30 | |
| iPad Pro 12.9 | 17 | 60 | |
| iPad 10th | 16 | 60 | |

### Relevant Files
- `src/main.ts` - initialization optimization
- `src/ui/renderer.ts` - render performance
- `capacitor.config.ts` - webview settings
- `ios/App/App/` - native configuration

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-04 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

_To be filled by Dev agent_

---

## QA Results

_To be filled by QA agent_
