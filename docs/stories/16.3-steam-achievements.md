# Story 16.3: Steam Achievements

## Status: Draft

## Story

**As a** player on Steam,
**I want** achievements to unlock and display on my Steam profile,
**so that** I can showcase my progress and accomplishments.

## Acceptance Criteria

1. Achievement definitions created in Steamworks
2. Achievements sync with existing game achievement system
3. Achievements unlock correctly during gameplay
4. Achievement popup appears via Steam overlay
5. Achievements persist across sessions
6. Achievement progress tracked for multi-step achievements
7. Offline achievements sync when Steam reconnects

## Tasks / Subtasks

- [ ] Define achievements in Steamworks (AC: 1)
  - [ ] Log into Steamworks partner dashboard
  - [ ] Create achievement definitions matching game
  - [ ] Upload achievement icons (64x64 locked, 64x64 unlocked)
  - [ ] Set achievement display names and descriptions
- [ ] Map game achievements to Steam (AC: 2)
  - [ ] Create mapping between game achievement IDs and Steam IDs
  - [ ] Ensure all existing achievements have Steam equivalents
- [ ] Implement unlock calls (AC: 3, 4)
  - [ ] Add Steam unlock to AchievementService
  - [ ] Call Steam API when achievement unlocks
  - [ ] Handle unlock failure gracefully
- [ ] Implement progress tracking (AC: 6)
  - [ ] Identify achievements with progress (kill X enemies, etc.)
  - [ ] Call setAchievement progress API
  - [ ] Update progress during gameplay
- [ ] Handle persistence and offline (AC: 5, 7)
  - [ ] Steam handles persistence automatically
  - [ ] Queue unlocks if Steam offline
  - [ ] Sync when Steam reconnects

## Dev Notes

### Achievement Mapping

Create mapping file:
```typescript
// src/data/steamAchievements.ts
export const STEAM_ACHIEVEMENT_MAP: Record<string, string> = {
  // Game Achievement ID -> Steam Achievement API Name
  'first_victory': 'ACH_FIRST_WIN',
  'defeat_hollow_god': 'ACH_BEAT_BOSS',
  'unlock_all_classes': 'ACH_ALL_CLASSES',
  'complete_act1': 'ACH_ACT1',
  'complete_act2': 'ACH_ACT2',
  'complete_act3': 'ACH_ACT3',
  'deal_100_damage': 'ACH_DAMAGE_100',
  'play_100_cards': 'ACH_CARDS_100',
  // ... map all achievements
};
```

### Steam Achievement Service

```typescript
// src/services/SteamAchievementService.ts
import { STEAM_ACHIEVEMENT_MAP } from '../data/steamAchievements';

class SteamAchievementService {
  private steamAvailable = false;

  constructor() {
    // Check if Steam API is available (from preload)
    this.steamAvailable = typeof window.steam !== 'undefined';
  }

  async unlock(gameAchievementId: string): Promise<boolean> {
    if (!this.steamAvailable) return false;

    const steamId = STEAM_ACHIEVEMENT_MAP[gameAchievementId];
    if (!steamId) {
      console.warn(`No Steam mapping for achievement: ${gameAchievementId}`);
      return false;
    }

    try {
      await window.steam.unlockAchievement(steamId);
      console.log(`Steam achievement unlocked: ${steamId}`);
      return true;
    } catch (error) {
      console.error(`Failed to unlock Steam achievement: ${steamId}`, error);
      return false;
    }
  }

  async setProgress(gameAchievementId: string, current: number, max: number): Promise<void> {
    if (!this.steamAvailable) return;

    const steamId = STEAM_ACHIEVEMENT_MAP[gameAchievementId];
    if (!steamId) return;

    try {
      await window.steam.setAchievementProgress(steamId, current, max);
    } catch (error) {
      console.error(`Failed to set achievement progress: ${steamId}`, error);
    }
  }
}

export const steamAchievements = new SteamAchievementService();
```

### Integration with Existing AchievementService

```typescript
// src/services/AchievementService.ts
import { steamAchievements } from './SteamAchievementService';

class AchievementService {
  // ... existing code

  unlock(achievementId: string): void {
    // Existing unlock logic
    if (this.isUnlocked(achievementId)) return;

    this.unlockedAchievements.add(achievementId);
    this.save();
    this.showNotification(achievementId);

    // NEW: Also unlock on Steam
    steamAchievements.unlock(achievementId);
  }

  updateProgress(achievementId: string, current: number, max: number): void {
    // Existing progress logic
    // ...

    // NEW: Also update Steam progress
    steamAchievements.setProgress(achievementId, current, max);
  }
}
```

### Electron IPC Handlers

```javascript
// electron/main.js
const { ipcMain } = require('electron');
const steamworks = require('steamworks.js');

ipcMain.handle('steam-unlock-achievement', async (event, achievementId) => {
  try {
    steamworks.achievement.activate(achievementId);
    return true;
  } catch (error) {
    console.error('Steam achievement unlock failed:', error);
    return false;
  }
});

ipcMain.handle('steam-set-achievement-progress', async (event, achievementId, current, max) => {
  try {
    steamworks.achievement.indicate(achievementId, current, max);
    return true;
  } catch (error) {
    console.error('Steam achievement progress failed:', error);
    return false;
  }
});

ipcMain.handle('steam-get-achievements', async () => {
  try {
    return steamworks.achievement.getAll();
  } catch (error) {
    console.error('Failed to get Steam achievements:', error);
    return [];
  }
});
```

### Steamworks Achievement Setup

In Steamworks dashboard:
1. Go to App Admin â†’ Stats & Achievements
2. Click "New Achievement"
3. Fill in:
   - API Name: `ACH_FIRST_WIN` (matches code)
   - Display Name: "First Victory"
   - Description: "Win your first run"
   - Hidden: No (or Yes for secret achievements)
4. Upload icons:
   - Unlocked: 64x64 PNG, full color
   - Locked: 64x64 PNG, grayscale recommended

### Achievement Icon Specifications

| Type | Size | Format | Notes |
|------|------|--------|-------|
| Unlocked | 64x64 | PNG/JPG | Full color, celebratory |
| Locked | 64x64 | PNG/JPG | Grayscale or silhouette |

### Offline Queue (Optional Enhancement)

```typescript
// Queue achievements if Steam offline
class OfflineAchievementQueue {
  private queue: string[] = [];

  add(achievementId: string): void {
    if (!this.queue.includes(achievementId)) {
      this.queue.push(achievementId);
      localStorage.setItem('steamAchievementQueue', JSON.stringify(this.queue));
    }
  }

  async flush(): Promise<void> {
    const queued = [...this.queue];
    for (const id of queued) {
      const success = await steamAchievements.unlock(id);
      if (success) {
        this.queue = this.queue.filter(q => q !== id);
      }
    }
    localStorage.setItem('steamAchievementQueue', JSON.stringify(this.queue));
  }
}
```

### Relevant Files
- `src/data/steamAchievements.ts` (new)
- `src/services/SteamAchievementService.ts` (new)
- `src/services/AchievementService.ts` (modify)
- `electron/main.js` (add IPC handlers)
- `electron/preload.js` (add Steam methods)

## Testing

- Test file location: `src/services/SteamAchievementService.test.ts`
- Manual verification:
  - Unlock achievement in game, verify Steam popup
  - Check Steam profile for unlocked achievement
  - Test offline unlock, verify syncs later

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-05 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

_To be filled by Dev agent_

---

## QA Results

_To be filled by QA agent_
