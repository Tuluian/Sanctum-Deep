# Story 2.3: Act 1 Elite Enemies

## Status: Done

## Story

**As a** player seeking greater challenges and rewards,
**I want** elite enemies with unique mechanics and phases,
**so that** elite fights feel special and rewarding.

---

## Narrative Context: The Named Fallen

> *"The common dead forgot their names. The elites remember—and that memory is their prison."*

### Elite Design Philosophy

Elite enemies are **named characters** with backstories. Before combat, players see:
- Their name
- When they entered the Sanctum
- A single sentence about who they were

This transforms "hard enemy" into "tragic figure." Killing them feels like release, not conquest.

### Pre-Combat Display Format
```
╔════════════════════════════════════════╗
║  VARRIC, THE UNBURIED                  ║
║  Entered 47 years ago                  ║
║  "Came to prove he was worthy of his   ║
║   family name. Found only darkness."   ║
╚════════════════════════════════════════╝
```

---

## Acceptance Criteria

1. Act 1 has 2 elite enemy types: Tomb Guardian and High Cultist
2. Elite enemies have significantly more HP than commons (80-100 HP)
3. Elite enemies have 2 phases or special mechanics
4. Elite enemies telegraph intents but are more dangerous
5. Elite combat rewards are better than common combat
6. Elite enemies can apply unique status effects
7. **NEW: Each elite has a name, entry date, and backstory**
8. **NEW: Elite death triggers unique dialogue/lore reveal**

## Tasks / Subtasks

- [x] Design Tomb Guardian elite (AC: 1, 2, 3)
  - [x] **Tomb Guardian** (90 HP)
    - Phase 1 (HP > 50%): Defensive patterns
      - Stone Gaze (Apply Impaired 2 turns, 30%)
      - Shield Wall (Gain 15 block, 40%)
      - Crushing Blow (Attack 12, 30%)
    - Phase 2 (HP <= 50%): Aggressive patterns
      - Enraged Strike (Attack 18, 50%)
      - Ground Slam (Attack 10 to player, 8 to all enemies if multi, 30%)
      - Desperate Guard (Gain 8 block, Attack 8, 20%)
  - [x] Implement phase transition logic
  - [ ] Visual indicator for phase change - Deferred to UI Epic

- [x] Design High Cultist elite (AC: 1, 2, 3)
  - [x] **High Cultist** (80 HP)
    - Summons minions mechanic
      - Dark Ritual (Summon 2 Acolytes at 15 HP each, 25%)
      - Void Bolt (Attack 14, 35%)
      - Mass Hex (Apply Sundered to player, 20%)
      - Blood Shield (Gain 10 block, Heal 5, 20%)
    - Special: Can only summon once per combat
  - [x] Implement summon mechanic
  - [x] Summoned enemies act immediately next turn

- [x] Implement elite-specific mechanics
  - [x] Phase system for enemies (track phase, trigger transitions)
  - [x] Summon mechanic (add enemies mid-combat)
  - [x] Once-per-combat ability tracking
  - [ ] Sundered status effect (take 50% more damage) - Deferred to status effects epic

- [x] Update CombatEngine for elite mechanics
  - [x] Add `phase` property to Enemy state
  - [x] Add `usedAbilities` tracking for once-per-combat
  - [x] `addEnemy(definition)` method for summoning
  - [x] Phase transition events for UI

- [ ] Update UI for elite enemies - Deferred to UI Epic
  - [ ] Elite enemy name styling (gold border or icon)
  - [ ] Phase indicator (Phase 1 / Phase 2)
  - [ ] Summon animation/indicator
  - [ ] Sundered status icon

- [ ] Implement elite combat rewards - Deferred to Reward System Epic
  - [ ] Bonus gold (2x normal combat)
  - [ ] Guaranteed rare card option
  - [ ] Higher potion drop rate (50%)

- [x] Write unit tests
  - [x] Test Tomb Guardian phase transition at 50% HP
  - [x] Test phase 2 moves are selected after transition
  - [x] Test High Cultist summons Acolytes
  - [x] Test summon only works once
  - [ ] Test Sundered increases damage taken by 50% - Deferred with status effect

## Dev Notes

### Elite Design Philosophy

Elites should:
- Feel like mini-bosses
- Require strategy, not just DPS race
- Reward players with better loot
- Introduce mechanics used by later bosses
- Be completable by both free classes
- **Feel like someone you wish you could have saved**

---

## Elite Roster: The Named Fallen

### 1. Varric, the Unburied (Tomb Guardian)
**HP:** 90 | **2 Phases**

**Entry Date:** 47 years ago

**Who He Was:** Youngest son of House Korrath, a noble family that prized martial glory. His elder brothers all entered the Sanctum seeking honor—none returned. Varric came to prove he was worthy of his family name and to retrieve his brothers' remains.

He found them. They found him too.

**Pre-Combat Text:** *"Came to prove he was worthy of his family name. Found only darkness."*

**Phase 1 Behavior (HP > 50%):** Defensive, methodical. He's still trying to protect something.
- Stone Gaze: *"Don't look at me. I don't want you to see what I've become."*
- Shield Wall: *"The wall holds. The wall always holds."*
- Crushing Blow: *"I learned this from my eldest brother."*

**Phase 2 Behavior (HP ≤ 50%):** Aggressive, desperate. The guardian crumbles.
- Enraged Strike: *"WHY WON'T YOU STAY DOWN?"*
- Ground Slam: *"Everyone falls. Everyone."*
- Desperate Guard: *"Not yet. Not yet. NOT YET."*

**Death Dialogue:**
*"My brothers... tell them I tried. Tell them..."*
*[A pause. Recognition fades.]*
*"...who were they again?"*

**Warden Comment (post-combat):** *"Varric was the last of House Korrath. The family name dies with him. Perhaps that's a mercy."*

---

### 2. High Cultist Mira
**HP:** 80 | **Summons Acolytes**

**Entry Date:** 12 years ago

**Who She Was:** A healer in the village of Thornwood. When plague took her daughter, Mira entered the Sanctum seeking resurrection—anything to bring her child back. The Hollow God made her an offer: serve, and the pain ends. She serves.

She doesn't remember why anymore.

**Pre-Combat Text:** *"Was a healer. Her child died. Entered seeking resurrection. Found only service."*

**Combat Behavior:**
- Dark Ritual (Summon Acolytes): *"Come, children. Mother calls."*
- Void Bolt: *"This doesn't hurt. Nothing hurts anymore."*
- Mass Hex: *"Let me share this gift. The emptiness. It's peaceful."*
- Blood Shield: *"The void protects its own."*

**When Summoning:** The Acolytes she summons are **not random**. They're modeled after her daughter. Their death quote: *"Mama?"*

**Death Dialogue:**
*"I just wanted... I just wanted her back..."*
*[The emptiness fades from her eyes. Terror returns.]*
*"Oh gods. What have I done? What have I—"*
*[Silence.]*

**Warden Comment (post-combat):** *"Mira's daughter died of plague. The village survived because of Mira's healing. She saved everyone except the one who mattered most to her."*

---

## Class-Specific Interactions

### Cleric vs. High Cultist Mira
Before combat, additional text appears:
*"She was a healer once. Like you. Her faith wasn't enough to save her child."*

Mira's dialogue during combat:
- On player heal: *"That won't save them. Nothing saves them."*
- On low HP: *"Do you know what it's like? To have the power to heal and still lose them?"*

### Dungeon Knight vs. Varric
Before combat, additional text:
*"He wears the crest of House Korrath—allies of the Order of the Sealed Gate."*

Varric's dialogue during combat:
- On combat start: *"That armor... do I know you? No. I don't know anyone anymore."*
- On dealing damage: *"The Order trained us the same. I can see it in your stance."*

---

### Phase System

```typescript
interface Enemy {
  // ... existing fields
  phase: number;
  phaseThresholds?: number[]; // HP percentages that trigger phase changes
  usedAbilities: Set<string>; // Track once-per-combat abilities
}

// Phase transition
function checkPhaseTransition(enemy: Enemy): void {
  if (!enemy.phaseThresholds) return;

  const hpPercent = enemy.currentHp / enemy.maxHp;
  const nextPhase = enemy.phaseThresholds.findIndex(t => hpPercent <= t);

  if (nextPhase > enemy.phase) {
    enemy.phase = nextPhase;
    emit('ENEMY_PHASE_CHANGED', { enemyId: enemy.id, phase: nextPhase });
  }
}
```

### Elite Definitions

```typescript
const TOMB_GUARDIAN: EnemyDefinition = {
  id: 'tomb_guardian',
  name: 'Tomb Guardian',
  maxHp: 90,
  isElite: true,
  phaseThresholds: [0.5], // Phase 2 at 50% HP
  phases: [
    { // Phase 1
      moves: [
        { id: 'stone_gaze', name: 'Stone Gaze', intent: IntentType.DEBUFF, status: 'IMPAIRED', duration: 2, weight: 30 },
        { id: 'shield_wall', name: 'Shield Wall', intent: IntentType.DEFEND, block: 15, weight: 40 },
        { id: 'crushing_blow', name: 'Crushing Blow', intent: IntentType.ATTACK, damage: 12, weight: 30 },
      ]
    },
    { // Phase 2
      moves: [
        { id: 'enraged_strike', name: 'Enraged Strike', intent: IntentType.ATTACK, damage: 18, weight: 50 },
        { id: 'ground_slam', name: 'Ground Slam', intent: IntentType.ATTACK, damage: 10, weight: 30 },
        { id: 'desperate_guard', name: 'Desperate Guard', intent: IntentType.ATTACK, damage: 8, block: 8, weight: 20 },
      ]
    }
  ]
};

const HIGH_CULTIST: EnemyDefinition = {
  id: 'high_cultist',
  name: 'High Cultist',
  maxHp: 80,
  isElite: true,
  moves: [
    { id: 'dark_ritual', name: 'Dark Ritual', intent: IntentType.SUMMON, summons: ['acolyte', 'acolyte'], oncePerCombat: true, weight: 25 },
    { id: 'void_bolt', name: 'Void Bolt', intent: IntentType.ATTACK, damage: 14, weight: 35 },
    { id: 'mass_hex', name: 'Mass Hex', intent: IntentType.DEBUFF, status: 'SUNDERED', duration: 2, weight: 20 },
    { id: 'blood_shield', name: 'Blood Shield', intent: IntentType.DEFEND, block: 10, heal: 5, weight: 20 },
  ]
};
```

### Status Effect: Sundered

```typescript
// 50% more damage taken
function calculateDamage(baseDamage: number, target: Entity): number {
  let damage = baseDamage;

  if (hasStatus(target, 'SUNDERED')) {
    damage = Math.floor(damage * 1.5);
  }

  return damage;
}
```

## Testing

### Test File Location
`src/tests/enemies/EliteEnemies.test.ts`

### Key Test Scenarios

1. **Tomb Guardian Phase 1**: Uses defensive moves above 50% HP
2. **Tomb Guardian Phase 2**: Switches to aggressive moves at 50% HP
3. **High Cultist Summon**: Dark Ritual adds 2 Acolytes to combat
4. **Once Per Combat**: Dark Ritual cannot be used twice
5. **Sundered Effect**: Player takes 50% more damage when Sundered
6. **Elite Rewards**: Elite combat gives 2x gold

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-03 | 1.0 | Initial story creation | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- Fixed once-per-combat tracking: needed to use move.id instead of intent.name
- Added moveId property to EnemyIntent for proper ability tracking

### Completion Notes List
- Created 2 elite enemies: Tomb Guardian (90 HP, 2 phases) and High Cultist (80 HP, summoner)
- Implemented phase system with automatic transitions at HP thresholds
- Implemented summon mechanic with addEnemy() method
- Added once-per-combat ability tracking with usedAbilities array
- Extended EnemyDefinition with isElite, phaseThresholds, and phases properties
- Extended Enemy with isElite, phase, and usedAbilities properties
- Added ENEMY_PHASE_CHANGED and ENEMY_SUMMONED event types
- Added SUMMON intent type
- 18 elite-specific tests passing
- Total: 132 tests passing
- UI elements and Sundered status effect deferred to respective epics

### File List
- `src/types/index.ts` (modified) - Added SUMMON IntentType, EnemyPhase interface, elite properties
- `src/data/enemies/elites.ts` (created) - Elite enemy definitions
- `src/engine/CombatEngine.ts` (modified) - Phase transitions, summon handling, addEnemy method
- `src/data/enemies/elites.test.ts` (created) - 18 tests for elite enemies

---

## QA Results
_To be filled by QA agent_
