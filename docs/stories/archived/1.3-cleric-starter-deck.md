# Story 1.3: Cleric Starter Deck & Devotion Mechanic

## Status: Done

## Story

**As a** player choosing the Cleric class,
**I want** a unique starter deck with healing-focused cards and a Devotion mechanic,
**so that** I can experience the Cleric's attrition warfare playstyle.

## Acceptance Criteria

1. Cleric starts with: 4x Smite (1 Resolve, Deal 5 damage), 4x Shield of Faith (1 Resolve, Gain 5 block), 1x Prayer of Mending (1 Resolve, Heal 6 HP), 1x Consecrate (1 Resolve, Deal 3 damage, Heal 3 HP)
2. Cleric starts with 75 max HP
3. Cleric starts with 3 max Resolve per turn
4. Healing the player generates 1 Devotion token per heal effect (not per HP)
5. Devotion persists across turns within combat
6. Devotion counter is visible in the UI
7. Devotion resets to 0 at start of new combat
8. Cards that heal when at full HP still trigger Devotion gain

## Tasks / Subtasks

- [x] Create Cleric class configuration (AC: 2, 3)
  - [x] Define `CharacterClass` interface with id, name, maxHp, maxResolve, starterDeck
  - [x] Create `CLERIC` class configuration with 75 HP, 3 Resolve
  - [x] Export class configs for future class additions

- [x] Implement Cleric starter deck cards (AC: 1)
  - [x] Define Smite card: { id: 'smite', name: 'Smite', type: ATTACK, cost: 1, effects: [{ type: DAMAGE, amount: 5 }] }
  - [x] Define Shield of Faith card: { id: 'shield_of_faith', name: 'Shield of Faith', type: SKILL, cost: 1, effects: [{ type: BLOCK, amount: 5 }] }
  - [x] Define Prayer of Mending card: { id: 'prayer_of_mending', name: 'Prayer of Mending', type: SKILL, cost: 1, effects: [{ type: HEAL, amount: 6 }] }
  - [x] Define Consecrate card: { id: 'consecrate', name: 'Consecrate', type: ATTACK, cost: 1, effects: [{ type: DAMAGE, amount: 3 }, { type: HEAL, amount: 3 }] }

- [x] Create starter deck factory (AC: 1)
  - [x] `createStarterDeck(classId)` - returns array of card instances
  - [x] Generate unique instanceId for each card copy (e.g., 'smite_0', 'smite_1')
  - [x] Cleric deck: 4x Smite, 4x Shield of Faith, 1x Prayer of Mending, 1x Consecrate (10 cards total)

- [x] Implement Devotion mechanic (AC: 4, 5, 7, 8)
  - [x] Add `devotion` property to PlayerState (initialize to 0)
  - [x] Modify heal effect to trigger Devotion gain
  - [x] `gainDevotion(amount)` - adds to player's Devotion counter
  - [x] Devotion gained per HEAL effect, not per HP restored
  - [x] Healing at full HP (0 HP restored) still gains Devotion
  - [x] `resetDevotion()` called at combat start

- [x] Integrate Devotion with combat events (AC: 5, 6)
  - [x] Emit DEVOTION_CHANGED event when Devotion changes
  - [x] Devotion persists through entire combat (no decay)
  - [x] Include devotion in combat state for UI access

- [x] Write unit tests for Cleric class
  - [x] Test Cleric starts with 75 HP
  - [x] Test Cleric starts with 3 max Resolve
  - [x] Test starter deck contains exactly 10 cards
  - [x] Test starter deck has correct card distribution
  - [x] Test Smite deals 5 damage
  - [x] Test Shield of Faith grants 5 block
  - [x] Test Prayer of Mending heals 6 and gains 1 Devotion
  - [x] Test Consecrate deals 3 damage AND heals 3 AND gains 1 Devotion
  - [x] Test healing at full HP still gains Devotion
  - [x] Test Devotion persists across turns
  - [x] Test Devotion resets on new combat

## Dev Notes

### Card Definitions (from IDEAS.txt)

```typescript
// Cleric Starter Cards
const CLERIC_CARDS = {
  smite: {
    id: 'smite',
    name: 'Smite',
    type: CardType.ATTACK,
    cost: 1,
    description: 'Deal 5 damage.',
    effects: [{ type: EffectType.DAMAGE, amount: 5 }]
  },
  shieldOfFaith: {
    id: 'shield_of_faith',
    name: 'Shield of Faith',
    type: CardType.SKILL,
    cost: 1,
    description: 'Gain 5 block.',
    effects: [{ type: EffectType.BLOCK, amount: 5 }]
  },
  prayerOfMending: {
    id: 'prayer_of_mending',
    name: 'Prayer of Mending',
    type: CardType.SKILL,
    cost: 1,
    description: 'Heal 6 HP.',
    effects: [{ type: EffectType.HEAL, amount: 6 }]
  },
  consecrate: {
    id: 'consecrate',
    name: 'Consecrate',
    type: CardType.ATTACK,
    cost: 1,
    description: 'Deal 3 damage. Heal 3 HP.',
    effects: [
      { type: EffectType.DAMAGE, amount: 3 },
      { type: EffectType.HEAL, amount: 3 }
    ]
  }
};
```

### Devotion Mechanic Details (from IDEAS.txt)

> **Core mechanic: Devotion** - healing yourself generates Devotion tokens. Spend tokens to empower cards or trigger bonus effects.

For MVP/Phase 1:
- Devotion is tracked but not yet spendable
- Future cards will have "Spend X Devotion: bonus effect" patterns
- Example future card: "Smite the Wicked" (2 Resolve): Deal 8 damage. Spend 3 Devotion: Deal 16 instead.

**Important Implementation Detail**: Devotion triggers per heal EFFECT, not per HP healed. This means:
- Prayer of Mending (heal 6) = 1 Devotion
- Consecrate (heal 3) = 1 Devotion
- Future "heal 2 HP three times" card = 3 Devotion

### Character Class Structure

```typescript
interface CharacterClass {
  id: string;
  name: string;
  maxHp: number;
  maxResolve: number;
  classMechanic: string;  // 'devotion', 'fortify', etc.
  starterDeckRecipe: { cardId: string; count: number }[];
}

const CLERIC: CharacterClass = {
  id: 'cleric',
  name: 'The Cleric',
  maxHp: 75,
  maxResolve: 3,
  classMechanic: 'devotion',
  starterDeckRecipe: [
    { cardId: 'smite', count: 4 },
    { cardId: 'shield_of_faith', count: 4 },
    { cardId: 'prayer_of_mending', count: 1 },
    { cardId: 'consecrate', count: 1 }
  ]
};
```

### File Structure

```
src/
  classes/
    types.ts           - CharacterClass interface
    Cleric.ts          - Cleric class definition
    index.ts           - Export all classes
  cards/
    CardDatabase.ts    - All card definitions
    ClericCards.ts     - Cleric-specific cards
    DeckFactory.ts     - Create decks from recipes
  combat/
    CombatEngine.ts    - Add devotion handling to heal effects
  tests/
    classes/
      Cleric.test.ts
```

### Integration with Story 1.2

Modify the heal effect execution to trigger Devotion:

```typescript
function executeHealEffect(amount: number): void {
  const actualHeal = Math.min(amount, player.maxHp - player.hp);
  player.hp += actualHeal;

  // Devotion triggers even if no HP was restored
  if (player.classMechanic === 'devotion') {
    player.devotion += 1;
    emit('DEVOTION_CHANGED', player.devotion);
  }
}
```

## Testing

### Test File Location
`src/tests/classes/Cleric.test.ts`

### Key Test Scenarios

1. **Class Stats**: Cleric has 75 HP and 3 Resolve
2. **Deck Composition**: Starter deck has exactly 4 Smite, 4 Shield, 1 Prayer, 1 Consecrate
3. **Card Effects**: Each card does what its description says
4. **Devotion on Heal**: Healing effect triggers +1 Devotion
5. **Devotion at Full HP**: Healing at 75/75 HP still gains Devotion
6. **Multi-Effect Devotion**: Consecrate's heal effect triggers Devotion
7. **Devotion Persistence**: Devotion stays same value across multiple turns
8. **Devotion Reset**: New combat starts with 0 Devotion

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-03 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
claude-opus-4-5-20251101

### Debug Log References
N/A

### Completion Notes List
- Cleric class config in `src/data/classes.ts`
- Cleric cards in `src/data/cards/cleric.ts`
- Deck factory `createStarterDeck()` in classes.ts
- Devotion triggers on HEAL effect in CombatEngine
- PLAYER_DEVOTION_CHANGED event emitted
- Unit tests in `src/data/classes.test.ts` and `src/engine/CombatEngine.test.ts`
- All acceptance criteria verified with 24 class tests + 6 Devotion integration tests

### File List
- src/types/index.ts (CharacterClass, CharacterClassId)
- src/data/classes.ts (created)
- src/data/classes.test.ts (created)
- src/data/cards/cleric.ts (created)
- src/data/cards/index.ts (created)
- src/engine/CombatEngine.ts (modified for Devotion)
- src/engine/CombatEngine.test.ts (Devotion tests)

---

## QA Results
_To be filled by QA agent_
