# Story 1.1: Combat State Machine

## Status: Done

## Story

**As a** player,
**I want** combat to flow through clear turn-based phases,
**so that** I understand when I can act and what happens each turn.

## Acceptance Criteria

1. Combat initializes with player and enemy state from provided configuration
2. Turn structure follows: Draw Phase → Player Phase → End Turn → Enemy Phase → Cleanup Phase
3. Player can only act during Player Phase
4. Combat ends when player HP reaches 0 (defeat) or all enemies HP reach 0 (victory)
5. Resolve refills to maximum at start of each player turn
6. Block resets to 0 at start of each player turn (before enemy attacks are resolved)
7. State changes are tracked and can trigger UI updates

## Tasks / Subtasks

- [x] Create combat state types and interfaces (AC: 1, 7)
  - [x] Define `CombatState` interface with player, enemies, turn, phase
  - [x] Define `CombatPhase` enum: DRAW, PLAYER_ACTION, END_TURN, ENEMY_ACTION, CLEANUP, VICTORY, DEFEAT
  - [x] Define `PlayerState` interface with hp, maxHp, block, resolve, maxResolve, hand, drawPile, discardPile
  - [x] Define `EnemyState` interface with id, name, hp, maxHp, block, intent

- [x] Implement CombatEngine class (AC: 1, 2, 3)
  - [x] Constructor accepts initial player config and enemy configs
  - [x] `initializeCombat()` method sets up initial state
  - [x] `getCurrentPhase()` returns current combat phase
  - [x] `canPlayerAct()` returns true only during PLAYER_ACTION phase

- [x] Implement turn phase transitions (AC: 2, 5, 6)
  - [x] `startTurn()` - refill Resolve, reset block, transition to DRAW phase
  - [x] `drawPhase()` - draw cards (placeholder for Story 1.2), transition to PLAYER_ACTION
  - [x] `endTurn()` - player ends turn, transition to END_TURN then ENEMY_ACTION
  - [x] `enemyPhase()` - enemies act (placeholder for Story 1.4), transition to CLEANUP
  - [x] `cleanupPhase()` - check win/lose, prepare next turn or end combat

- [x] Implement win/lose detection (AC: 4)
  - [x] `checkVictory()` - returns true if all enemies have 0 or less HP
  - [x] `checkDefeat()` - returns true if player has 0 or less HP
  - [x] Transition to VICTORY or DEFEAT phase when conditions met
  - [x] `isGameOver()` returns true if in VICTORY or DEFEAT phase

- [x] Implement state change notification system (AC: 7)
  - [x] Create `StateChangeEvent` type for tracking what changed
  - [x] `subscribe(callback)` method for UI to listen to state changes
  - [x] Emit events when state changes: HP_CHANGED, BLOCK_CHANGED, PHASE_CHANGED, etc.
  - [x] `getState()` returns immutable copy of current combat state

- [x] Write unit tests for combat state machine
  - [x] Test combat initialization with valid config
  - [x] Test phase transitions follow correct order
  - [x] Test Resolve refills at turn start
  - [x] Test block resets at turn start
  - [x] Test victory detection when all enemies dead
  - [x] Test defeat detection when player HP <= 0

## Dev Notes

### State Schema (from IDEAS.txt)

```typescript
// Core combat state structure
interface CombatState {
  turn: number;
  phase: CombatPhase;
  player: PlayerState;
  enemies: EnemyState[];
}

interface PlayerState {
  hp: number;
  maxHp: number;
  block: number;
  resolve: number;
  maxResolve: number;
  hand: Card[];
  drawPile: Card[];
  discardPile: Card[];
  exhaustPile: Card[];
  devotion: number; // Cleric-specific, but include for all
}

interface EnemyState {
  id: string;
  name: string;
  hp: number;
  maxHp: number;
  block: number;
  intent: EnemyIntent | null;
}
```

### Turn Flow (from IDEAS.txt)

1. Draw hand (5 cards base)
2. Player plays cards (using Resolve)
3. Player ends turn
4. Enemy executes intent
5. Resolve refills, new turn begins

**Important**: Block resets AFTER enemies attack, not before. This means:
- Turn N ends → Enemies attack (damage reduced by block) → Block resets → Turn N+1 starts

### Existing Prototype Reference

The `sanctum-deep-mobile.html` file has a working `CombatEngine` class that can be referenced for the basic flow, but needs to be refactored into proper TypeScript with better state management.

Key methods in prototype:
- `startCombat()` - shuffles deck, sets intents, draws cards
- `endTurn()` - handles enemy actions, resets block, starts new turn
- `playCard()` - card playing logic (Story 1.2)

### File Structure Recommendation

```
src/
  combat/
    types.ts         - All combat-related types/interfaces
    CombatEngine.ts  - Main combat state machine
    events.ts        - State change event system
  tests/
    combat/
      CombatEngine.test.ts
```

## Testing

### Test File Location
`src/tests/combat/CombatEngine.test.ts`

### Testing Framework
Jest or Vitest (to be determined by architecture)

### Key Test Scenarios

1. **Initialization**: Combat starts with correct player/enemy stats
2. **Phase Flow**: Phases transition in correct order
3. **Turn Mechanics**: Resolve refills, block resets at correct times
4. **Victory Condition**: Combat ends when all enemies at 0 HP
5. **Defeat Condition**: Combat ends when player at 0 HP
6. **State Immutability**: `getState()` returns copy, not reference

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-03 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
claude-opus-4-5-20251101

### Debug Log References
N/A

### Completion Notes List
- Types implemented in `src/types/index.ts`
- CombatEngine implemented in `src/engine/CombatEngine.ts`
- Event system uses observer pattern with subscribe/emit
- Unit tests written in `src/engine/CombatEngine.test.ts`
- All acceptance criteria verified with 45+ passing tests

### File List
- src/types/index.ts (created)
- src/engine/CombatEngine.ts (created)
- src/engine/CombatEngine.test.ts (created)

---

## QA Results
_To be filled by QA agent_
