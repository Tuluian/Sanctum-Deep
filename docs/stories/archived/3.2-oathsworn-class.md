# Story 3.2: The Oathsworn Class & Vows Mechanic

## Status: Ready for Review

## Story

**As a** player who purchases the Oathsworn DLC,
**I want** a unique class with powerful commitment-based mechanics,
**so that** I can experience a playstyle focused on strategic vows and combo chains.

---

## Narrative Context

> *"The Order of the Burning Truth taught me that the Warden system is a prison for the innocent, that the cycle of sacrifice must end. I swore to destroy this place. I didn't swear to understand it first. Perhaps I should have."*

**True Name:** Sister Callista of the Burning Truth (suggested default, customizable)

### Why They Entered
The Order of the Burning Truth believes the Warden system is corrupt. For millennia, the Sanctum has consumed heroes—trapping them in eternal service, stripping their identities, forcing them to guard a prison they never chose. The Order asks: Why should anyone sacrifice themselves eternally? Why maintain this horror-prison when it could be destroyed?

Sister Callista trained her entire life for one mission: enter the Sanctum, reach the Hollow God's prison, and break the seal. Free everyone—the consumed, the Wardens, even the Hollow God itself. Let whatever happens, happen. Anything is better than this eternal suffering.

### What She Doesn't Know
Without the Warden, the Hollow God escapes. The "prison" isn't cruelty—it's necessity. The Hollow God doesn't just consume identity; it spreads. Unchained, it would unmake the world, turning every conscious being into more of itself. The Wardens don't guard the dungeon. They guard reality.

The Order of the Burning Truth is wrong. They mean well. But they would end the world trying to save it.

### What She Learns
The Drowned King didn't suffer because the system is evil—he suffered because love is complicated, and sacrifice has costs. The Bonelord wasn't imprisoned unfairly—he trapped himself through pride. The Warden speaks not as a jailer but as someone who chose this, knowing the alternative.

By Act 3, Callista faces the truth: breaking the seal would release cosmic horror. Her vows were built on lies—not malicious lies, just... incomplete truths. What now?

### Character Arc
- **Act 1:** Certainty. The Order is righteous. The Sanctum is evil. Destroy it.
- **Act 2:** Cracks. The Drowned King sacrificed himself for love. The Warden speaks with kindness. What if...?
- **Act 3:** Reformation. The Order was wrong about the *solution*, but not about the *problem*. Perhaps there's a third path—one that acknowledges the cost while seeking to reduce it.

### Personality
Intense. Absolutely convinced of her righteousness—until she isn't. Speaks in scripture quotes and absolute statements. As her certainty cracks, vulnerability shows through. She entered ready to die; she wasn't ready to be wrong.

Callista has never failed a mission. She's never questioned an order. The Sanctum will be her first failure and her first true choice.

### Vow Mechanic (Narrative Meaning)
Vows represent her rigid worldview. Power comes from commitment—but commitment can become a prison. Every Vow she makes is a reflection of the oaths she swore to the Order. Breaking a Vow isn't just mechanical damage; it's existential damage. Each break whispers: *"The Order lied. This truth burns."*

The Oathsworn who masters their Vows learns flexibility. Vows expire naturally when their purpose is fulfilled. The goal isn't never breaking Vows—it's knowing when to keep them and when to let them go.

### Voice Lines (UI/Combat Barks)
- On combat start: "In the name of the Burning Truth."
- On activating a Vow: "I swear by the Order..."
- On Vow breaking: "...the truth burns."
- On taking damage: "Pain is purifying."
- On dealing killing blow: "I release you from this prison."
- On low HP: "The mission is not yet complete."
- On victory: "Another step toward the seal."

### Warden Dialogue (Class-Specific)
- First meeting: "You came to destroy me. I do not blame you. Your Order means well."
- Act 1 Boss: "Lord Vexal believed his pride was righteousness. Sound familiar?"
- Act 2 Entry: "The Drowned King's kingdom lives because of his sacrifice. What would you sacrifice, Oathsworn?"
- Act 3 Entry: "You've seen the truth now. The seal cannot be broken—but perhaps it can be... reformed. If you're willing to stay."

### The Order's Scriptures (Flavor Text Sources)
- *"The truth burns brighter than any flame."*
- *"Eternal service is eternal slavery. Even willing chains are chains."*
- *"Break the seal. Free the bound. Let the world remake itself."*
- *"Our founder saw the Sanctum's horror and wept. We weep no more—we act."*

---

## Acceptance Criteria

1. Oathsworn starts with 75 max HP
2. Oathsworn starts with 3 max Resolve per turn
3. Starter deck: 4x Righteous Strike (1 Resolve, Deal 6 damage), 3x Sacred Shield (1 Resolve, Gain 6 block), 2x Oath of Valor (1 Resolve, Next 3 attacks deal +4 damage, cannot gain block), 1x Judgment (2 Resolve, Deal 12 damage, can only play if Vow is active)
4. Core mechanic: **Vows** - declare restrictions for powerful sustained effects
5. Active Vow provides significant bonuses but limits actions
6. Only one Vow can be active at a time
7. Vows last until their condition is broken or combat ends
8. Some cards require an active Vow to play (Judgment cards)
9. Breaking a Vow has consequences (lose bonuses, take damage, etc.)

## Tasks / Subtasks

- [x] Create Oathsworn class configuration (AC: 1, 2)
  - [x] Define OATHSWORN class with 75 HP, 3 Resolve
  - [ ] Mark as premium/DLC class
  - [x] Define starter deck recipe

- [x] Implement Oathsworn starter deck cards (AC: 3)
  - [x] **Righteous Strike**: { id: 'righteous_strike', type: ATTACK, cost: 1, effects: [DAMAGE 6] }
  - [x] **Sacred Shield**: { id: 'sacred_shield', type: SKILL, cost: 1, effects: [BLOCK 6] }
  - [x] **Oath of Valor**: { id: 'oath_of_valor', type: POWER, cost: 1, effects: [ACTIVATE_VOW 'valor'] }
  - [x] **Judgment**: { id: 'judgment', type: ATTACK, cost: 2, requiresVow: true, effects: [DAMAGE 12] }

- [x] Create oathsworn cards data file
  - [x] Create `src/data/cards/oathsworn.ts`
  - [x] Export OATHSWORN_CARDS record
  - [x] Register in card index

- [x] Implement Vows mechanic (AC: 4, 5, 6, 7)
  - [x] Add `activeVow` to PlayerState (null or Vow object)
  - [x] Define Vow interface with bonus and restriction
  - [x] Implement Vow activation (replaces current vow if any)
  - [x] Implement Vow restriction checking
  - [x] Implement Vow breaking detection
  - [x] Emit VOW_ACTIVATED, VOW_BROKEN events

- [x] Define starter Vows (AC: 5, 7)
  - [x] **Oath of Valor**:
    - Bonus: Next 3 attacks deal +4 damage
    - Restriction: Cannot gain block
    - Breaks when: You gain any block
    - Duration: 3 attacks or broken
  - [ ] **Oath of Protection** (future card) - **Deferred to card pool story**

- [x] Implement requiresVow card property (AC: 8)
  - [x] Cards with `requiresVow: true` can only be played with active Vow
  - [ ] Gray out cards when no Vow active - **Deferred to UI story**
  - [ ] Show "Requires Vow" tooltip - **Deferred to UI story**

- [x] Implement Vow breaking consequences (AC: 9)
  - [x] Breaking a Vow can cause immediate damage (5 HP for Oath of Valor)
  - [x] Each Vow defines its own break penalty

- [x] Implement Vow counter/tracking
  - [x] Track "charges" for Vows (e.g., "3 attacks remaining")
  - [x] Decrement on qualifying actions
  - [x] Vow ends naturally when charges depleted (no penalty)

- [ ] Update UI for Oathsworn - **Deferred to UI story**
  - [ ] Active Vow display (name, bonus, restriction)
  - [ ] Vow charges counter (if applicable)
  - [ ] Visual indicator for Vow-locked cards
  - [ ] Vow break warning when about to break
  - [ ] Vow activation animation

- [x] Write unit tests
  - [x] Test Oathsworn starts with 75 HP
  - [x] Test Oath of Valor activates correctly
  - [x] Test attacks deal +4 while Oath of Valor active
  - [x] Test gaining block breaks Oath of Valor
  - [x] Test Judgment can only be played with active Vow
  - [x] Test Vow charges decrement
  - [x] Test only one Vow active at a time

## Dev Notes

### Oathsworn Philosophy

The Oathsworn is about commitment:
- Vows provide powerful bonuses but lock you into strategies
- Smart players plan around restrictions
- Breaking Vows is punishing but sometimes necessary
- Judgment cards are powerful payoffs for maintaining Vows

### Vow System

```typescript
interface Vow {
  id: string;
  name: string;
  bonus: VowBonus;
  restriction: VowRestriction;
  charges?: number;          // Optional: Vow expires after X uses
  breakPenalty?: CardEffect[]; // Effects when broken
}

interface VowBonus {
  type: 'damage_boost' | 'block_per_turn' | 'draw_cards' | 'resolve_boost';
  amount: number;
}

interface VowRestriction {
  type: 'no_block' | 'no_attack' | 'no_skill' | 'must_attack';
  description: string;
}

// Example: Oath of Valor
const OATH_OF_VALOR: Vow = {
  id: 'oath_of_valor',
  name: 'Oath of Valor',
  bonus: { type: 'damage_boost', amount: 4 },
  restriction: { type: 'no_block', description: 'Cannot gain block' },
  charges: 3, // Lasts 3 attacks
  breakPenalty: [{ type: EffectType.LOSE_HP, amount: 5 }]
};
```

### Vow Restriction Checking

```typescript
function canGainBlock(): boolean {
  if (player.activeVow?.restriction.type === 'no_block') {
    return false; // Will break vow if attempted
  }
  return true;
}

function onBlockGain(amount: number): void {
  if (player.activeVow?.restriction.type === 'no_block') {
    breakVow('Gained block while under Oath of Valor');
    return;
  }
  player.block += amount;
}

function breakVow(reason: string): void {
  const vow = player.activeVow;
  if (!vow) return;

  emit('VOW_BROKEN', { vow, reason });

  // Apply break penalty
  if (vow.breakPenalty) {
    executeEffects(vow.breakPenalty);
  }

  player.activeVow = null;
}
```

### Judgment Card Pattern

```typescript
interface CardDefinition {
  // ... existing
  requiresVow?: boolean;  // Can only play with active Vow
}

function canPlayCard(card: Card): boolean {
  // ... existing checks
  if (card.requiresVow && !player.activeVow) {
    return false;
  }
  return true;
}
```

### Starter Deck Analysis

| Card | Count | Effect | Notes |
|------|-------|--------|-------|
| Righteous Strike | 4 | 6 damage | Basic attack |
| Sacred Shield | 3 | 6 block | Basic defense |
| Oath of Valor | 2 | Activate Vow | +4 damage, no block |
| Judgment | 1 | 12 damage | Requires active Vow |

**Total**: 10 cards
**Theme**: Commit to offense or defense, big payoffs for commitment

### Vow Ideas for Card Pool

- **Oath of Valor**: +damage, can't block
- **Oath of Protection**: +block/turn, can't attack
- **Oath of Retribution**: Deal damage when hit, must attack each turn
- **Sacred Vow**: +2 Resolve/turn, must play 3 cards each turn
- **Vow of Silence**: Double block, can't play Powers
- **Martyr's Oath**: Heal when damaged, cannot heal otherwise

## Testing

### Test File Location
`src/tests/classes/Oathsworn.test.ts`

### Key Test Scenarios

1. **Class Stats**: 75 HP, 3 Resolve
2. **Vow Activation**: Oath of Valor sets activeVow
3. **Vow Bonus**: Attacks deal +4 while Vow active
4. **Vow Break**: Gaining block triggers break penalty
5. **Vow Charges**: Vow expires after 3 attacks (no penalty)
6. **Requires Vow**: Judgment unplayable without Vow
7. **Single Vow**: New Vow replaces old one

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-03 | 1.0 | Initial story creation | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
N/A - No blocking issues encountered

### Completion Notes List
- Implemented Oathsworn class with 75 HP, 3 Resolve
- Created starter deck: 4x Righteous Strike, 3x Sacred Shield, 2x Oath of Valor, 1x Judgment
- Added Vow types: VowBonusType, VowRestrictionType, VowBonus, VowRestriction, Vow
- Added PlayerState.activeVow for tracking active vow
- Added CardDefinition properties: requiresVow, activatesVow
- Added CombatEventType: VOW_ACTIVATED, VOW_BROKEN, VOW_EXPIRED, VOW_CHARGE_USED
- Implemented Vow system in CombatEngine: activateVow, breakVow, consumeVowCharge
- Damage bonus from Vow applies to DAMAGE and DAMAGE_ALL effects
- Vow breaks when restriction is violated (e.g., gaining block under Oath of Valor)
- Vow expires naturally when charges are depleted (no penalty)
- Power cards now go to exhaust pile instead of discard
- 20 unit tests written, all passing (241 total tests pass)

### File List
- `src/types/index.ts` - Added Vow types, PlayerState.activeVow, CardDefinition properties, events
- `src/data/cards/oathsworn.ts` - NEW: Oathsworn card and vow definitions
- `src/data/cards/index.ts` - Registered Oathsworn cards
- `src/data/classes.ts` - Updated Oathsworn starter deck recipe
- `src/engine/CombatEngine.ts` - Added Vow system (activation, breaking, charges, damage bonus)
- `src/main.ts` - Added activeVow: null to PlayerState initialization
- `src/data/oathsworn.test.ts` - NEW: 20 unit tests for Oathsworn
- `src/engine/CombatEngine.test.ts` - Added activeVow to mock
- `src/data/diabolist.test.ts` - Added activeVow to mock
- `src/data/enemies/act1.test.ts` - Added activeVow to mock
- `src/data/enemies/bosses.test.ts` - Added activeVow to mock
- `src/data/enemies/elites.test.ts` - Added activeVow to mock
- `src/data/knight.test.ts` - Added activeVow to mock

---

## QA Results
_To be filled by QA agent_
