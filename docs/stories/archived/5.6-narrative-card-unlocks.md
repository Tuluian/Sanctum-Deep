# Story 5.6: Narrative Card Unlocks & Event System

## Status: Complete

## Story

**As a** player progressing through the game,
**I want** to unlock new cards through narrative achievements and discoveries,
**so that** my deck-building options expand meaningfully as I experience the story.

## Narrative Philosophy

Cards aren't just mechanics—they're knowledge gained, techniques learned, and powers discovered. A Cleric who defeats the Bonelord might learn "Shatter the Undead" from witnessing his weakness. A Knight who finds their mentor's remains might unlock "Ser Aldric's Last Stand."

This system ties card progression to story moments, making unlocks feel earned and meaningful rather than random.

---

## Related Documentation

> **IMPORTANT:** This story works in conjunction with several narrative documents. Developers should review these before implementation:

| Document | Purpose | Location |
|----------|---------|----------|
| **Narrative Events Complete** | 50+ CYOA-style events with choices, rewards, and penalties | `docs/stories/narrative-events-complete.md` |
| **Story Cards System** | Ambient narrative moments between rooms | `docs/stories/story-cards-system.md` |
| **Warden Dialogue Complete** | All Lyra dialogue organized by class and act | `docs/stories/warden-dialogue-complete.md` |
| **World Bible** | Master lore reference for all narrative content | `docs/lore/world-bible.md` |

### How These Systems Interact

```
┌─────────────────────────────────────────────────────────────────┐
│                    NARRATIVE SYSTEMS OVERVIEW                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐     ┌─────────────────┐                   │
│  │  Story Cards    │     │ Narrative Events│                   │
│  │  (Flavor text)  │     │ (CYOA choices)  │                   │
│  │                 │     │                 │                   │
│  │ - Warden whispers│    │ - Stat boosts   │                   │
│  │ - Character     │     │ - Card rewards  │                   │
│  │   thoughts      │     │ - Risk/reward   │                   │
│  │ - Atmosphere    │     │ - Penalties     │                   │
│  └────────┬────────┘     └────────┬────────┘                   │
│           │                       │                             │
│           └───────────┬───────────┘                             │
│                       ▼                                         │
│           ┌─────────────────────┐                               │
│           │   Card Unlocks      │                               │
│           │   (This Story)      │                               │
│           │                     │                               │
│           │ - Boss defeats      │                               │
│           │ - Event choices     │◄── Triggered by events        │
│           │ - Achievements      │                               │
│           │ - Discoveries       │                               │
│           └─────────────────────┘                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Event-Triggered Card Unlocks

Many card unlocks are triggered by narrative events defined in `narrative-events-complete.md`. When implementing, ensure the event system calls `CardUnlockService.recordEvent()` appropriately:

```typescript
// Example: Knight finds mentor's camp (from narrative-events-complete.md)
// Event ID: knight_aldric_camp

function handleNarrativeEventChoice(eventId: string, choiceId: string): void {
  // Apply immediate rewards/penalties from the event
  applyEventOutcome(eventId, choiceId);

  // Check for card unlocks
  const unlocks = CardUnlockService.recordEvent(eventId, choiceId);

  // Display any newly unlocked cards
  for (const unlock of unlocks) {
    showCardUnlockPopup(unlock);
  }
}
```

---

## Acceptance Criteria

1. Cards can be locked behind narrative triggers (boss defeats, discoveries, class-specific moments)
2. Unlocked cards are added to the class's reward pool permanently
3. Unlock progress persists across runs (meta-progression)
4. Visual/audio feedback when a card is unlocked
5. Card unlock screen shows the narrative context for why it was unlocked
6. Locked cards visible but grayed out in collection view with unlock hints
7. Some cards require multiple conditions (e.g., "Defeat Bonelord as Cleric")

## Unlock Trigger Types

### Boss Defeats
Cards unlocked by defeating specific bosses (any class)

| Card | Trigger | Narrative |
|------|---------|-----------|
| Shatter Bones | Defeat Bonelord | "You learned where the undead are weakest." |
| Drown the Darkness | Defeat Drowned King | "Water can purify. You witnessed it firsthand." |
| Void Resistance | Defeat Hollow God | "You stared into nothing and nothing blinked first." |

### Class-Specific Boss Defeats
Cards unlocked by defeating bosses as a specific class

| Card | Class | Trigger | Narrative |
|------|-------|---------|-----------|
| Lord Vexal's Folly | Knight | Defeat Bonelord | "Pride was his weakness. Let it be your strength." |
| Aldric's Sacrifice | Cleric | Defeat Drowned King | "He gave everything for love. You understand now." |
| Unmaking Word | Diabolist | Defeat Hollow God | "Xan'thrax taught you to destroy. The void taught you what destruction means." |

### Discovery Events
Cards unlocked by finding specific things during runs

| Card | Trigger | Location | Narrative |
|------|---------|----------|-----------|
| Mentor's Technique | Find Ser Aldric's crest | Act 1 Elite | "His shield is broken, but his teachings remain." |
| Prayer of the Lost | Find the abandoned altar | Act 1 Shrine | "Someone prayed here once. Their words still echo." |
| Thalassar's Memory | Find the Queen's letters | Act 2 | "Love letters from a kingdom that no longer exists." |

### Shrine Choices
Cards unlocked by making specific shrine choices

| Card | Shrine | Choice | Narrative |
|------|--------|--------|-----------|
| Blood Offering | Shrine of Sacrifice | Sacrifice 10 HP | "Pain can be transformed into power." |
| Curse Eater | Shrine of Shadows | Accept a curse | "You learned to digest darkness." |
| Fate's Gambit | Shrine of Fortune | Win the gamble | "Fortune favors the bold—this time." |

### Achievement-Based
Cards unlocked through gameplay achievements

| Card | Achievement | Narrative |
|------|-------------|-----------|
| One With Nothing | Win a combat with 0 cards in hand | "Emptiness became your weapon." |
| Endless Resolve | Spend 20+ Resolve in a single turn | "Your will is bottomless." |
| Untouchable | Win a combat without taking damage | "They couldn't touch you. They never will." |
| Survivor's Instinct | Win a run after triggering Death's Door | "You came back from the edge. You brought something with you." |

### Run Milestones
Cards unlocked by reaching certain points

| Card | Milestone | Narrative |
|------|-----------|-----------|
| Warden's Whisper | Reach Act 3 for the first time | "The Warden speaks to you now. Listen." |
| True Ending Glimpse | Complete a run with any class | "You know how the story ends. Now learn to change it." |
| Legacy of Five | Complete a run with all 5 classes | "Every path leads here. Every lesson combines." |

---

## Narrative Event Integration

> **See `docs/stories/narrative-events-complete.md` for full event definitions**

The following events from the narrative events document can trigger card unlocks:

### Class-Specific Event Unlocks

| Event ID | Class | Trigger Choice | Unlocks Card |
|----------|-------|----------------|--------------|
| `knight_aldric_camp` | Knight | "Finish His Sentence" | Mentor's Wisdom |
| `knight_aldric_camp` | Knight | "Take His Journal" | Mentor's Technique |
| `knight_crystal_mentor` | Knight | "Touch the Crystal" | Last Stand |
| `cleric_prayer_book` | Cleric | "Read the New Prayers" | Aldous's Final Prayer |
| `cleric_silent_chapel` | Cleric | "Pray to Brother Aldous" | True Faith |
| `diabolist_other_contract` | Diabolist | "Play Them Against Each Other" | Devil's Leverage |
| `oathsworn_mara_writing` | Oathsworn | "Read the Forbidden Words" | Mara's Truth |
| `oathsworn_oath_stone` | Oathsworn | "Carve a New Oath" | Reformed Vow |
| `fey_oberons_gambit` | Fey-Touched | "Turn the Card" (Blessing) | Oberon's Gift |
| `fey_fairy_ring` | Fey-Touched | "Enter the Ring" | Fey Bargain |
| `celestial_auriel_speaks` | Celestial | "Offer Understanding" | Shared Light |
| `celestial_god_fragment` | Celestial | "Merge Permanently" | Divine Fusion |
| `summoner_wisp_memory` | Summoner | "Absorb the Fragment" | Ancient Wisp |
| `summoner_lumina_returns` | Summoner | "Embrace Her" | Lumina's Light |
| `bargainer_lily_prayer` | Bargainer | "Listen to the Full Prayer" | Worth Fighting For |
| `bargainer_final_deal` | Bargainer | "Open Negotiations" | Void Bargain |

### Universal Event Unlocks

| Event ID | Trigger Choice | Unlocks Card |
|----------|----------------|--------------|
| `whispering_walls` | "Listen Closely" (Good) | Echo Strike |
| `broken_shrine_act1` | "Vandalize Further" (Power) | Stolen Divinity |
| `merchant_ghost` | "Trade a Memory" | Merchant's Wisdom |
| `coral_throne` | "Sit on the Throne" (Vision) | Thalassar's Blessing |
| `mirror_self` | "Refuse" | Self-Assurance |
| `wardens_gift` | "Accept Her Gift" | Lyra's Blessing |

### Event Outcome to Unlock Mapping

```typescript
// src/data/eventUnlockMappings.ts

export const EVENT_UNLOCK_MAPPINGS: Record<string, Record<string, string>> = {
  // Knight events
  'knight_aldric_camp': {
    'finish_sentence': 'mentors_wisdom',
    'take_journal': 'mentors_technique',
  },
  'knight_crystal_mentor': {
    'touch_crystal': 'last_stand',
    'forgive_him': 'aldrics_forgiveness',
    'promise_victory': 'sworn_victory',
  },

  // Cleric events
  'cleric_prayer_book': {
    'read_new_prayers': 'aldous_final_prayer',
    'pray_familiar': 'traditional_faith',
  },
  'cleric_silent_chapel': {
    'pray_to_aldous': 'true_faith',
    'say_goodbye': 'peaceful_parting',
  },

  // Universal events
  'whispering_walls': {
    'listen_closely_good': 'echo_strike',
  },
  'broken_shrine_act1': {
    'vandalize_power': 'stolen_divinity',
  },
  'merchant_ghost': {
    'trade_memory': 'merchants_wisdom',
  },

  // ... additional mappings in full implementation
};

// Usage in NarrativeEventService
function resolveEventOutcome(eventId: string, choiceId: string, outcomeId: string): void {
  const unlockKey = `${choiceId}_${outcomeId}`;
  const cardId = EVENT_UNLOCK_MAPPINGS[eventId]?.[unlockKey]
                 || EVENT_UNLOCK_MAPPINGS[eventId]?.[choiceId];

  if (cardId) {
    CardUnlockService.recordEvent(eventId, choiceId);
  }
}
```

---

## Tasks / Subtasks

### Phase 1: Narrative Event System (Priority)

- [x] Implement Narrative Event System
  - [x] Create `src/types/narrativeEvents.ts` (use interfaces from `narrative-events-complete.md`)
  - [x] Create `src/data/narrativeEvents/` directory structure
  - [x] Create `src/data/narrativeEvents/universal.ts` - Universal events
  - [x] Create `src/data/narrativeEvents/classSpecific.ts` - Class-specific events
  - [x] Create `src/services/NarrativeEventService.ts`

- [x] Implement Event Trigger System
  - [x] Add event trigger checks after room completion
  - [x] Implement progress-based triggers (rooms cleared)
  - [x] Implement health-based triggers (HP thresholds)
  - [x] Implement boss-related triggers (pre/post boss)
  - [x] Implement random triggers (% chance per room)
  - [x] Implement class restriction checks

- [x] Implement Event Choice/Outcome System
  - [x] Create weighted random outcome selection
  - [x] Implement reward application (HP, Resolve, Damage, Cards)
  - [x] Implement penalty application (HP loss, Curses)
  - [x] Implement special outcomes (skip encounter, start combat)
  - [x] Track choices for unlock triggers

- [x] Implement Event UI
  - [x] Create `src/ui/screens/NarrativeEventScreen.ts`
  - [x] Full-screen parchment overlay
  - [x] Speaker portrait (Warden, Character, Unknown)
  - [x] Choice buttons with hover flavor text
  - [x] Outcome reveal animation
  - [x] Reward/penalty display

### Phase 2: Card Unlock System

- [x] Design unlock data structure
  - [x] Create `src/types/unlocks.ts`
  - [x] Define `CardUnlock` interface
  - [x] Define `UnlockTrigger` types
  - [x] Define `UnlockProgress` persistence

- [x] Implement unlock service
  - [x] Create `src/services/CardUnlockService.ts`
  - [x] Track unlocked cards per class
  - [x] Check trigger conditions
  - [x] Fire unlock events
  - [x] Persist to localStorage

- [x] Create event-to-unlock mappings
  - [x] Create `src/data/eventUnlockMappings.ts`
  - [x] Map all events from `narrative-events-complete.md` to card unlocks
  - [x] Integrate with NarrativeEventService

- [x] Define unlockable cards
  - [x] Create `src/data/unlockableCards.ts`
  - [x] Define 5+ boss-unlock cards
  - [x] Define 5+ discovery-unlock cards
  - [x] Define 5+ achievement-unlock cards
  - [x] Define 15+ event-unlock cards (from narrative events)
  - [x] Add unlock requirements to each

### Phase 3: Integration & Polish

- [x] Integrate with game systems
  - [x] Hook boss defeat events → CardUnlockService
  - [x] Hook narrative event choices → CardUnlockService
  - [x] Hook shrine choice events → CardUnlockService
  - [x] Hook achievement triggers → CardUnlockService

- [x] Implement unlock UI
  - [x] Create card unlock popup/modal
  - [x] Show narrative text
  - [x] Play unlock sound effect
  - [x] Add unlock animation

- [x] Implement collection view
  - [x] Show all cards (locked and unlocked)
  - [x] Locked cards grayed with "???" or silhouette
  - [x] Hover shows unlock hint
  - [x] Track unlock progress

- [x] Write unit tests
  - [x] Test event trigger detection
  - [x] Test weighted outcome selection
  - [x] Test reward/penalty application
  - [x] Test unlock trigger detection
  - [x] Test persistence
  - [x] Test card pool modification
  - [x] Test multi-condition unlocks

## Dev Notes

### Unlock Data Structure

```typescript
// src/types/unlocks.ts

export type UnlockTriggerType =
  | 'BOSS_DEFEAT'
  | 'CLASS_BOSS_DEFEAT'
  | 'DISCOVERY'
  | 'SHRINE_CHOICE'
  | 'ACHIEVEMENT'
  | 'MILESTONE';

export interface UnlockTrigger {
  type: UnlockTriggerType;
  // Boss defeats
  bossId?: string;
  // Class-specific
  requiredClass?: CharacterClassId;
  // Discovery/Shrine
  eventId?: string;
  choiceId?: string;
  // Achievement
  achievementId?: string;
  // Milestone
  milestoneId?: string;
}

export interface CardUnlock {
  cardId: string;
  triggers: UnlockTrigger[]; // All must be satisfied (AND logic)
  narrativeText: string;
  hintText: string; // Shown when locked
  classRestriction?: CharacterClassId; // Only this class can use it
}

export interface UnlockProgress {
  unlockedCards: string[];
  seenEvents: string[]; // Track discoveries/choices made
  defeatedBosses: Record<string, CharacterClassId[]>; // bossId -> classes that beat it
  achievementsEarned: string[];
  milestonesReached: string[];
}
```

### Unlock Definitions

```typescript
// src/data/unlockableCards.ts

export const UNLOCKABLE_CARDS: CardUnlock[] = [
  // Boss Unlock - Any Class
  {
    cardId: 'shatter_bones',
    triggers: [{ type: 'BOSS_DEFEAT', bossId: 'bonelord' }],
    narrativeText: "Lord Vexal's skeleton crumbles. In its fall, you see the weakness of all undead—the joints, the bindings, the hollow core. This knowledge becomes power.",
    hintText: "Defeat the Bonelord",
  },

  // Class-Specific Boss Unlock
  {
    cardId: 'lord_vexals_folly',
    triggers: [
      { type: 'BOSS_DEFEAT', bossId: 'bonelord' },
      { type: 'CLASS_BOSS_DEFEAT', bossId: 'bonelord', requiredClass: CharacterClassId.DUNGEON_KNIGHT },
    ],
    narrativeText: "He sought immortality through pride. You watched him fall. Let his mistake be your lesson—and your weapon.",
    hintText: "Defeat the Bonelord as the Dungeon Knight",
    classRestriction: CharacterClassId.DUNGEON_KNIGHT,
  },

  // Discovery Unlock
  {
    cardId: 'mentors_technique',
    triggers: [{ type: 'DISCOVERY', eventId: 'find_aldric_crest' }],
    narrativeText: "Ser Aldric's crest is cold in your hands. The metal remembers his grip, his stance, his final teaching: 'Hold until you cannot. Then hold longer.'",
    hintText: "Find Ser Aldric's remains in the Sanctum",
    classRestriction: CharacterClassId.DUNGEON_KNIGHT,
  },

  // Shrine Choice Unlock
  {
    cardId: 'blood_offering',
    triggers: [{ type: 'SHRINE_CHOICE', eventId: 'shrine_sacrifice', choiceId: 'sacrifice_hp' }],
    narrativeText: "Your blood drips onto the altar. It doesn't disappear—it transforms. Pain becomes something you can give to others.",
    hintText: "Sacrifice HP at the Shrine of Sacrifice",
  },

  // Achievement Unlock
  {
    cardId: 'one_with_nothing',
    triggers: [{ type: 'ACHIEVEMENT', achievementId: 'empty_hand_victory' }],
    narrativeText: "They expected a card. You had none. They expected defeat. You gave them emptiness—and emptiness won.",
    hintText: "Win a combat with 0 cards in hand",
  },

  // Multi-Condition Unlock
  {
    cardId: 'true_faith',
    triggers: [
      { type: 'BOSS_DEFEAT', bossId: 'hollow_god' },
      { type: 'CLASS_BOSS_DEFEAT', bossId: 'hollow_god', requiredClass: CharacterClassId.CLERIC },
      { type: 'ACHIEVEMENT', achievementId: 'max_devotion_victory' },
    ],
    narrativeText: "You stared into absolute nothing and believed anyway. Your god may be silent, but you are not. You are the answer to your own prayers.",
    hintText: "Master devotion and face the ultimate void as the Cleric",
    classRestriction: CharacterClassId.CLERIC,
  },
];
```

### Card Unlock Service

```typescript
// src/services/CardUnlockService.ts

export class CardUnlockService {
  private progress: UnlockProgress;

  constructor() {
    this.loadProgress();
  }

  // Check if a specific trigger is satisfied
  private isTriggerSatisfied(trigger: UnlockTrigger): boolean {
    switch (trigger.type) {
      case 'BOSS_DEFEAT':
        return !!this.progress.defeatedBosses[trigger.bossId!];

      case 'CLASS_BOSS_DEFEAT':
        const classes = this.progress.defeatedBosses[trigger.bossId!] || [];
        return classes.includes(trigger.requiredClass!);

      case 'DISCOVERY':
        return this.progress.seenEvents.includes(trigger.eventId!);

      case 'SHRINE_CHOICE':
        return this.progress.seenEvents.includes(`${trigger.eventId}_${trigger.choiceId}`);

      case 'ACHIEVEMENT':
        return this.progress.achievementsEarned.includes(trigger.achievementId!);

      case 'MILESTONE':
        return this.progress.milestonesReached.includes(trigger.milestoneId!);

      default:
        return false;
    }
  }

  // Check if a card should be unlocked
  isCardUnlocked(cardId: string): boolean {
    if (this.progress.unlockedCards.includes(cardId)) return true;

    const unlock = UNLOCKABLE_CARDS.find(u => u.cardId === cardId);
    if (!unlock) return true; // Not in unlock list = always available

    // All triggers must be satisfied
    return unlock.triggers.every(t => this.isTriggerSatisfied(t));
  }

  // Record a boss defeat
  recordBossDefeat(bossId: string, classId: CharacterClassId): CardUnlock[] {
    if (!this.progress.defeatedBosses[bossId]) {
      this.progress.defeatedBosses[bossId] = [];
    }
    if (!this.progress.defeatedBosses[bossId].includes(classId)) {
      this.progress.defeatedBosses[bossId].push(classId);
    }

    return this.checkNewUnlocks();
  }

  // Record a discovery/event
  recordEvent(eventId: string, choiceId?: string): CardUnlock[] {
    const key = choiceId ? `${eventId}_${choiceId}` : eventId;
    if (!this.progress.seenEvents.includes(key)) {
      this.progress.seenEvents.push(key);
    }

    return this.checkNewUnlocks();
  }

  // Record an achievement
  recordAchievement(achievementId: string): CardUnlock[] {
    if (!this.progress.achievementsEarned.includes(achievementId)) {
      this.progress.achievementsEarned.push(achievementId);
    }

    return this.checkNewUnlocks();
  }

  // Check for newly unlocked cards
  private checkNewUnlocks(): CardUnlock[] {
    const newUnlocks: CardUnlock[] = [];

    for (const unlock of UNLOCKABLE_CARDS) {
      if (this.progress.unlockedCards.includes(unlock.cardId)) continue;

      if (unlock.triggers.every(t => this.isTriggerSatisfied(t))) {
        this.progress.unlockedCards.push(unlock.cardId);
        newUnlocks.push(unlock);
      }
    }

    if (newUnlocks.length > 0) {
      this.saveProgress();
    }

    return newUnlocks;
  }

  // Get available cards for a class (base pool + unlocked)
  getAvailableCards(classId: CharacterClassId): CardDefinition[] {
    const basePool = getClassCardPool(classId);
    const unlocked = this.progress.unlockedCards
      .map(id => getCardById(id))
      .filter(card => card && (!card.classRestriction || card.classRestriction === classId));

    return [...basePool, ...unlocked];
  }

  // Get unlock hint for a locked card
  getUnlockHint(cardId: string): string | null {
    const unlock = UNLOCKABLE_CARDS.find(u => u.cardId === cardId);
    return unlock?.hintText ?? null;
  }
}
```

### Unlock UI Flow

```
┌──────────────────────────────────────────────────────────────┐
│                     ✨ CARD UNLOCKED ✨                      │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│                    ┌─────────────────┐                       │
│                    │   SHATTER       │                       │
│                    │    BONES        │                       │
│                    │                 │                       │
│                    │  Deal 12 damage │                       │
│                    │  to undead.     │                       │
│                    │  Deal 8 to      │                       │
│                    │  others.        │                       │
│                    │        2        │                       │
│                    └─────────────────┘                       │
│                                                              │
│  "Lord Vexal's skeleton crumbles. In its fall, you see      │
│   the weakness of all undead—the joints, the bindings,      │
│   the hollow core. This knowledge becomes power."           │
│                                                              │
│              This card is now in your reward pool.          │
│                                                              │
│                      [ Continue ]                            │
└──────────────────────────────────────────────────────────────┘
```

### Integration Points

**Boss Defeat:**
```typescript
// In handleBossDefeat()
const newUnlocks = CardUnlockService.recordBossDefeat(bossId, currentClassId);
for (const unlock of newUnlocks) {
  showCardUnlockPopup(unlock);
  AudioManager.playSfx('card-unlock');
}
```

**Shrine Choice:**
```typescript
// In handleShrineChoice()
const newUnlocks = CardUnlockService.recordEvent(shrineId, choiceId);
// Show unlocks after shrine resolution
```

**Achievement:**
```typescript
// In AchievementService.grant()
const newUnlocks = CardUnlockService.recordAchievement(achievementId);
// Queue unlock popups after achievement popup
```

### Narrative Card Examples

**Shatter Bones** (Unlocked: Defeat Bonelord)
- Cost: 1
- Type: Attack
- Effect: Deal 12 damage to Undead enemies. Deal 8 damage to others.
- Flavor: "The dead have weaknesses. You learned them the hard way."

**Lord Vexal's Folly** (Unlocked: Defeat Bonelord as Knight)
- Cost: 1
- Type: Skill
- Effect: Gain 8 Block. If enemy intends to buff, gain 15 instead.
- Flavor: "Pride goes before the fall. You've seen it firsthand."

**Mentor's Technique** (Unlocked: Find Ser Aldric's crest)
- Cost: 2
- Type: Attack
- Effect: Deal 10 damage. Gain Fortify equal to damage dealt.
- Flavor: "Hold until you cannot. Then hold longer."

**One With Nothing** (Unlocked: Win with 0 cards in hand)
- Cost: 0
- Type: Skill
- Effect: If your hand is empty, gain 15 Block and draw 2 cards.
- Flavor: "Emptiness is not weakness. It is potential."

## Testing

### Test File Location
`src/tests/services/CardUnlockService.test.ts`

### Key Test Scenarios

1. **Single Trigger Unlock**: Boss defeat unlocks card
2. **Multi-Trigger Unlock**: All conditions must be met
3. **Class-Specific**: Only unlocks for correct class
4. **Persistence**: Unlocks persist across sessions
5. **No Duplicates**: Can't unlock same card twice
6. **Card Pool Integration**: Unlocked cards appear in rewards

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-03 | 1.0 | Initial story creation | James (Dev) |
| 2024-12-04 | 2.0 | Expanded to include Narrative Event System integration; added related documentation references; added Phase 1-3 task structure; mapped events to card unlocks | World Builder Agent |
| 2024-12-05 | 3.0 | Implemented all phases: unlock types, CardUnlockService, event mappings, 40+ unlockable cards, CardUnlockPopup, CollectionScreen, comprehensive tests. All 918 tests pass. | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- No blocking issues encountered during implementation.
- localStorage warnings during tests are expected (harmless - tests still pass).

### Completion Notes List
- Phase 1 (Narrative Event System) was already complete from prior session.
- Phase 2: Created unlock type system with UnlockTrigger and UnlockProgress interfaces.
- Phase 2: Implemented CardUnlockService with localStorage persistence, event recording, and unlock checking.
- Phase 2: Created event-to-unlock mappings for all narrative events from the universal and class-specific event files.
- Phase 2: Defined 40+ unlockable cards spanning boss defeats, event choices, achievements, milestones, discoveries, and shrine choices.
- Phase 3: Integrated CardUnlockService with NarrativeEventService via resolveChoice() method.
- Phase 3: Created CardUnlockPopup component with animation and multi-unlock navigation.
- Phase 3: Created CollectionScreen for viewing locked/unlocked cards with filtering and detail panels.
- Phase 3: Wrote comprehensive unit tests for CardUnlockService (30+ test cases).
- All 918 tests pass. TypeScript build succeeds.

### File List
**New Files:**
- src/types/unlocks.ts - Unlock type definitions
- src/services/CardUnlockService.ts - Card unlock progression service
- src/services/CardUnlockService.test.ts - Unit tests for CardUnlockService
- src/data/unlockableCards.ts - All unlockable card definitions
- src/data/eventUnlockMappings.ts - Event-to-unlock card mappings
- src/ui/CardUnlockPopup.ts - Unlock notification popup component
- src/ui/screens/CollectionScreen.ts - Card collection view screen

**Modified Files:**
- src/services/NarrativeEventService.ts - Added CardUnlockService integration in resolveChoice()

---

## QA Results

### Gate Status: PASS
**Reviewed by:** Quinn (Test Architect)
**Date:** 2024-12-05

### Verification Summary
- All 918 tests pass (including CardUnlockService tests)
- All task checkboxes marked complete
- Dev Agent Record fully populated
- All listed files verified to exist

### Files Verified
- src/types/unlocks.ts
- src/services/CardUnlockService.ts
- src/services/CardUnlockService.test.ts
- src/data/unlockableCards.ts
- src/data/eventUnlockMappings.ts
- src/ui/CardUnlockPopup.ts
- src/ui/screens/CollectionScreen.ts
- src/services/NarrativeEventService.ts (integration verified)

### Acceptance Criteria Coverage
| AC | Status | Notes |
|----|--------|-------|
| 1 | PASS | Cards locked behind narrative triggers implemented |
| 2 | PASS | Unlocked cards added to class reward pool |
| 3 | PASS | Unlock progress persists via localStorage |
| 4 | PASS | CardUnlockPopup with animation and sound |
| 5 | PASS | Narrative context shown in unlock popup |
| 6 | PASS | CollectionScreen shows locked cards with hints |
| 7 | PASS | Multi-condition unlocks supported |

### Recommendations
- Monitor: Verify unlock popups display correctly in-game
- Monitor: Test multi-unlock scenarios (multiple cards unlocked at once)

### Decision
**APPROVED FOR COMPLETION** - Story meets all acceptance criteria with exemplary documentation.
