# Story 16.2: Steamworks SDK Integration

## Status: Draft

## Story

**As a** developer publishing on Steam,
**I want** Steamworks SDK integrated into the Electron app,
**so that** Steam features like achievements, overlay, and cloud saves work.

## Acceptance Criteria

1. Steamworks SDK added to Electron project
2. Steam App ID configured correctly
3. Steam overlay activates in-game (Shift+Tab)
4. Steam client detected and connected
5. Steamworks API calls work (user ID, name)
6. App launches correctly from Steam client
7. Non-Steam launch shows appropriate message

## Tasks / Subtasks

- [ ] Set up Steam developer account (AC: 2)
  - [ ] Create Steamworks account ($100 fee)
  - [ ] Create app listing for Sanctum Ruins
  - [ ] Note App ID for configuration
- [ ] Install Steamworks SDK (AC: 1)
  - [ ] Install `steamworks.js` package (greenworks alternative)
  - [ ] Or use `greenworks` native addon
  - [ ] Configure Electron rebuild for native modules
- [ ] Configure App ID (AC: 2)
  - [ ] Create `steam_appid.txt` in project root
  - [ ] Set App ID in Steamworks init
- [ ] Initialize Steamworks in Electron (AC: 3, 4)
  - [ ] Add init code to Electron main process
  - [ ] Handle init failure gracefully
  - [ ] Pass Steam status to renderer
- [ ] Test Steam integration (AC: 5, 6)
  - [ ] Get current user Steam ID
  - [ ] Get current user display name
  - [ ] Test Steam overlay activation
- [ ] Handle non-Steam launch (AC: 7)
  - [ ] Detect Steam client not running
  - [ ] Show user-friendly message
  - [ ] Allow play without Steam features

## Dev Notes

### Steamworks Package Options

**Option A: steamworks.js (Recommended)**
Pure JavaScript bindings, easier setup:
```bash
npm install steamworks.js
```

**Option B: Greenworks**
Native addon, requires rebuild:
```bash
npm install greenworks
npx electron-rebuild
```

### steam_appid.txt

Create in project root:
```
480
```
Note: Use `480` (Spacewar) for testing, replace with real App ID for release.

### Steamworks Initialization

```javascript
// electron/steam.js
let steamworks;
let steamInitialized = false;

function initSteam() {
  try {
    steamworks = require('steamworks.js');

    // Initialize with your App ID
    const client = steamworks.init(YOUR_APP_ID);

    if (client) {
      steamInitialized = true;
      console.log('Steam initialized successfully');
      console.log('Steam User:', client.localplayer.getName());
      return true;
    }
  } catch (error) {
    console.warn('Steam initialization failed:', error.message);
  }

  return false;
}

function getSteamUser() {
  if (!steamInitialized) return null;
  return {
    id: steamworks.localplayer.getSteamId().steamId64,
    name: steamworks.localplayer.getName(),
  };
}

module.exports = { initSteam, getSteamUser, steamInitialized };
```

### Electron Main Process Integration

```javascript
// electron/main.js
const { initSteam, getSteamUser } = require('./steam');

// Initialize Steam before creating window
const steamReady = initSteam();

function createWindow() {
  mainWindow = new BrowserWindow({
    // ... existing config
    webPreferences: {
      preload: path.join(__dirname, 'preload.js'),
      contextIsolation: true,
    },
  });

  // Pass Steam status to renderer
  mainWindow.webContents.on('did-finish-load', () => {
    mainWindow.webContents.send('steam-status', {
      initialized: steamReady,
      user: getSteamUser(),
    });
  });
}
```

### Preload Script for Renderer Access

```javascript
// electron/preload.js
const { contextBridge, ipcRenderer } = require('electron');

contextBridge.exposeInMainWorld('steam', {
  onStatus: (callback) => ipcRenderer.on('steam-status', (_, data) => callback(data)),
  getAchievements: () => ipcRenderer.invoke('steam-get-achievements'),
  unlockAchievement: (id) => ipcRenderer.invoke('steam-unlock-achievement', id),
});
```

### Steam Overlay Requirements

Steam overlay requires:
1. Steam client running
2. Game launched from Steam (or with `steam_appid.txt`)
3. Game window focused
4. No fullscreen exclusive mode (use borderless)

### Non-Steam Launch Handling

```javascript
// In renderer
window.steam.onStatus((status) => {
  if (!status.initialized) {
    showMessage('Steam not detected. Some features will be unavailable.');
    // Game still playable, just no achievements/cloud
  } else {
    console.log(`Welcome, ${status.user.name}!`);
  }
});
```

### Build Configuration

```json
// package.json
{
  "build": {
    "files": [
      "steam_appid.txt",
      "node_modules/steamworks.js/**/*"
    ],
    "extraResources": [
      {
        "from": "node_modules/steamworks.js/dist/",
        "to": "steamworks/"
      }
    ]
  }
}
```

### Testing Without Steam

For development without Steam:
```javascript
// Mock Steam API
if (process.env.MOCK_STEAM) {
  module.exports = {
    initSteam: () => true,
    getSteamUser: () => ({ id: '123', name: 'Developer' }),
    steamInitialized: true,
  };
}
```

### Relevant Files
- `electron/steam.js` (new)
- `electron/main.js` (modify)
- `electron/preload.js` (modify)
- `steam_appid.txt` (new)
- `package.json` (modify build config)

## Testing

- Test file location: N/A (integration testing)
- Manual verification:
  - Launch from Steam client
  - Verify overlay works (Shift+Tab)
  - Verify user name displays
  - Launch outside Steam, verify graceful fallback

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-05 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

_To be filled by Dev agent_

---

## QA Results

_To be filled by QA agent_
