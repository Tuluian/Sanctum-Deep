# Story 14.1: Heroku Postgres Setup

## Status: Draft

## Story

**As a** developer,
**I want** to set up a Heroku Postgres database,
**so that** we have a production-ready database for user accounts and cloud saves.

## Acceptance Criteria

1. Heroku Postgres addon is provisioned (Mini or Basic tier)
2. Database connection string is available as environment variable
3. Connection pooling is configured for production use
4. Database can be accessed from local development environment
5. Backup schedule is configured (if available on tier)
6. Database credentials are securely stored (not in code)

## Tasks

- [ ] Create Heroku app (if not exists) or use existing sanctum-ruins app
- [ ] Provision Heroku Postgres addon (`heroku addons:create heroku-postgresql:mini`)
- [ ] Verify DATABASE_URL is set in Heroku config vars
- [ ] Set up local `.env` file with database connection for development
- [ ] Test connection from local machine using `psql` or similar
- [ ] Document connection string format and usage
- [ ] Configure connection pool settings (max connections based on tier)

## Technical Notes

### Heroku Postgres Tiers

| Tier | Price | Rows | Connections | Recommended For |
|------|-------|------|-------------|-----------------|
| Mini | $5/mo | 10k | 20 | Development/Early Launch |
| Basic | $9/mo | 10M | 20 | Production |
| Standard-0 | $50/mo | Unlimited | 120 | Scale |

**Recommendation:** Start with Mini for development, upgrade to Basic before launch.

### Connection String Format

```
postgres://USER:PASSWORD@HOST:PORT/DATABASE
```

### Environment Variables

```bash
# .env (local development)
DATABASE_URL=postgres://localhost:5432/sanctum_ruins_dev

# Heroku sets this automatically
# DATABASE_URL=postgres://xxx:yyy@ec2-xxx.compute-1.amazonaws.com:5432/zzz
```

### Connection Pool Configuration

```typescript
// For Heroku Postgres Mini/Basic (20 connection limit)
const poolConfig = {
  connectionString: process.env.DATABASE_URL,
  max: 10, // Leave headroom for other connections
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
  ssl: process.env.NODE_ENV === 'production'
    ? { rejectUnauthorized: false }
    : false
};
```

## Definition of Done

- [ ] Database is provisioned and accessible
- [ ] Local development can connect to a local or remote database
- [ ] Connection configuration is documented
- [ ] No credentials are committed to git

## Dependencies

- Heroku account with billing enabled
- Heroku CLI installed locally

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-05 | 1.0 | Story created | Mary (Analyst) |
