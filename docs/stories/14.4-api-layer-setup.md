# Story 14.4: API Layer Setup

## Status: Draft

## Story

**As a** developer,
**I want** to set up the backend API layer,
**so that** the game client can authenticate users and sync save data.

## Acceptance Criteria

1. Express.js API server is configured and deployable to Heroku
2. API routes are organized by feature (auth, sync)
3. JWT middleware validates access tokens on protected routes
4. CORS is configured to allow requests from game client origin
5. Error handling returns consistent JSON responses
6. Rate limiting prevents abuse
7. Health check endpoint exists for monitoring
8. Environment variables configure all secrets

## Tasks

- [ ] Set up Express.js project structure in `apps/api/` or `server/`
- [ ] Configure TypeScript for backend
- [ ] Implement JWT token generation and validation
- [ ] Create auth middleware for protected routes
- [ ] Set up CORS configuration
- [ ] Implement rate limiting middleware
- [ ] Create error handling middleware
- [ ] Add health check endpoint
- [ ] Configure Heroku Procfile for deployment
- [ ] Document API endpoints

## Technical Notes

### Project Structure

```
server/
├── src/
│   ├── index.ts              # Entry point
│   ├── config.ts             # Environment configuration
│   ├── db.ts                 # Database connection pool
│   ├── middleware/
│   │   ├── auth.ts           # JWT validation
│   │   ├── cors.ts           # CORS configuration
│   │   ├── rateLimit.ts      # Rate limiting
│   │   └── errorHandler.ts   # Error handling
│   ├── routes/
│   │   ├── auth.ts           # /api/auth/*
│   │   ├── sync.ts           # /api/sync/*
│   │   └── health.ts         # /api/health
│   ├── services/
│   │   ├── userService.ts    # User CRUD operations
│   │   ├── tokenService.ts   # JWT operations
│   │   └── saveService.ts    # Save data operations
│   └── types/
│       └── index.ts          # Shared types
├── package.json
├── tsconfig.json
└── Procfile
```

### Express Setup

```typescript
// src/index.ts
import express from 'express';
import cors from 'cors';
import helmet from 'helmet';
import { authRouter } from './routes/auth';
import { syncRouter } from './routes/sync';
import { healthRouter } from './routes/health';
import { errorHandler } from './middleware/errorHandler';
import { rateLimiter } from './middleware/rateLimit';
import { config } from './config';

const app = express();

// Security
app.use(helmet());
app.use(cors({
  origin: config.allowedOrigins,
  credentials: true
}));

// Parsing
app.use(express.json({ limit: '1mb' }));

// Rate limiting
app.use(rateLimiter);

// Routes
app.use('/api/health', healthRouter);
app.use('/api/auth', authRouter);
app.use('/api/sync', syncRouter);

// Error handling (must be last)
app.use(errorHandler);

const PORT = process.env.PORT || 3001;
app.listen(PORT, () => {
  console.log(`API server running on port ${PORT}`);
});
```

### JWT Configuration

```typescript
// src/services/tokenService.ts
import jwt from 'jsonwebtoken';
import { config } from '../config';

interface TokenPayload {
  userId: string;
  email: string;
}

export function generateAccessToken(payload: TokenPayload): string {
  return jwt.sign(payload, config.jwtSecret, { expiresIn: '15m' });
}

export function generateRefreshToken(payload: TokenPayload): string {
  return jwt.sign(payload, config.jwtRefreshSecret, { expiresIn: '7d' });
}

export function verifyAccessToken(token: string): TokenPayload {
  return jwt.verify(token, config.jwtSecret) as TokenPayload;
}
```

### Auth Middleware

```typescript
// src/middleware/auth.ts
import { Request, Response, NextFunction } from 'express';
import { verifyAccessToken } from '../services/tokenService';

export interface AuthRequest extends Request {
  user?: { userId: string; email: string };
}

export function authMiddleware(req: AuthRequest, res: Response, next: NextFunction) {
  const authHeader = req.headers.authorization;

  if (!authHeader?.startsWith('Bearer ')) {
    return res.status(401).json({ error: 'Missing authorization header' });
  }

  const token = authHeader.slice(7);

  try {
    const payload = verifyAccessToken(token);
    req.user = payload;
    next();
  } catch (err) {
    return res.status(401).json({ error: 'Invalid or expired token' });
  }
}
```

### API Endpoints Overview

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| GET | /api/health | No | Health check |
| POST | /api/auth/register | No | Create account |
| POST | /api/auth/login | No | Email/password login |
| POST | /api/auth/google | No | Google OAuth callback |
| POST | /api/auth/refresh | No | Refresh access token |
| POST | /api/auth/logout | Yes | Revoke refresh token |
| GET | /api/sync/pull | Yes | Get cloud save |
| POST | /api/sync/push | Yes | Upload save to cloud |

### Environment Variables

```bash
# .env
PORT=3001
DATABASE_URL=postgres://...
JWT_SECRET=your-256-bit-secret
JWT_REFRESH_SECRET=your-other-256-bit-secret
ALLOWED_ORIGINS=http://localhost:3000,https://sanctum-ruins.herokuapp.com
GOOGLE_CLIENT_ID=xxx
GOOGLE_CLIENT_SECRET=xxx
```

### Heroku Deployment

```yaml
# Procfile
web: node dist/index.js
```

```json
// package.json scripts
{
  "scripts": {
    "build": "tsc",
    "start": "node dist/index.js",
    "dev": "ts-node-dev src/index.ts"
  }
}
```

## Definition of Done

- [ ] API server starts and responds to health check
- [ ] Protected routes reject requests without valid JWT
- [ ] CORS allows requests from game client
- [ ] Rate limiting blocks excessive requests
- [ ] Error responses are consistent JSON format
- [ ] Deploys successfully to Heroku

## Dependencies

- Story 14.1 (Heroku Postgres Setup)
- Story 14.2 (Users & Auth Schema)
- Story 14.3 (Save Data Schema)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-05 | 1.0 | Story created | Mary (Analyst) |
