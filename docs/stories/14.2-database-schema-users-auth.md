# Story 14.2: Database Schema - Users & Auth

## Status: Draft

## Story

**As a** developer,
**I want** to create the database schema for users and authentication,
**so that** players can create accounts and log in securely.

## Acceptance Criteria

1. Users table stores account information (id, email, display_name, password_hash)
2. OAuth connections table links external providers to user accounts
3. Refresh tokens table stores valid refresh tokens for JWT auth
4. Passwords are hashed with bcrypt (12+ rounds)
5. Email addresses are unique and case-insensitive
6. Migration scripts can be run to create/update schema
7. Indexes exist for frequently queried columns

## Tasks

- [ ] Create migration file for users table
- [ ] Create migration file for oauth_connections table
- [ ] Create migration file for refresh_tokens table
- [ ] Add indexes for email, provider lookups
- [ ] Set up migration runner (node-pg-migrate or similar)
- [ ] Test migrations on local database
- [ ] Document rollback procedures

## Technical Notes

### Schema Definition

```sql
-- Migration: 001_create_users.sql

CREATE EXTENSION IF NOT EXISTS "pgcrypto";

CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE,
  email_lower VARCHAR(255) GENERATED ALWAYS AS (LOWER(email)) STORED,
  password_hash VARCHAR(255),
  display_name VARCHAR(100) NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE UNIQUE INDEX idx_users_email_lower ON users(email_lower);
CREATE INDEX idx_users_created_at ON users(created_at);

-- Migration: 002_create_oauth_connections.sql

CREATE TABLE oauth_connections (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  provider VARCHAR(50) NOT NULL,  -- 'google', 'discord', etc.
  provider_user_id VARCHAR(255) NOT NULL,
  provider_email VARCHAR(255),
  access_token TEXT,  -- Optional: for API calls to provider
  refresh_token TEXT, -- Optional: for refreshing provider token
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(provider, provider_user_id)
);

CREATE INDEX idx_oauth_user_id ON oauth_connections(user_id);
CREATE INDEX idx_oauth_provider_lookup ON oauth_connections(provider, provider_user_id);

-- Migration: 003_create_refresh_tokens.sql

CREATE TABLE refresh_tokens (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  token_hash VARCHAR(255) NOT NULL UNIQUE,
  expires_at TIMESTAMPTZ NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  revoked_at TIMESTAMPTZ
);

CREATE INDEX idx_refresh_tokens_user ON refresh_tokens(user_id);
CREATE INDEX idx_refresh_tokens_expires ON refresh_tokens(expires_at);
```

### Password Hashing

```typescript
import bcrypt from 'bcrypt';

const SALT_ROUNDS = 12;

export async function hashPassword(password: string): Promise<string> {
  return bcrypt.hash(password, SALT_ROUNDS);
}

export async function verifyPassword(password: string, hash: string): Promise<boolean> {
  return bcrypt.compare(password, hash);
}
```

### User Types

```typescript
interface User {
  id: string;
  email: string | null;
  displayName: string;
  createdAt: Date;
  updatedAt: Date;
}

interface OAuthConnection {
  id: string;
  userId: string;
  provider: 'google' | 'discord';
  providerUserId: string;
  providerEmail: string | null;
}
```

## Definition of Done

- [ ] All migrations run successfully on fresh database
- [ ] Migrations are idempotent (can run multiple times safely)
- [ ] Rollback scripts exist and work
- [ ] Schema matches TypeScript types
- [ ] Indexes verified with EXPLAIN ANALYZE

## Dependencies

- Story 14.1 (Heroku Postgres Setup)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-05 | 1.0 | Story created | Mary (Analyst) |
