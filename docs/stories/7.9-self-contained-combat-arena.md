# Story 7.9: Self-Contained Combat Arena for Landscape Mobile

## Status: Ready for Review

## Story

**As a** mobile player in landscape orientation,
**I want** all combat UI elements contained within the arena viewport,
**so that** the game scales properly to landscape mobile without off-screen elements.

## Acceptance Criteria

1. Player hand is permanently visible within the arena (bottom-right region)
2. End Turn button is prominently displayed within the arena
3. Settings gear button opens a menu containing Abandon Run option
4. Pile counters (Deck, Discard, Turn) display at the bottom of the arena
5. Combat log is collapsed by default with a button to expand/view
6. All combat controls are accessible without scrolling in landscape orientation
7. Existing portrait/desktop layouts continue to function (no regression)
8. Touch targets meet 44px minimum for mobile accessibility

## Tasks / Subtasks

- [x] Restructure arena HTML container (AC: 1, 2, 3, 4, 5)
  - [x] Move `.hand-area` inside `.arena-container`
  - [x] Move End Turn button inside `.arena-container`
  - [x] Move pile counters inside `.arena-container`
  - [x] Create collapsible combat log overlay
  - [x] Create settings menu modal with Abandon Run option

- [x] Update hand positioning (AC: 1, 8)
  - [x] Position hand in bottom-right of arena
  - [x] Style cards for arena-contained display
  - [x] Ensure horizontal scroll for many cards
  - [x] Maintain 44px+ touch targets

- [x] Implement pile counter display (AC: 4)
  - [x] Rename "Draw" to "Deck" in display
  - [x] Position counters at bottom of arena
  - [x] Style as compact, non-intrusive indicators

- [x] Implement settings menu (AC: 3)
  - [x] Create gear icon button in arena
  - [x] Build modal/dropdown with Abandon Run option
  - [x] Include any other combat settings (sound, etc.)
  - [x] Add close/dismiss functionality

- [x] Implement collapsible combat log (AC: 5)
  - [x] Create toggle button for log visibility
  - [x] Build slide-out or overlay log panel
  - [x] Preserve log functionality when expanded

- [x] Update End Turn button (AC: 2, 8)
  - [x] Position prominently within arena
  - [x] Ensure visibility doesn't conflict with hand/enemies
  - [x] Maintain existing styling/feedback

- [x] CSS layout updates (AC: 6, 7)
  - [x] Create landscape-specific layout within arena
  - [x] Ensure portrait mode still uses existing layout (or graceful fallback)
  - [x] Test desktop browser compatibility
  - [x] Use CSS Grid or Flexbox for arena internal layout

- [x] Update renderer.ts for new structure (AC: 1-6)
  - [x] Update DOM queries for relocated elements (no changes needed - IDs preserved)
  - [x] Ensure all event handlers still work
  - [x] Update any element positioning logic

- [x] Testing (AC: 6, 7, 8)
  - [x] Test landscape mobile viewport
  - [x] Test portrait mobile viewport
  - [x] Test desktop browser
  - [x] Verify touch target sizes
  - [x] Test with various hand sizes (1-10 cards)

## Dev Notes

### Current Structure (BEFORE)

```
#combat-screen
├── .arena-container
│   └── .dungeon-scene
│       ├── #enemy-slots
│       ├── .player-silhouette
│       ├── .potion-slots (already inside)
│       └── .player-hud (already inside)
├── .hand-header          ← OUTSIDE
├── .hand-area            ← OUTSIDE
├── .controls             ← OUTSIDE
└── .log-area             ← OUTSIDE
```

### Target Structure (AFTER)

```
#combat-screen
└── .arena-container
    └── .dungeon-scene
        ├── #enemy-slots
        ├── .player-silhouette
        ├── .potion-slots
        ├── .player-hud
        ├── .arena-hand (bottom-right)      ← MOVED INSIDE
        ├── .arena-controls                  ← MOVED INSIDE
        │   ├── #end-turn-btn
        │   └── .settings-gear → opens menu with Abandon
        ├── .pile-counters (bottom)          ← MOVED INSIDE
        │   ├── Deck count
        │   ├── Discard count
        │   └── Turn count
        └── .combat-log-toggle → expands log overlay
```

### Key Files to Modify

- `index.html` - Restructure DOM hierarchy
- `src/styles/main.css` - New arena-internal layout styles
- `src/ui/renderer.ts` - Update DOM queries and element references
- `src/main.ts` - Update any event handlers for relocated elements

### Layout Considerations

**Bottom-Right Hand Region:**
- Cards should fan horizontally
- Scroll if more than ~5 cards visible
- Should not overlap player HUD (bottom-left)
- Should not obscure enemy attacks/intents

**End Turn Button:**
- Consider bottom-center or right-side placement
- Must be easily reachable with thumb in landscape
- Visual prominence (size, color) maintained

**Pile Counters:**
- Compact display: "Deck: 15 | Discard: 8 | Turn: 3"
- Or icon-based: [deck icon] 15  [discard icon] 8
- Bottom edge, centered or left-aligned

**Settings Menu Content:**
- Abandon Run (with confirmation)
- Sound toggle (if applicable)
- Return to menu (same as abandon?)

### Existing Mobile CSS Reference

Lines 6856-7055 in main.css contain existing mobile landscape adaptations. These should be reviewed and potentially refactored to work with the new arena-contained structure.

### Testing Viewports

| Device | Orientation | Resolution |
|--------|-------------|------------|
| iPhone 14 Pro | Landscape | 932 x 430 |
| iPhone SE | Landscape | 667 x 375 |
| iPad | Landscape | 1024 x 768 |
| Desktop | N/A | 1920 x 1080 |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-06 | 1.0 | Initial story creation | Sarah (PO) |
| 2025-12-06 | 1.1 | Implementation complete | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### Debug Log References
N/A - No debug issues encountered

### Completion Notes List
- Restructured HTML to move all combat UI inside `.dungeon-scene`:
  - Created `.arena-hand` container for cards (bottom-right, position: absolute)
  - Created `.arena-controls` with End Turn button and settings gear
  - Created `.settings-menu` modal with Sound toggle, Abandon Run, and Close
  - Created `.pile-counters` (bottom-left) with Deck/Discard/Turn counts
  - Created `.combat-log-toggle` button and `.combat-log-panel` overlay
- Added ~290 lines of new CSS for arena-contained UI elements
- Updated main.ts with new event handlers:
  - Settings gear toggle
  - Settings menu options (sound, abandon, close)
  - Combat log toggle/close
  - Click-outside-to-close for settings menu
- Preserved all existing element IDs so renderer.ts required no changes
- Old UI elements (`.hand-header`, `.hand-area`, `.controls`, `.log-area`) hidden via CSS
- All touch targets meet 44px minimum (buttons are 48px)
- Build passes, all existing tests pass (1 pre-existing failure unrelated to this story)

### File List
- `index.html` - Restructured combat screen DOM hierarchy
- `src/styles/main.css` - Added arena-contained UI styles (lines 2784-3075)
- `src/main.ts` - Added settings menu and combat log event handlers

---

## QA Results

_To be filled by QA agent_
