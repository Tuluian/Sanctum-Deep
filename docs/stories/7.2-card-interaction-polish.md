# Story 7.2: Card Interaction Polish

## Status: Draft

## Story

**As a** player,
**I want** cards to feel like physical objects I'm manipulating,
**so that** the deck-building fantasy is immersive and satisfying.

## Problem Statement

Cards currently feel like flat UI buttons rather than tangible game pieces. The disconnect between "playing cards" conceptually and clicking buttons undermines the core deck-builder fantasy. Players should feel like they're handling a physical deck.

## Acceptance Criteria

1. Cards fan out naturally in hand with overlap
2. Hovering a card lifts it and reveals full details
3. Cards can be dragged to play (with snap-back if invalid)
4. Card draw animation shows cards arriving from deck
5. Discard animation shows cards leaving to discard pile
6. Exhaust animation is visually distinct from discard
7. Hand reorganizes smoothly when cards are added/removed
8. Card preview shows full card on long-press (mobile)

## UX Design Principles

### The "Physical Card" Fantasy

Players should feel like they're:
- Fanning through a hand of cards
- Lifting a card to examine it
- Throwing/playing a card at a target
- Watching their deck shuffle and deal

### Touch vs Mouse Considerations

| Action | Mouse | Touch |
|--------|-------|-------|
| Preview | Hover | Long-press |
| Select | Click | Tap |
| Play | Click/Drag | Drag + release |
| Cancel | Right-click/ESC | Drag back |

## Tasks / Subtasks

### Hand Layout & Fanning (AC: 1)

- [ ] Implement curved hand layout
  - [ ] Cards arranged in arc (like holding cards)
  - [ ] Center cards are straight, edges are angled
  - [ ] Overlap amount based on hand size
  - [ ] Maximum hand width constrained to viewport
- [ ] Dynamic spacing algorithm
  - [ ] 1-3 cards: No overlap, centered
  - [ ] 4-6 cards: Slight overlap (20%)
  - [ ] 7+ cards: Heavy overlap (40%), fan wider on hover
- [ ] Card rotation formula
  ```
  rotation = (index - center) * 3deg
  verticalOffset = |index - center| * 5px
  ```

### Card Hover State (AC: 2)

- [ ] Lift animation on hover
  - [ ] Card translates Y -40px
  - [ ] Card scales to 115%
  - [ ] Card z-index increases to top
  - [ ] Slight rotation correction (straightens)
- [ ] Adjacent cards react
  - [ ] Cards on either side shift away slightly
  - [ ] Creates "room" for hovered card
- [ ] Full card detail on hover
  - [ ] Card expands or tooltip shows full text
  - [ ] Damage numbers highlight if buffed/debuffed
  - [ ] Cost shows red if unaffordable
- [ ] Hover delay to prevent flicker
  - [ ] 100ms delay before lift animation
  - [ ] Immediate return on mouse leave

### Drag-to-Play (AC: 3)

- [ ] Implement drag mechanics
  - [ ] Card follows cursor/finger while dragging
  - [ ] Card remains at 115% scale during drag
  - [ ] Valid drop zones highlight
- [ ] Drop zone indicators
  - [ ] Enemy targets glow when attack card dragged
  - [ ] "Play zone" appears for non-targeted cards
  - [ ] Invalid zones show X cursor
- [ ] Snap-back animation
  - [ ] If dropped in invalid zone, card springs back
  - [ ] Use spring physics for natural feel
  - [ ] Duration: ~0.3s with overshoot
- [ ] Successful play animation
  - [ ] Card flies to target with acceleration
  - [ ] Particle trail during flight
  - [ ] Impact effect at destination

### Draw Animation (AC: 4)

- [ ] Cards dealt from draw pile position
  - [ ] Start position: Draw pile location
  - [ ] End position: Hand slot
  - [ ] Staggered timing: 0.1s between cards
- [ ] Deal animation properties
  - [ ] Arc trajectory (not straight line)
  - [ ] Card flips from back to front mid-flight
  - [ ] Landing has slight bounce
- [ ] Multiple draw optimization
  - [ ] Cards can overlap in flight
  - [ ] Total draw time capped at 0.8s regardless of count
- [ ] Draw sound
  - [ ] Card sliding sound
  - [ ] Slight pitch variation per card

### Discard Animation (AC: 5)

- [ ] Card flies to discard pile
  - [ ] Trajectory: Slight arc
  - [ ] Duration: 0.25s
  - [ ] Rotation: Slight spin during flight
- [ ] Discard pile visual
  - [ ] Stack of cards visible
  - [ ] Top card partially visible
  - [ ] Count number overlay
- [ ] Batch discard (end of turn)
  - [ ] Cards leave in quick succession
  - [ ] Satisfying "sweep" feel

### Exhaust Animation (AC: 6)

- [ ] Visually distinct from discard
  - [ ] Card burns/dissolves effect
  - [ ] Fire/smoke particles
  - [ ] Duration: 0.5s
- [ ] No destination (card disappears)
  - [ ] Fades into particles
  - [ ] Particles drift upward and fade
- [ ] Exhaust sound
  - [ ] Burning/whoosh sound
  - [ ] Distinct from discard shuffle

### Hand Reorganization (AC: 7)

- [ ] Smooth reflow on change
  - [ ] When card added: Others shift to make room
  - [ ] When card removed: Gap closes smoothly
  - [ ] Animation duration: 0.2s
- [ ] Maintain selection state
  - [ ] Selected card stays selected through reflow
  - [ ] Hover card stays highlighted
- [ ] Preserve player attention
  - [ ] Avoid jarring jumps
  - [ ] Telegraphing where new cards will go

### Mobile Long-Press Preview (AC: 8)

- [ ] Long-press detection (300ms)
  - [ ] Visual indicator: Card starts to lift
  - [ ] Cancel if finger moves before threshold
- [ ] Preview modal
  - [ ] Full-size card appears above finger
  - [ ] Dark overlay on rest of screen
  - [ ] Tap anywhere to dismiss
- [ ] No accidental plays
  - [ ] Long-press triggers preview, not play
  - [ ] Requires deliberate drag to play

## Dev Notes

### Card Layout Mathematics

```typescript
interface HandLayout {
  cards: CardPosition[];
}

interface CardPosition {
  x: number;
  y: number;
  rotation: number;
  scale: number;
  zIndex: number;
}

function calculateHandLayout(cardCount: number, containerWidth: number): HandLayout {
  const maxWidth = Math.min(containerWidth * 0.8, 800);
  const cardWidth = 100; // Base card width
  const overlap = cardCount > 6 ? 0.4 : cardCount > 3 ? 0.2 : 0;

  const totalWidth = cardWidth * cardCount * (1 - overlap);
  const startX = (containerWidth - totalWidth) / 2;
  const centerIndex = (cardCount - 1) / 2;

  return {
    cards: Array.from({ length: cardCount }, (_, i) => ({
      x: startX + i * cardWidth * (1 - overlap),
      y: Math.abs(i - centerIndex) * 5, // Arc
      rotation: (i - centerIndex) * 3, // Fan
      scale: 1,
      zIndex: i,
    })),
  };
}
```

### Drag System Architecture

```typescript
class CardDragSystem {
  private draggingCard: HTMLElement | null = null;
  private startPosition: { x: number; y: number } | null = null;
  private validTargets: HTMLElement[] = [];

  onDragStart(card: HTMLElement, event: PointerEvent): void {
    this.draggingCard = card;
    this.startPosition = { x: event.clientX, y: event.clientY };

    card.classList.add('dragging');
    this.highlightValidTargets(card.dataset.cardType);
  }

  onDragMove(event: PointerEvent): void {
    if (!this.draggingCard) return;

    const dx = event.clientX - this.startPosition!.x;
    const dy = event.clientY - this.startPosition!.y;

    this.draggingCard.style.transform = `translate(${dx}px, ${dy}px) scale(1.15)`;
  }

  onDragEnd(event: PointerEvent): void {
    const target = this.findDropTarget(event);

    if (target) {
      this.playCardAnimation(this.draggingCard!, target);
    } else {
      this.snapBackAnimation(this.draggingCard!);
    }

    this.cleanup();
  }

  private snapBackAnimation(card: HTMLElement): void {
    card.animate([
      { transform: card.style.transform },
      { transform: 'translate(0, 0) scale(1)', offset: 0.7 },
      { transform: 'translate(0, -5px) scale(1.02)', offset: 0.85 },
      { transform: 'translate(0, 0) scale(1)' }
    ], {
      duration: 300,
      easing: 'cubic-bezier(0.34, 1.56, 0.64, 1)'
    });
  }
}
```

### CSS Variables for Card States

```css
:root {
  /* Card dimensions */
  --card-width: 100px;
  --card-height: 140px;
  --card-border-radius: 8px;

  /* Hand layout */
  --hand-arc-height: 20px;
  --hand-fan-angle: 3deg;

  /* Hover state */
  --card-hover-lift: -40px;
  --card-hover-scale: 1.15;
  --card-hover-transition: 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);

  /* Drag state */
  --card-drag-scale: 1.15;
  --card-drag-shadow: 0 10px 40px rgba(0,0,0,0.4);
}

.card {
  transition: transform var(--card-hover-transition);
}

.card:hover {
  transform: translateY(var(--card-hover-lift)) scale(var(--card-hover-scale));
  z-index: 100;
}

.card.dragging {
  z-index: 1000;
  box-shadow: var(--card-drag-shadow);
  pointer-events: none;
}
```

### Draw Animation Sequence

```typescript
async function animateDrawCards(cards: Card[], handContainer: HTMLElement): Promise<void> {
  const drawPile = document.getElementById('draw-pile');
  const drawPileRect = drawPile.getBoundingClientRect();

  const animations = cards.map((card, index) => {
    const cardEl = createCardElement(card);
    cardEl.classList.add('drawing');

    // Start at draw pile
    cardEl.style.left = `${drawPileRect.left}px`;
    cardEl.style.top = `${drawPileRect.top}px`;

    handContainer.appendChild(cardEl);

    // Animate to hand position
    return new Promise<void>((resolve) => {
      setTimeout(() => {
        const targetPos = calculateCardPosition(index, cards.length);
        cardEl.animate([
          {
            left: `${drawPileRect.left}px`,
            top: `${drawPileRect.top}px`,
            transform: 'rotateY(180deg) scale(0.5)'
          },
          {
            left: `${targetPos.x}px`,
            top: `${targetPos.y - 20}px`,
            transform: 'rotateY(0deg) scale(1.05)',
            offset: 0.7
          },
          {
            left: `${targetPos.x}px`,
            top: `${targetPos.y}px`,
            transform: `rotateY(0deg) rotate(${targetPos.rotation}deg) scale(1)`
          }
        ], {
          duration: 400,
          easing: 'cubic-bezier(0.34, 1.56, 0.64, 1)',
          fill: 'forwards'
        }).onfinish = () => {
          cardEl.classList.remove('drawing');
          resolve();
        };
      }, index * 100); // Stagger
    });
  });

  await Promise.all(animations);
}
```

## Testing

### Test Scenarios

1. Hand with 1-3 cards displays centered, no overlap
2. Hand with 7+ cards compresses with readable overlap
3. Hover lifts card and shifts neighbors
4. Drag card to valid target plays it
5. Drag card to invalid area snaps back
6. Draw 5 cards shows staggered animation
7. Discard shows cards flying to pile
8. Exhaust shows burn animation
9. Mobile long-press shows preview
10. Touch drag works smoothly

### Performance Targets

- 60fps during all card animations
- No jank during hand reorganization
- Drag must feel instant (< 16ms input latency)
- Memory stable (no leaks from particle effects)

## Accessibility Considerations

- [ ] Keyboard play option (not just drag)
- [ ] Screen reader announces card details
- [ ] Reduced motion: Instant transitions instead of animations
- [ ] High contrast mode for card borders

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-04 | 1.0 | Initial story creation | Sally (UX) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_
