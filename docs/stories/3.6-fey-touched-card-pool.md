# Story 3.6: Fey-Touched Card Pool

## Status: Complete

## Story

**As a** Fey-Touched player,
**I want** a full pool of chaotic fey cards to discover during my run,
**so that** I can build diverse decks around Whimsy, transformation, and Luck manipulation.

---

## Narrative Context: Chaos as Identity

> *"I didn't choose any of this. Not the fairy ring. Not Oberon. Not the Sanctum. But you know what? Chaos cuts both ways. Let's make this everyone's problem."*

### Card Design Philosophy

Fey-Touched cards should feel like:
- Controlled chaos—unpredictable but embraceable
- Mischief with an edge
- Tricks that might be gifts... or traps
- The joy of not knowing what happens next

### Wren's Voice

Cards reflect Wren's sarcastic, defiant personality. They're an unwilling participant who's decided to have fun anyway. Every random outcome is either a middle finger to Oberon or an opportunity to make their own luck.

### Card Naming Convention

| Theme | Naming Pattern | Examples |
|-------|---------------|----------|
| Whimsy | Playful adjectives | "Wild," "Capricious," "Mischievous" |
| Luck | Fortune/chance terms | "Lucky," "Fortune," "Gambler's" |
| Fey | Nature/fairy imagery | "Pixie's," "Changeling," "Fairy Fire" |
| Chaos | Randomness references | "Probability Storm," "Reality Warp" |

---

## Card Flavor Text Guide

### Starter Deck Flavor

| Card | Flavor Text |
|------|-------------|
| **Fey Bolt** | *"Aim is a mortal concern. The bolt knows where it wants to go."* |
| **Glamour** | *"Reality is a suggestion. A polite one, but still."* |
| **Pixie's Gift** | *"The fey call it a gift. They have a strange sense of humor."* |
| **Trickster's Trade** | *"Fair trades are boring. Unfair trades are educational."* |

### Common Card Flavor (Embracing the Chaos)

| Card | Flavor Text |
|------|-------------|
| **Wild Strike** | *"Somewhere between 'ouch' and 'OW.' I'll find out when I hit."* |
| **Shifting Shield** | *"It's definitely block. Probably. Mostly."* |
| **Lucky Coin** | *"Oberon gave me this coin. It's probably cursed. But it's shiny."* |
| **Fey Fire** | *"Will it burn? Will it heal? Will it do something completely unexpected? Yes."* |
| **Mischief** | *"Oberon taught me this one. He regrets it now."* |
| **Borrowed Time** | *"The fey don't understand 'borrowing.' Neither does this spell."* |
| **Chaotic Bolt** | *"It hits something. Twice. The 'something' is a surprise."* |
| **Nature's Whim** | *"Nature giveth. Nature taketh away. Nature is having a laugh."* |
| **Gambler's Strike** | *"Fifty-fifty. Like my survival chances. Like my sense of direction."* |
| **Illusory Armor** | *"It's definitely real. Probably. I'm... mostly sure."* |
| **Fey Blessing** | *"Blessings from the fey are like their promises: technically fulfilled."* |
| **Changeling** | *"I'm this card now. Wait, no, now I'm this card. Hang on—"* |
| **Lucky Strike** | *"Make your own luck. Steal everyone else's. Same thing."* |
| **Trickster's Blade** | *"The blade goes where it wants. I just hold the handle."* |
| **Fortuitous Block** | *"Lucky blocks harder. That's... not how luck works. But here we are."* |

### Uncommon Card Flavor (The Fey Lord's Shadow)

| Card | Flavor Text |
|------|-------------|
| **Wild Magic** | *"Something good is about to happen. Or something bad. Definitely something."* |
| **Luck Surge** | *"Oberon's not watching for the next five seconds. Make them count."* |
| **Chaos Theory** | *"Mathematically speaking, I should be dead. Math is for mortals."* |
| **Probability Storm** | *"Hit them once. Hit them again. Maybe again? Let's find out!"* |
| **Fey Bargain** | *"You get to choose. Ha! Just kidding. They get to choose."* |
| **Fortune's Favor** | *"All my luck, all at once, all in. What's the worst that could happen?"* |
| **Reality Warp** | *"These are different cards now. Better cards? Worse cards? Cards."* |
| **Serendipity** | *"Happy accidents. Profitable chaos. Oberon's headache."* |

### Rare Card Flavor (Defying the Fey Lord)

| Card | Flavor Text |
|------|-------------|
| **Master of Chaos** | *"Double the chaos. Double the fun. Double the middle fingers to Oberon."* |
| **Wish** | *"The fey grant wishes. They twist them. Unless YOU'RE the fey. Plot twist."* |
| **Fey Lord's Gambit** | *"Oberon's favorite game. He always wins. Let's change that."* |

---

## Oberon's Whispers (Whimsy Triggers)

When Whimsy cards resolve, Lord Oberon may comment:

### On High Rolls (Good Outcomes)
- *"Hmm. Lucky. That can be fixed."*
- *"Interesting. You're learning to work the chaos. I'm not pleased."*
- *"A good outcome. I must be distracted. Don't get used to it."*

### On Low Rolls (Bad Outcomes)
- *"Oh dear. How unfortunate." [laughter]*
- *"The chaos knows its master. That would be me."*
- *"Did you expect the fey to be fair? Adorable."*

### On Transformation (Good)
- *"A gift. From me. ...What? I can be generous."*
- *"This card serves you better. For now. While I allow it."*

### On Transformation (Bad)
- *"Oops. My hand slipped."*
- *"That card was fine. This one is... also fine. Probably."*

### On Luck Spending
- *"Clever little mortal. I'm paying attention now."*
- *"You're using my own chaos against me. How tedious."*
- *"That luck was mine to give. Remember who's in charge."*

---

## The Fey Lord's Game

Oberon's presence should feel like a constant background threat:

### Low Luck (0-3)
Oberon is actively sabotaging:
- *"You have no luck. How sad. How intentional."*
- *"The universe is against you. The universe works for me."*

### Medium Luck (4-6)
Oberon is watching, waiting:
- *"Building luck, little mortal? I wonder what you'll do with it."*
- *"Save it. Spend it. Either way, I'm entertained."*

### High Luck (7-10)
Oberon is impressed... and threatened:
- *"So much luck. You might almost escape. Almost."*
- *"I don't like you having this much agency. Fix it or I will."*
- *"Fine. Have your luck. See if it saves you from HIM." (referring to the Hollow God)*

---

## Card Interactions with Narrative

### When Wren Uses "Wish"
The screen flickers. For one moment, Oberon's face appears—not laughing, but genuinely surprised:
> *"You... you're using MY power against ME?"*
>
> *[Pause.]*
>
> *"Well. That's new. I might actually respect you, little mortal."*
>
> *[The card resolves with guaranteed best outcome.]*
>
> *"Don't expect it again."*

### When "Fey Lord's Gambit" Rolls Maximum
> *"THIRTY DAMAGE? WITH MY OWN SPELL?"*
>
> *[Genuine rage.]*
>
> *"You were supposed to FAIL. This was SABOTAGE."*
>
> *[Wren's response:]*
>
> *"Chaos cuts both ways, your lordship."*

### When "Fey Lord's Gambit" Rolls Minimum
> *"There it is. The outcome I intended. Remember: you don't control the chaos."*
>
> *[Wren's response:]*
>
> *"Not yet."*

---

## Wren's Combat Barks

| Trigger | Dialogue |
|---------|----------|
| Combat start | *"Okay, let's see what chaos throws at us today."* |
| Whimsy (good) | *"Ha! Thanks for nothing, Oberon."* |
| Whimsy (bad) | *"Of course. Very funny."* |
| Lucky Coin played | *"Heads I win, tails Oberon loses."* |
| Reality Warp | *"New cards, who dis?"* |
| Low HP | *"This is fine. Everything is fine."* |
| Victory | *"Still here. Still annoying. Suck it, Oberon."* |

---

## The Whimsy Spectrum

Cards are designed with varying chaos levels:

### Controlled Chaos (Common)
Outcomes are always helpful, just varying in degree.
- Wild Strike: 5-9 damage (always damage, just how much?)
- Shifting Shield: 5-9 block (always block, just how much?)

### Helpful Chaos (Common/Uncommon)
Multiple possible good outcomes.
- Fey Fire: +4 damage OR heal 4 OR draw 1 (all helpful, different ways)
- Wild Magic: 15 damage OR 15 block OR draw 4 OR heal 15 (huge but random)

### Risky Chaos (Uncommon/Rare)
Possible bad outcomes make it a gamble.
- Fey Bargain: Good effect, but opponent chooses
- Illusory Armor: Maybe half your block
- Fey Lord's Gambit: You might hurt yourself

---

## Warden Dialogue (Fey-Touched Specific)

**On First Whimsy:**
> "Oberon's magic. It ripples through you. The chaos is his—but you're learning to surf it."

**On High Luck:**
> "You've accumulated fortune. The fey lord doesn't like that. He's watching more closely now."

**On Using Wish:**
> "You used a fey lord's power against his will. That's... impressive. And dangerous. He'll remember."

**On Victory:**
> "You turned chaos into victory. Oberon expected a pawn. You became a player. He's terrified of you now. He'll never admit it."

---

## Acceptance Criteria

1. Fey-Touched has 30 total cards (4 starter + 26 obtainable)
2. Cards distributed by rarity: 15 Common, 8 Uncommon, 3 Rare
3. Cards support archetypes: High Variance, Luck Manipulation, Transformation
4. Whimsy cards have varied and interesting random outcomes
5. Luck resource can be built and spent strategically
6. Transformation cards create interesting decision points

## Tasks / Subtasks

- [x] Design Common Fey-Touched cards (15 cards)
  - [x] **Wild Strike** (1 Resolve): Deal 5-9 damage
  - [x] **Shifting Shield** (1 Resolve): Gain 5-9 block
  - [x] **Lucky Coin** (0 Resolve): Gain 2 Luck
  - [x] **Fey Fire** (1 Resolve): Deal 6 damage. Whimsy: +4 damage OR heal 4 OR draw 1
  - [x] **Mischief** (1 Resolve): Whimsy: Enemy loses 5 block OR takes 5 damage OR is Impaired 1 turn
  - [x] **Borrowed Time** (1 Resolve): Draw 2 cards. Discard 1-2 cards randomly at end of turn
  - [x] **Chaotic Bolt** (1 Resolve): Deal 4 damage to a random enemy 2 times
  - [x] **Nature's Whim** (1 Resolve): Gain 4 block and 4 HP. Randomly lose one of them next turn
  - [x] **Gambler's Strike** (1 Resolve): Deal 3 damage. 50% chance to deal 3 more
  - [x] **Illusory Armor** (1 Resolve): Gain 10 block. 25% chance block is halved
  - [x] **Fey Blessing** (1 Resolve): Heal 3-7 HP
  - [x] **Changeling** (1 Resolve): Transform into a random Common card until played
  - [x] **Lucky Strike** (1 Resolve): Deal 5 damage. Gain 1 Luck
  - [x] **Trickster's Blade** (1 Resolve): Deal 7 damage. Randomly swap with a card from draw pile
  - [x] **Fortuitous Block** (1 Resolve): Gain 6 block. If Luck > 5, gain 6 more

- [x] Design Uncommon Fey-Touched cards (8 cards)
  - [x] **Wild Magic** (2 Resolve): Whimsy: Deal 15 damage OR Gain 15 block OR Draw 4 cards OR Heal 15 HP
  - [x] **Luck Surge** (1 Resolve): Gain 5 Luck. Next Whimsy is guaranteed best outcome
  - [x] **Chaos Theory** (2 Resolve, Power): At turn start, randomly gain: 2 damage, 2 block, or draw 1
  - [x] **Probability Storm** (2 Resolve): Deal 4 damage 3-5 times randomly
  - [x] **Fey Bargain** (1 Resolve): Choose: Gain 12 block OR Deal 12 damage (opponent chooses which you get)
  - [x] **Fortune's Favor** (1 Resolve): Spend all Luck. Gain 2 block and deal 2 damage per Luck spent
  - [x] **Reality Warp** (2 Resolve): Transform all cards in hand into random cards of same rarity
  - [x] **Serendipity** (2 Resolve, Power): Whenever you play a Whimsy card, gain 1 Luck

- [x] Design Rare Fey-Touched cards (3 cards)
  - [x] **Master of Chaos** (3 Resolve, Power): All Whimsy cards trigger twice
  - [x] **Wish** (4 Resolve, Exhaust): Choose any outcome from any Whimsy card in your deck
  - [x] **Fey Lord's Gambit** (2 Resolve): Deal 10-30 damage. Take 0-10 damage. Completely random

- [x] Implement additional Whimsy effects
  - [x] Multi-outcome Whimsy (3+ options)
  - [x] Negative possibility Whimsy (risk/reward)
  - [x] Scaling Whimsy (based on stats)
  - [x] Conditional Whimsy (different if Luck high)

- [x] Implement Luck-based mechanics
  - [x] Luck generation cards
  - [x] Luck spending for rerolls
  - [x] Luck thresholds for bonuses
  - [x] Luck-based scaling effects
  - [x] "Guaranteed best" outcome mechanic

- [x] Implement transformation system
  - [x] Transform card in hand
  - [x] Transform card in deck
  - [x] Temporary transformation (until played)
  - [x] Transform by rarity (same tier)
  - [x] Transform all cards effects

- [x] Implement chaos damage (random targets)
  - [x] Damage random enemy
  - [x] Damage random target (including self!)
  - [x] Multi-hit random targets

- [x] Write unit tests
  - [x] Test Whimsy outcome selection
  - [x] Test damage/block ranges
  - [x] Test Luck accumulation and spending
  - [x] Test transformation mechanics
  - [x] Test random target selection
  - [x] Test "guaranteed best" with Luck Surge

## Dev Notes

### Fey-Touched Archetypes

**High Roller Build**:
- Wild Magic, Fey Lord's Gambit, Probability Storm
- Embrace maximum variance for huge payoffs

**Luck Manipulation Build**:
- Lucky Coin, Luck Surge, Fortune's Favor
- Build Luck, spend for guaranteed outcomes

**Transformation Build**:
- Changeling, Reality Warp, Trickster's Trade
- Constantly changing deck composition

### Whimsy Outcome Design

```typescript
// Low variance (common cards)
const WILD_STRIKE: CardDefinition = {
  id: 'wild_strike',
  name: 'Wild Strike',
  type: CardType.ATTACK,
  cost: 1,
  description: 'Deal 5-9 damage.',
  effects: [{ type: EffectType.DAMAGE_RANGE, min: 5, max: 9 }]
};

// Multi-outcome (uncommon)
const WILD_MAGIC: CardDefinition = {
  id: 'wild_magic',
  name: 'Wild Magic',
  type: CardType.SKILL,
  cost: 2,
  description: 'Whimsy: Deal 15 damage OR Gain 15 block OR Draw 4 OR Heal 15.',
  whimsy: [
    { weight: 1, effects: [{ type: EffectType.DAMAGE, amount: 15 }], description: 'Deal 15 damage' },
    { weight: 1, effects: [{ type: EffectType.BLOCK, amount: 15 }], description: 'Gain 15 block' },
    { weight: 1, effects: [{ type: EffectType.DRAW, amount: 4 }], description: 'Draw 4 cards' },
    { weight: 1, effects: [{ type: EffectType.HEAL, amount: 15 }], description: 'Heal 15 HP' },
  ]
};

// High variance (rare)
const FEY_LORDS_GAMBIT: CardDefinition = {
  id: 'fey_lords_gambit',
  name: "Fey Lord's Gambit",
  type: CardType.ATTACK,
  cost: 2,
  description: 'Deal 10-30 damage. Take 0-10 damage.',
  effects: [
    { type: EffectType.DAMAGE_RANGE, min: 10, max: 30 },
    { type: EffectType.LOSE_HP_RANGE, min: 0, max: 10 }
  ]
};
```

### Luck System Details

```typescript
interface PlayerState {
  luck: number;      // Current Luck (0-10)
  maxLuck: number;   // Cap (default 10)
  guaranteedBest: boolean; // Next Whimsy = best outcome
}

// Luck Surge implementation
function playLuckSurge(): void {
  player.luck = Math.min(player.luck + 5, player.maxLuck);
  player.guaranteedBest = true;
}

// Modified Whimsy resolution
function resolveWhimsy(card: CardDefinition): WhimsyEffect {
  if (player.guaranteedBest) {
    player.guaranteedBest = false;
    return getBestOutcome(card.whimsy);
  }
  return getRandomOutcome(card.whimsy);
}

function getBestOutcome(outcomes: WhimsyEffect[]): WhimsyEffect {
  // Determine "best" based on current situation
  // High HP? Prefer damage. Low HP? Prefer heal/block
  return outcomes.reduce((best, current) => {
    return scoreOutcome(current) > scoreOutcome(best) ? current : best;
  });
}
```

### Transformation Implementation

```typescript
function transformCard(card: Card, targetRarity?: CardRarity): Card {
  const rarity = targetRarity || card.rarity;
  const pool = getCardsOfRarity(rarity, player.classId);
  const newCard = pool[Math.floor(Math.random() * pool.length)];

  return {
    ...newCard,
    instanceId: `transformed_${Date.now()}`,
    transformed: true,
    originalCard: card.id
  };
}

// Temporary transformation
interface Card {
  // ... existing
  transformedUntilPlayed?: boolean;
  originalDefinition?: CardDefinition;
}
```

### Variance Analysis

| Card | Best Case | Worst Case | Average | Risk |
|------|-----------|------------|---------|------|
| Wild Strike | 9 dmg | 5 dmg | 7 dmg | Low |
| Wild Magic | 15 dmg/block/heal | Wrong type | Varies | Medium |
| Fey Lord's Gambit | 30 dmg, 0 self | 10 dmg, 10 self | 20/5 | High |

The Fey-Touched rewards players who can evaluate risk and adapt to outcomes.

## Testing

### Test File Location
`src/tests/cards/FeyTouchedCards.test.ts`

### Key Test Scenarios

1. **Range Damage**: Values within min-max
2. **Multi-Outcome**: All outcomes possible
3. **Luck Generation**: Caps at max
4. **Luck Spending**: Correct costs
5. **Guaranteed Best**: Luck Surge works
6. **Transformation**: Creates valid cards
7. **Random Targets**: All enemies possible

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-03 | 1.0 | Initial story creation | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- All 361 tests passing (including 39 new Fey-Touched card pool tests)
- No TypeScript errors

### Completion Notes List
1. Implemented 26 obtainable cards (15 Common, 8 Uncommon, 3 Rare)
2. Added new EffectTypes for Fey-Touched mechanics:
   - DAMAGE_RANDOM_ENEMY: Deal damage to a random enemy
   - BLOCK_IF_LUCK: Bonus block if Luck > 5
   - SPEND_ALL_LUCK: Convert Luck to damage and block
   - SET_GUARANTEED_BEST: Next Whimsy guarantees best outcome
3. Added guaranteedBest property to PlayerState
4. Implemented guaranteed best Whimsy resolution logic
5. Created getBestWhimsyIndex helper to score outcomes
6. Added diverse Whimsy cards with:
   - Range-based outcomes (5-9 damage/block)
   - Multi-outcome choices (3-4 options)
   - Risk/reward mechanics (Fey Lord's Gambit)
   - Weighted probability (Illusory Armor 75%/25%)
7. Luck mechanics implemented:
   - Generation (Lucky Coin, Lucky Strike, Luck Surge)
   - Threshold bonuses (Fortuitous Block)
   - Spending (Fortune's Favor)
   - Guaranteed best outcome (Luck Surge)
8. Power cards for passive effects (Serendipity, Chaos Theory, Master of Chaos)

### File List
- `src/types/index.ts` - Added new EffectTypes, guaranteedBest to PlayerState
- `src/data/cards/fey_touched.ts` - Added 26 cards (15 Common, 8 Uncommon, 3 Rare)
- `src/engine/CombatEngine.ts` - Added Fey-Touched effect handlers, guaranteed best Whimsy logic
- `src/data/fey-touched-cards.test.ts` - NEW: 39 tests for Fey-Touched card pool

---

## QA Results
_To be filled by QA agent_
