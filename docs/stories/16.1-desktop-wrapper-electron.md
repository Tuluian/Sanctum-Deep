# Story 16.1: Desktop Wrapper (Electron)

## Status: Draft

## Story

**As a** developer preparing for Steam,
**I want** to package Sanctum Ruins as a desktop application,
**so that** it can be distributed on Steam and run natively on Windows/macOS/Linux.

## Acceptance Criteria

1. Electron configured and running the game
2. Builds produced for Windows (.exe), macOS (.app), Linux (.AppImage)
3. Game window properly sized and configured
4. All game functionality works in Electron
5. Application has proper icons and metadata
6. Build size is reasonable (<200MB)
7. Auto-updater foundation in place

## Offline Work Tasks

All tasks can be done offline with local testing.

### 1. Set Up Electron (1 hour)

Create the Electron structure:

```bash
mkdir electron
```

Create `electron/main.js`:

```javascript
const { app, BrowserWindow, Menu } = require('electron');
const path = require('path');

// Handle creating/removing shortcuts on Windows when installing/uninstalling
if (require('electron-squirrel-startup')) app.quit();

let mainWindow;

function createWindow() {
  mainWindow = new BrowserWindow({
    width: 1280,
    height: 720,
    minWidth: 800,
    minHeight: 600,
    title: 'Sanctum Ruins',
    icon: path.join(__dirname, '../public/icons/icon-512x512.png'),
    webPreferences: {
      nodeIntegration: false,
      contextIsolation: true,
      // If you need Node.js features, use preload script
      // preload: path.join(__dirname, 'preload.js')
    },
    backgroundColor: '#1a1a2e',
    show: false, // Show when ready to prevent flash
  });

  // Load the game
  if (process.env.NODE_ENV === 'development') {
    mainWindow.loadURL('http://localhost:3000');
    mainWindow.webContents.openDevTools();
  } else {
    mainWindow.loadFile(path.join(__dirname, '../dist/index.html'));
  }

  // Show window when ready
  mainWindow.once('ready-to-show', () => {
    mainWindow.show();
  });

  // Remove default menu (or customize it)
  Menu.setApplicationMenu(null);

  mainWindow.on('closed', () => {
    mainWindow = null;
  });
}

app.whenReady().then(createWindow);

app.on('window-all-closed', () => {
  if (process.platform !== 'darwin') {
    app.quit();
  }
});

app.on('activate', () => {
  if (BrowserWindow.getAllWindows().length === 0) {
    createWindow();
  }
});
```

### 2. Configure package.json (30 min)

Add Electron dependencies and scripts:

```json
{
  "main": "electron/main.js",
  "scripts": {
    "electron:dev": "npm run dev & electron .",
    "electron:build": "npm run build && electron-builder",
    "electron:build:win": "npm run build && electron-builder --win",
    "electron:build:mac": "npm run build && electron-builder --mac",
    "electron:build:linux": "npm run build && electron-builder --linux"
  },
  "devDependencies": {
    "electron": "^28.0.0",
    "electron-builder": "^24.9.0"
  },
  "build": {
    "appId": "com.sanctumruins.game",
    "productName": "Sanctum Ruins",
    "directories": {
      "output": "release"
    },
    "files": [
      "dist/**/*",
      "electron/**/*",
      "public/icons/**/*"
    ],
    "win": {
      "target": ["nsis", "portable"],
      "icon": "public/icons/icon-512x512.png"
    },
    "mac": {
      "target": ["dmg", "zip"],
      "icon": "public/icons/icon-512x512.png",
      "category": "public.app-category.games"
    },
    "linux": {
      "target": ["AppImage", "deb"],
      "icon": "public/icons/icon-512x512.png",
      "category": "Game"
    },
    "nsis": {
      "oneClick": false,
      "allowToChangeInstallationDirectory": true,
      "installerIcon": "public/icons/icon-512x512.png"
    }
  }
}
```

### 3. Fix Path Issues for Electron (30 min)

Electron serves files from local filesystem, not HTTP. Ensure:

1. All asset paths use relative paths (not absolute `/images/...`)
2. Update `vite.config.ts`:

```typescript
export default defineConfig({
  base: './', // Use relative paths for Electron compatibility
  // ... rest of config
});
```

3. Check all image/audio references in code use relative paths

### 4. Create Preload Script (Optional) (30 min)

If you need Node.js features (file system, etc.), create `electron/preload.js`:

```javascript
const { contextBridge, ipcRenderer } = require('electron');

// Expose safe APIs to renderer
contextBridge.exposeInMainWorld('electron', {
  // Example: Save game to file
  saveToFile: (data) => ipcRenderer.invoke('save-to-file', data),
  loadFromFile: () => ipcRenderer.invoke('load-from-file'),

  // Platform info
  platform: process.platform,

  // App version
  getVersion: () => ipcRenderer.invoke('get-version'),
});
```

### 5. Create Application Icons (1 hour)

Electron needs specific icon formats:

**Windows**: `.ico` file (multi-resolution)
- Create from 256x256 PNG
- Tool: https://convertico.com/

**macOS**: `.icns` file
- Create from 1024x1024 PNG
- Tool: Use `iconutil` on macOS or online converters

**Linux**: PNG (512x512 works)

Place in:
- `public/icons/icon.ico` (Windows)
- `public/icons/icon.icns` (macOS)
- `public/icons/icon-512x512.png` (Linux)

### 6. Test Locally (30 min)

```bash
# Install dependencies
npm install electron electron-builder --save-dev

# Run in development
npm run electron:dev

# Test production build
npm run build
npm run electron:build
```

Test the built app in `release/` folder.

### 7. Window Configuration Options (15 min)

Consider these enhancements:

```javascript
// Fullscreen toggle (F11)
mainWindow.webContents.on('before-input-event', (event, input) => {
  if (input.key === 'F11') {
    mainWindow.setFullScreen(!mainWindow.isFullScreen());
  }
});

// Remember window size
const windowStateKeeper = require('electron-window-state');
let mainWindowState = windowStateKeeper({
  defaultWidth: 1280,
  defaultHeight: 720
});
```

### 8. Build Size Optimization (30 min)

Electron bundles Chromium (~150MB). To reduce:

1. Use `electron-builder` with:
```json
{
  "build": {
    "asar": true,
    "compression": "maximum"
  }
}
```

2. Exclude unnecessary files:
```json
{
  "files": [
    "!**/*.map",
    "!**/node_modules/**/*.md",
    "!**/node_modules/**/*.ts"
  ]
}
```

Expected sizes:
- Windows: ~180MB installer
- macOS: ~200MB dmg
- Linux: ~180MB AppImage

## Dev Notes

### Development Workflow
1. Run `npm run dev` for Vite dev server
2. In another terminal, run `npx electron .`
3. Hot reload works for web content
4. Restart Electron for main process changes

### Debugging
- DevTools: Press F12 or add in code
- Main process logs: Terminal where Electron runs
- Renderer process: DevTools console

### Common Issues
- **White screen**: Check file paths (relative vs absolute)
- **CORS errors**: Shouldn't happen with file:// protocol
- **Missing images**: Verify build includes all assets

### Future Improvements
- Add auto-updater for Steam/non-Steam versions
- Add crash reporter
- Add analytics (if desired)

### Relevant Files
- `electron/main.js` (new)
- `electron/preload.js` (new, optional)
- `package.json` (modify)
- `vite.config.ts` (modify base path)
- `public/icons/` (add .ico, .icns)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-05 | 1.0 | Initial story creation | John (PM) |
