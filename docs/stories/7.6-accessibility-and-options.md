# Story 7.6: Accessibility & Player Options

## Status: In Progress

## Story

**As a** player with different abilities or preferences,
**I want** robust accessibility options and customization,
**so that** I can enjoy the game regardless of my needs.

## Problem Statement

Games often exclude players with visual, motor, or cognitive differences. Beyond accessibility, players have diverse preferences for animation speed, audio, visual intensity, and input methods. A truly engaging game welcomes everyone.

## Acceptance Criteria

1. Colorblind mode with accessible palette
2. Screen reader support for critical information
3. Keyboard-only navigation fully functional
4. Reduced motion mode disables animations
5. Scalable UI for visual impairment
6. Adjustable game speed
7. Audio description for key events
8. Save/load settings persist across sessions

## Accessibility Standards Reference

### WCAG 2.1 Relevant Guidelines

- **1.4.1** Color is not the only visual means of conveying information
- **1.4.3** Contrast ratio of at least 4.5:1 for normal text
- **1.4.4** Text can be resized up to 200% without loss of functionality
- **2.1.1** All functionality available from keyboard
- **2.3.1** No content flashes more than 3 times per second
- **2.4.7** Visible focus indicator

## Tasks / Subtasks

### Colorblind Mode (AC: 1)

- [ ] Research colorblind-safe palette
  - [ ] Deuteranopia (red-green, most common)
  - [ ] Protanopia (red-green)
  - [ ] Tritanopia (blue-yellow)
- [ ] Implement colorblind alternatives
  - [ ] Card type identification (icons + patterns, not just color)
  - [ ] Damage types (shapes + colors)
  - [ ] Status effects (icons mandatory, color supplementary)
  - [ ] HP bar (pattern overlay option)
- [ ] Add colorblind toggle in settings
  - [ ] Option: Off / Deuteranopia / Protanopia / Tritanopia
  - [ ] Apply CSS filter + icon changes
- [ ] Test with colorblind simulation tools

### Screen Reader Support (AC: 2)

- [ ] Add ARIA labels to all interactive elements
  - [ ] Buttons: `aria-label="Play card: Smite, costs 1 Resolve, deals 5 damage"`
  - [ ] Enemies: `aria-label="Cultist, 20 of 30 HP, intends to attack for 6"`
  - [ ] Player stats: `aria-label="Player HP: 50 of 75, Block: 5"`
- [ ] Implement live regions for updates
  - [ ] Combat log as `aria-live="polite"`
  - [ ] HP changes as `aria-live="assertive"`
  - [ ] Turn announcements
- [ ] Focus management
  - [ ] Logical focus order
  - [ ] Focus trap in modals
  - [ ] Return focus after dialog close
- [ ] Screen reader testing
  - [ ] Test with NVDA (Windows)
  - [ ] Test with VoiceOver (Mac/iOS)

### Keyboard Navigation (AC: 3)

- [ ] Full keyboard control scheme
  - [ ] Tab: Cycle through interactive elements
  - [ ] Enter/Space: Activate focused element
  - [ ] Arrow keys: Navigate within groups (cards, enemies)
  - [ ] Escape: Cancel/back
  - [ ] Number keys: Quick-play cards (1-9)
  - [ ] E: End turn
  - [ ] H: Open help
  - [ ] M: Toggle map (during runs)
- [ ] Visual focus indicators
  - [ ] Clear outline on focused elements
  - [ ] High contrast focus ring
  - [ ] Focus visible even over complex backgrounds
- [ ] Focus shortcuts
  - [ ] F1: Focus hand
  - [ ] F2: Focus enemies
  - [ ] F3: Focus player stats
  - [ ] F4: Focus End Turn button

### Reduced Motion Mode (AC: 4)

- [ ] Detect `prefers-reduced-motion` media query
- [ ] Disable animations when active
  - [ ] Card play: Instant play instead of animation
  - [ ] Screen shake: Disabled
  - [ ] Enemy animations: Static pose
  - [ ] Transitions: Instant or very short fade
- [ ] Manual toggle in settings
  - [ ] Override system preference
- [ ] Ensure no functionality lost
  - [ ] Information still conveyed without motion
  - [ ] Game fully playable

### Scalable UI (AC: 5)

- [ ] Implement UI scale option
  - [ ] Range: 80% to 150%
  - [ ] Affects all UI elements proportionally
- [ ] Large text mode
  - [ ] Increases base font size
  - [ ] Card text more readable
  - [ ] Tooltip text larger
- [ ] High contrast mode
  - [ ] Increases contrast on all elements
  - [ ] Sharper borders
  - [ ] Brighter important information
- [ ] Use relative units (em, rem)
  - [ ] Avoid fixed pixel sizes where possible
  - [ ] Respect browser text size settings

### Adjustable Game Speed (AC: 6)

- [ ] Animation speed setting
  - [ ] 0.5x: Slow (more time to process)
  - [ ] 1x: Normal
  - [ ] 1.5x: Fast
  - [ ] 2x: Very fast
  - [ ] Instant: No animations
- [ ] Apply to all timed elements
  - [ ] Card animations
  - [ ] Enemy actions
  - [ ] Turn transitions
  - [ ] Status effect applications
- [ ] Turn timer option (future)
  - [ ] No time limit (default)
  - [ ] Relaxed timer (120s)
  - [ ] Normal timer (60s)

### Audio Description (AC: 7)

- [ ] Implement audio cue system
  - [ ] Turn start chime
  - [ ] Card type sounds (attack, skill, power distinct)
  - [ ] Damage dealt sound
  - [ ] Block sound
  - [ ] Low HP warning
  - [ ] Enemy death sound
  - [ ] Victory/defeat fanfares
- [ ] Optional text-to-speech
  - [ ] Read card names aloud on hover
  - [ ] Announce enemy intents
  - [ ] Narrate combat log (optional)
- [ ] Audio balance
  - [ ] Separate sliders for music, SFX, voice
  - [ ] Mono audio option (for hearing-impaired)

### Settings Persistence (AC: 8)

- [ ] Save all accessibility settings to localStorage
- [ ] Load settings on game start
- [ ] Export/import settings option
  - [ ] Copy settings as JSON
  - [ ] Paste settings from JSON
- [ ] Reset to defaults button
  - [ ] Confirm before reset
- [ ] Cloud sync for logged-in users (future)

## Dev Notes

### CSS Custom Properties for Accessibility

```css
:root {
  /* Base scale */
  --ui-scale: 1;
  --base-font-size: 16px;

  /* Animation speed multiplier */
  --anim-speed: 1;

  /* Color palette - default */
  --color-attack: #e74c3c;
  --color-skill: #3498db;
  --color-power: #9b59b6;
  --color-damage: #ff6b6b;
  --color-heal: #2ecc71;
  --color-block: #6495ed;

  /* Focus */
  --focus-ring: 0 0 0 3px gold;
}

/* High contrast mode */
body.high-contrast {
  --color-attack: #ff0000;
  --color-skill: #0066ff;
  --color-power: #9900ff;
  --focus-ring: 0 0 0 4px #ffffff;
}

/* Colorblind modes */
body.colorblind-deuteranopia {
  --color-attack: #d55e00;   /* Orange */
  --color-skill: #0072b2;    /* Blue */
  --color-damage: #d55e00;
  --color-heal: #009e73;     /* Teal */
}

body.colorblind-tritanopia {
  --color-attack: #d55e00;
  --color-skill: #cc79a7;    /* Pink */
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

body.reduced-motion *,
body.reduced-motion *::before,
body.reduced-motion *::after {
  animation-duration: 0.01ms !important;
  animation-iteration-count: 1 !important;
  transition-duration: 0.01ms !important;
}

/* Focus visible */
*:focus-visible {
  outline: none;
  box-shadow: var(--focus-ring);
}

/* Large text mode */
body.large-text {
  --base-font-size: 20px;
}

/* UI scaling */
#game-container {
  font-size: calc(var(--base-font-size) * var(--ui-scale));
}
```

### Accessibility Settings Interface

```typescript
interface AccessibilitySettings {
  // Visual
  colorblindMode: 'off' | 'deuteranopia' | 'protanopia' | 'tritanopia';
  highContrast: boolean;
  uiScale: number; // 0.8 - 1.5
  largeText: boolean;

  // Motion
  reducedMotion: boolean;
  animationSpeed: 0.5 | 1 | 1.5 | 2 | 0; // 0 = instant

  // Audio
  screenReaderMode: boolean;
  textToSpeech: boolean;
  monoAudio: boolean;

  // Input
  keyboardOnly: boolean;
}

const DEFAULT_ACCESSIBILITY: AccessibilitySettings = {
  colorblindMode: 'off',
  highContrast: false,
  uiScale: 1,
  largeText: false,
  reducedMotion: window.matchMedia('(prefers-reduced-motion: reduce)').matches,
  animationSpeed: 1,
  screenReaderMode: false,
  textToSpeech: false,
  monoAudio: false,
  keyboardOnly: false,
};

class AccessibilityService {
  private settings: AccessibilitySettings;

  constructor() {
    this.settings = this.loadSettings();
    this.applySettings();
    this.detectSystemPreferences();
  }

  private detectSystemPreferences(): void {
    // Detect reduced motion preference
    const motionQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
    motionQuery.addEventListener('change', (e) => {
      this.set('reducedMotion', e.matches);
    });

    // Detect high contrast preference
    const contrastQuery = window.matchMedia('(prefers-contrast: high)');
    contrastQuery.addEventListener('change', (e) => {
      this.set('highContrast', e.matches);
    });
  }

  set<K extends keyof AccessibilitySettings>(
    key: K,
    value: AccessibilitySettings[K]
  ): void {
    this.settings[key] = value;
    this.saveSettings();
    this.applySettings();
  }

  private applySettings(): void {
    const body = document.body;
    const root = document.documentElement;

    // Colorblind mode
    body.classList.remove('colorblind-deuteranopia', 'colorblind-protanopia', 'colorblind-tritanopia');
    if (this.settings.colorblindMode !== 'off') {
      body.classList.add(`colorblind-${this.settings.colorblindMode}`);
    }

    // High contrast
    body.classList.toggle('high-contrast', this.settings.highContrast);

    // Large text
    body.classList.toggle('large-text', this.settings.largeText);

    // Reduced motion
    body.classList.toggle('reduced-motion', this.settings.reducedMotion);

    // UI scale
    root.style.setProperty('--ui-scale', String(this.settings.uiScale));

    // Animation speed
    root.style.setProperty('--anim-speed', String(this.settings.animationSpeed || 0.01));
  }
}
```

### ARIA Labels for Cards

```typescript
function getCardAriaLabel(card: Card, isPlayable: boolean): string {
  const playableStatus = isPlayable ? 'Playable' : 'Cannot afford';
  const costText = `costs ${card.cost} Resolve`;
  const effectText = describeCardEffects(card);

  return `${card.name}, ${card.type} card, ${costText}. ${effectText}. ${playableStatus}.`;
}

function describeCardEffects(card: Card): string {
  return card.effects.map(effect => {
    switch (effect.type) {
      case EffectType.DAMAGE:
        return `Deals ${effect.amount} damage`;
      case EffectType.BLOCK:
        return `Grants ${effect.amount} Block`;
      case EffectType.HEAL:
        return `Heals ${effect.amount} HP`;
      // ... etc
      default:
        return card.description;
    }
  }).join('. ');
}
```

### Keyboard Navigation Handler

```typescript
class KeyboardNavigator {
  private currentFocusGroup: 'hand' | 'enemies' | 'controls' = 'hand';
  private focusIndex = 0;

  constructor() {
    document.addEventListener('keydown', this.handleKeyDown.bind(this));
  }

  private handleKeyDown(e: KeyboardEvent): void {
    // Don't intercept if in input field
    if (e.target instanceof HTMLInputElement) return;

    switch (e.key) {
      case 'Tab':
        e.preventDefault();
        this.cycleFocusGroup(e.shiftKey ? -1 : 1);
        break;

      case 'ArrowLeft':
      case 'ArrowUp':
        e.preventDefault();
        this.moveFocus(-1);
        break;

      case 'ArrowRight':
      case 'ArrowDown':
        e.preventDefault();
        this.moveFocus(1);
        break;

      case 'Enter':
      case ' ':
        e.preventDefault();
        this.activateFocused();
        break;

      case 'e':
      case 'E':
        if (!e.ctrlKey && !e.metaKey) {
          e.preventDefault();
          this.endTurn();
        }
        break;

      case '1': case '2': case '3': case '4':
      case '5': case '6': case '7': case '8': case '9':
        e.preventDefault();
        this.quickPlayCard(parseInt(e.key) - 1);
        break;

      case 'F1':
        e.preventDefault();
        this.focusGroup('hand');
        break;

      case 'F2':
        e.preventDefault();
        this.focusGroup('enemies');
        break;

      case 'Escape':
        e.preventDefault();
        this.handleEscape();
        break;
    }
  }

  private cycleFocusGroup(direction: number): void {
    const groups: typeof this.currentFocusGroup[] = ['hand', 'enemies', 'controls'];
    const currentIndex = groups.indexOf(this.currentFocusGroup);
    const nextIndex = (currentIndex + direction + groups.length) % groups.length;
    this.focusGroup(groups[nextIndex]);
  }

  private focusGroup(group: typeof this.currentFocusGroup): void {
    this.currentFocusGroup = group;
    this.focusIndex = 0;
    this.updateFocus();
  }

  private moveFocus(direction: number): void {
    const elements = this.getFocusableElements();
    this.focusIndex = Math.max(0, Math.min(elements.length - 1, this.focusIndex + direction));
    this.updateFocus();
  }

  private updateFocus(): void {
    const elements = this.getFocusableElements();
    elements[this.focusIndex]?.focus();
  }

  private getFocusableElements(): HTMLElement[] {
    switch (this.currentFocusGroup) {
      case 'hand':
        return Array.from(document.querySelectorAll('#hand .card:not(.unplayable)'));
      case 'enemies':
        return Array.from(document.querySelectorAll('.enemy:not(.dead)'));
      case 'controls':
        return Array.from(document.querySelectorAll('.controls button:not([disabled])'));
      default:
        return [];
    }
  }
}
```

## Testing

### Test Scenarios

1. **Colorblind mode**: All card types distinguishable without relying on color alone
2. **Screen reader**: Can navigate and play combat with screen reader only
3. **Keyboard**: Complete a combat encounter using only keyboard
4. **Reduced motion**: All animations disabled, game fully functional
5. **UI scale**: Scale to 150%, all UI remains usable
6. **Game speed**: Play at 0.5x and 2x speed
7. **Audio cues**: All critical events have distinct sounds
8. **Settings persist**: Change settings, reload game, settings preserved

### Accessibility Testing Tools

- [ ] aXe browser extension
- [ ] WAVE evaluation tool
- [ ] Color contrast analyzer
- [ ] Screen reader testing (NVDA, VoiceOver)
- [ ] Keyboard-only navigation testing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-04 | 1.0 | Initial story creation | Sally (UX) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_
