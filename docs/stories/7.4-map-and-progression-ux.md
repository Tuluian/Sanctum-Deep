# Story 7.4: Map & Progression UX

## Status: Draft

## Story

**As a** player,
**I want** the map to feel like a journey through a dangerous dungeon,
**so that** each decision feels meaningful and the descent feels epic.

## Problem Statement

The current map is functional but feels like a flowchart rather than an adventure. Players should feel the weight of path choices, the relief of reaching rest nodes, and the dread of approaching the boss. The map should tell a visual story of the player's journey.

## Acceptance Criteria

1. Map has environmental theming per act
2. Visited nodes show journey breadcrumb trail
3. Node types have distinct, attractive icons
4. Path preview shows potential rewards/challenges
5. Current position is prominently highlighted
6. Boss approach builds tension
7. Map scroll and zoom is smooth
8. Touch gestures work intuitively on mobile

## UX Design Goals

### The "Journey" Fantasy

- Each node is a location, not just a button
- The path taken tells a story
- Unknown nodes create mystery
- Boss looms at the end, always visible

### Decision Clarity

Players should understand:
- What happens at each node type
- Which paths are available
- What they're giving up by choosing a path
- How far to the boss

## Tasks / Subtasks

### Act-Based Environmental Theming (AC: 1)

- [ ] Define visual themes per act
  - [ ] Act 1 (Sanctum Depths): Stone corridors, torchlight, cobwebs
  - [ ] Act 2 (Flooded Halls): Water, coral, bioluminescence
  - [ ] Act 3 (Void Breach): Reality tears, cosmic horror, instability
- [ ] Background parallax layers
  - [ ] Far layer: Distant environment
  - [ ] Mid layer: Architectural elements
  - [ ] Near layer: Foreground details
- [ ] Map path styling per act
  - [ ] Act 1: Stone pathways
  - [ ] Act 2: Wooden bridges over water
  - [ ] Act 3: Floating stepping stones
- [ ] Transition between acts
  - [ ] Visual "descending deeper" moment
  - [ ] New theme reveal

### Journey Trail Visualization (AC: 2)

- [ ] Breadcrumb path rendering
  - [ ] Solid line connecting visited nodes
  - [ ] Line color: Gold/bright
  - [ ] Line animation: Subtle pulse
- [ ] Footprint markers (optional)
  - [ ] Small footprint icons along path
  - [ ] Fade toward older nodes
- [ ] Node visited state
  - [ ] Checkmark or completion indicator
  - [ ] Dimmed but visible
  - [ ] Shows what was obtained (icon)
- [ ] Current position trail glow
  - [ ] Light trail from start to current
  - [ ] Particles along recent path

### Node Type Visual Design (AC: 3)

- [ ] Redesign node icons with location feel
  - [ ] Combat: Crossed swords at arena entrance
  - [ ] Elite: Skull banner marking danger
  - [ ] Rest: Campfire with warm glow
  - [ ] Merchant: Shop stall with goods
  - [ ] Shrine: Glowing altar
  - [ ] Boss: Massive door with ominous symbols
  - [ ] Unknown: Fog-shrouded mystery
- [ ] Node size hierarchy
  - [ ] Standard combat: Small
  - [ ] Elite/Rest/Shop: Medium
  - [ ] Boss: Large
- [ ] Interactive states
  - [ ] Locked: Faded, no interaction
  - [ ] Available: Bright, hover effect
  - [ ] Current: Pulsing, highlighted
  - [ ] Visited: Subdued, marked complete

### Path Preview System (AC: 4)

- [ ] Hover/tap preview
  - [ ] Shows node type description
  - [ ] Previews potential rewards:
    - Combat: "Gold + Card reward"
    - Elite: "Better rewards, harder fight"
    - Rest: "Heal or Upgrade"
    - Shop: "Spend gold on cards/relics"
- [ ] Path comparison
  - [ ] Highlight path to node on hover
  - [ ] Show node count to boss
  - [ ] Indicate path difficulty (elite count)
- [ ] Risk/reward indicators
  - [ ] Safe path marker
  - [ ] Risky path marker
  - [ ] Reward potential icons

### Current Position Highlight (AC: 5)

- [ ] Prominent current marker
  - [ ] Player icon at current position
  - [ ] Pulsing highlight ring
  - [ ] Direction facing next available nodes
- [ ] Camera auto-center
  - [ ] Current position stays visible
  - [ ] Smooth pan to new position
- [ ] "You are here" clarity
  - [ ] Distinct from visited/available
  - [ ] Impossible to miss
- [ ] Movement animation
  - [ ] When selecting new node, player icon travels path
  - [ ] Brief transition animation

### Boss Approach Tension (AC: 6)

- [ ] Boss visibility
  - [ ] Boss node always visible (zoom/scroll)
  - [ ] Boss icon larger and more detailed
  - [ ] Ominous glow or effect
- [ ] Tension escalation
  - [ ] As player approaches, effects intensify
  - [ ] Music builds subtly
  - [ ] Screen vignette darkens
- [ ] "Final approach" moment
  - [ ] When only boss remains
  - [ ] Special UI state
  - [ ] "Challenge the Boss?" confirmation

### Smooth Scroll and Zoom (AC: 7)

- [ ] Touch/mouse scroll
  - [ ] Pan map by dragging
  - [ ] Scroll wheel for zoom
  - [ ] Boundaries (no scrolling past edges)
- [ ] Zoom levels
  - [ ] Overview: See entire map
  - [ ] Standard: Comfortable navigation
  - [ ] Detail: Focus on specific area
- [ ] Zoom controls
  - [ ] + / - buttons
  - [ ] Pinch to zoom (mobile)
  - [ ] Double-tap to toggle zoom levels
- [ ] Performance
  - [ ] Map renders efficiently at all zoom levels
  - [ ] No jank during scroll/zoom

### Mobile Touch Gestures (AC: 8)

- [ ] Tap to select node
  - [ ] Single tap highlights node
  - [ ] Second tap confirms selection
  - [ ] Or tap + confirm button
- [ ] Drag to pan
  - [ ] Smooth, momentum-based scrolling
  - [ ] Doesn't trigger node selection
- [ ] Pinch to zoom
  - [ ] Two-finger pinch zoom
  - [ ] Maintains center point
- [ ] Long-press for info
  - [ ] Shows node details popup
  - [ ] Doesn't select

## Dev Notes

### Map Theming System

```typescript
interface ActTheme {
  id: string;
  name: string;
  background: {
    gradient: string;
    layers: BackgroundLayer[];
  };
  pathStyle: {
    color: string;
    width: number;
    pattern?: string;
  };
  nodeStyles: {
    default: NodeStyle;
    combat: NodeStyle;
    elite: NodeStyle;
    rest: NodeStyle;
    shop: NodeStyle;
    shrine: NodeStyle;
    boss: NodeStyle;
  };
  ambientEffects: {
    particles?: ParticleConfig;
    lighting?: LightingConfig;
    fog?: FogConfig;
  };
}

const ACT_THEMES: Record<number, ActTheme> = {
  1: {
    id: 'sanctum-depths',
    name: 'Sanctum Depths',
    background: {
      gradient: 'linear-gradient(180deg, #1a1a2e 0%, #16213e 100%)',
      layers: [
        { image: 'bg-stone-wall.png', depth: 0.2 },
        { image: 'bg-columns.png', depth: 0.5 },
        { image: 'bg-torches.png', depth: 0.8 }
      ]
    },
    pathStyle: {
      color: '#8b7355',
      width: 4,
      pattern: 'stone-path'
    },
    // ... node styles
  },
  2: {
    id: 'flooded-halls',
    name: 'Flooded Halls',
    // ... water theme
  },
  3: {
    id: 'void-breach',
    name: 'Void Breach',
    // ... cosmic horror theme
  }
};
```

### Node Rendering Enhancement

```typescript
function renderMapNode(node: MapNode, theme: ActTheme): HTMLElement {
  const el = document.createElement('div');
  el.className = `map-node ${node.type} ${node.state}`;

  // Icon with theme styling
  const icon = document.createElement('div');
  icon.className = 'node-icon';
  icon.innerHTML = getNodeIcon(node.type, theme);

  // Label
  const label = document.createElement('span');
  label.className = 'node-label';
  label.textContent = getNodeLabel(node.type);

  // State indicators
  if (node.visited) {
    const check = document.createElement('span');
    check.className = 'visited-check';
    check.textContent = 'âœ“';
    el.appendChild(check);
  }

  if (node.state === 'current') {
    const pulse = document.createElement('div');
    pulse.className = 'current-pulse';
    el.appendChild(pulse);
  }

  el.appendChild(icon);
  el.appendChild(label);

  return el;
}

function getNodeIcon(type: NodeType, theme: ActTheme): string {
  const icons = {
    combat: '<svg>...</svg>', // Crossed swords
    elite: '<svg>...</svg>',  // Skull banner
    rest: '<svg>...</svg>',   // Campfire
    shop: '<svg>...</svg>',   // Shop stall
    shrine: '<svg>...</svg>', // Altar
    boss: '<svg>...</svg>',   // Massive door
  };
  return icons[type] || icons.combat;
}
```

### Journey Trail Rendering

```typescript
function renderJourneyTrail(
  visitedNodes: MapNode[],
  currentNode: MapNode,
  svgContainer: SVGElement
): void {
  const path = document.createElementNS(SVG_NS, 'path');
  path.setAttribute('class', 'journey-trail');

  let d = '';
  visitedNodes.forEach((node, index) => {
    const pos = getNodePosition(node);
    if (index === 0) {
      d += `M ${pos.x} ${pos.y}`;
    } else {
      d += ` L ${pos.x} ${pos.y}`;
    }
  });

  // Continue to current
  const currentPos = getNodePosition(currentNode);
  d += ` L ${currentPos.x} ${currentPos.y}`;

  path.setAttribute('d', d);
  svgContainer.appendChild(path);

  // Add glow filter
  path.style.filter = 'url(#journey-glow)';
}
```

### CSS for Map States

```css
/* Node states */
.map-node {
  position: absolute;
  cursor: pointer;
  transition: transform 0.2s ease, filter 0.2s ease;
}

.map-node.locked {
  opacity: 0.4;
  filter: grayscale(1);
  cursor: not-allowed;
}

.map-node.available {
  opacity: 1;
  animation: node-available 2s ease-in-out infinite;
}

.map-node.available:hover {
  transform: scale(1.15);
  filter: brightness(1.2);
}

.map-node.current {
  z-index: 10;
}

.map-node.current .current-pulse {
  position: absolute;
  inset: -8px;
  border: 3px solid gold;
  border-radius: 50%;
  animation: current-pulse 1.5s ease-in-out infinite;
}

.map-node.visited {
  opacity: 0.7;
}

.map-node.visited .visited-check {
  position: absolute;
  top: -5px;
  right: -5px;
  background: #22c55e;
  color: white;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  font-size: 10px;
}

/* Journey trail */
.journey-trail {
  stroke: gold;
  stroke-width: 3;
  fill: none;
  stroke-linecap: round;
  stroke-dasharray: 1000;
  stroke-dashoffset: 1000;
  animation: trail-draw 2s ease-out forwards;
}

@keyframes trail-draw {
  to { stroke-dashoffset: 0; }
}

/* Boss approach effects */
.map-screen.boss-nearby {
  --vignette-opacity: 0.3;
}

.map-node.boss {
  transform-origin: center;
  animation: boss-menace 3s ease-in-out infinite;
}

@keyframes boss-menace {
  0%, 100% { transform: scale(1); filter: brightness(1); }
  50% { transform: scale(1.05); filter: brightness(1.1); }
}
```

### Touch Gesture Handling

```typescript
class MapGestureHandler {
  private mapContainer: HTMLElement;
  private scale = 1;
  private translateX = 0;
  private translateY = 0;

  constructor(container: HTMLElement) {
    this.mapContainer = container;
    this.setupTouchHandlers();
    this.setupMouseHandlers();
  }

  private setupTouchHandlers(): void {
    let initialDistance = 0;
    let initialScale = 1;

    this.mapContainer.addEventListener('touchstart', (e) => {
      if (e.touches.length === 2) {
        initialDistance = this.getDistance(e.touches);
        initialScale = this.scale;
      }
    });

    this.mapContainer.addEventListener('touchmove', (e) => {
      if (e.touches.length === 2) {
        e.preventDefault();
        const currentDistance = this.getDistance(e.touches);
        const scaleDelta = currentDistance / initialDistance;
        this.setScale(initialScale * scaleDelta);
      } else if (e.touches.length === 1) {
        // Pan
        this.pan(e.touches[0].movementX, e.touches[0].movementY);
      }
    });
  }

  private getDistance(touches: TouchList): number {
    const dx = touches[0].clientX - touches[1].clientX;
    const dy = touches[0].clientY - touches[1].clientY;
    return Math.sqrt(dx * dx + dy * dy);
  }

  private setScale(newScale: number): void {
    this.scale = Math.min(Math.max(newScale, 0.5), 2);
    this.applyTransform();
  }

  private pan(dx: number, dy: number): void {
    this.translateX += dx;
    this.translateY += dy;
    this.applyTransform();
  }

  private applyTransform(): void {
    this.mapContainer.style.transform = `
      translate(${this.translateX}px, ${this.translateY}px)
      scale(${this.scale})
    `;
  }
}
```

## Testing

### Test Scenarios

1. Map displays correct theme for each act
2. Journey trail shows path from start to current
3. All node types have distinct, clear icons
4. Hover shows node preview info
5. Current position is obviously highlighted
6. Boss node creates tension as approached
7. Map scrolls and zooms smoothly
8. Mobile pinch zoom and pan work correctly

### Performance Targets

- Map renders in < 100ms
- Scroll at 60fps
- Zoom transitions smooth
- Memory usage stable during navigation

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-04 | 1.0 | Initial story creation | Sally (UX) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_
