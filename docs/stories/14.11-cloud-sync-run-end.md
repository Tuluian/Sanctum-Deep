# Story 14.11: Cloud Sync on Run End

## Status: Draft

## Story

**As a** logged-in player,
**I want** my progress to sync to the cloud when I finish a run,
**so that** my Soul Echoes, achievements, and statistics are saved immediately.

## Acceptance Criteria

1. When a run ends (victory or defeat), trigger cloud sync
2. Sync happens after local save (non-blocking)
3. Soul Echoes earned in run are synced
4. Statistics updates are synced
5. Achievement unlocks during run are synced
6. New meta-progression purchases are synced
7. Sync failure doesn't affect gameplay (queued for retry)

## Tasks

- [ ] Hook sync trigger into endRun() flow
- [ ] Ensure sync runs after all local updates complete
- [ ] Test sync on victory
- [ ] Test sync on defeat
- [ ] Test sync when achievements unlock
- [ ] Test sync failure recovery

## Technical Notes

### Integration Point

The sync should happen in the existing `endRun()` method:

```typescript
// src/services/SaveManager.ts

endRun(victory: boolean): void {
  if (this.saveData.run) {
    if (victory) {
      this.saveData.meta.statistics.totalWins++;
      // Soul Echoes already awarded per-combat via addSoulEchoes()
    } else {
      this.saveData.meta.statistics.totalDeaths++;
      // No Soul Echoes on defeat to prevent grinding
    }
    this.saveData.run = null;

    // Save locally (this also triggers cloud sync via saveNow())
    this.saveNow();

    // Force immediate sync for run end (important checkpoint)
    if (AuthService.isAuthenticated()) {
      this.forceImmediateSync();
    }
  }
}

private forceImmediateSync(): void {
  // Cancel any pending debounced sync
  if (this.pendingSyncTimeout) {
    clearTimeout(this.pendingSyncTimeout);
    this.pendingSyncTimeout = null;
  }

  // Sync immediately (but still non-blocking)
  this.performCloudSync().catch(error => {
    console.error('Run end sync failed:', error);
    // Error already handled by performCloudSync (queued for retry)
  });
}
```

### What Gets Synced at Run End

```typescript
// After a run ends, these values may have changed:
interface MetaSaveData {
  soulEchoes: number;           // Earned during run (victory only)
  unlockedAchievements: string[]; // May have new unlocks
  purchasedUpgrades: string[];    // May have bought upgrades at shrines
  statistics: {
    totalRuns: number;          // +1
    totalWins: number;          // +1 if victory
    totalDeaths: number;        // +1 if defeat
    enemiesDefeated: number;    // Updated throughout run
    cardsPlayed: number;        // Updated throughout run
    // ... other stats
  };
}

// Run state is cleared:
run: null  // No longer in a run
```

### Victory Screen Integration

The victory screen should show sync status:

```typescript
// src/ui/screens/VictoryScreen.ts

function renderVictoryScreen(soulEchoesEarned: number): string {
  return `
    <div class="victory-screen">
      <h1>Victory!</h1>

      <div class="rewards">
        <div class="reward-item">
          <span class="reward-label">Soul Echoes Earned</span>
          <span class="reward-value">+${soulEchoesEarned}</span>
        </div>
      </div>

      ${AuthService.isAuthenticated() ? `
        <div class="sync-status-container">
          ${renderSyncIndicator(SaveManager.getSyncStatus())}
        </div>
      ` : `
        <div class="sync-prompt">
          <a href="#" onclick="showAuthScreen()">Sign in to save to cloud</a>
        </div>
      `}

      <button class="btn primary" onclick="returnToMenu()">
        Continue
      </button>
    </div>
  `;
}
```

### Defeat Screen Integration

```typescript
// src/ui/screens/DefeatScreen.ts

function renderDefeatScreen(): string {
  return `
    <div class="defeat-screen">
      <h1>Defeat</h1>

      <div class="run-summary">
        <p>You reached Act ${currentAct}</p>
        <p>Enemies defeated: ${enemiesDefeated}</p>
      </div>

      ${AuthService.isAuthenticated() ? `
        <div class="sync-status-container">
          ${renderSyncIndicator(SaveManager.getSyncStatus())}
        </div>
      ` : ''}

      <button class="btn primary" onclick="returnToMenu()">
        Try Again
      </button>
    </div>
  `;
}
```

### Sync Priority

Run end syncs are higher priority than normal saves:

```typescript
// Normal save: debounced 2 seconds
// Run end: immediate

// This ensures that if a player closes the browser right after
// a run ends, their progress is more likely to have synced
```

### Edge Cases

| Scenario | Behavior |
|----------|----------|
| Player closes browser immediately after victory | Sync may not complete; queued for retry on next load |
| Network fails during victory sync | Local save succeeded; cloud sync queued for retry |
| Multiple achievements unlock at once | All included in single sync |
| Player is on defeat screen, sync completes | Indicator updates to "Synced" |

## Definition of Done

- [ ] Victory triggers cloud sync
- [ ] Defeat triggers cloud sync
- [ ] Sync is non-blocking (doesn't freeze victory/defeat screen)
- [ ] Sync status shown on end-of-run screens
- [ ] Sync failure is recoverable (queued for retry)

## Dependencies

- Story 14.9 (SaveManager Refactor)
- Story 14.10 (Cloud Sync on App Load - for retry logic)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-05 | 1.0 | Story created | Mary (Analyst) |
