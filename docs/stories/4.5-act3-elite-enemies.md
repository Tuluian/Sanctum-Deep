# Story 4.5: Act 3 Elite Enemies

## Status: In Progress

## Story

**As a** player facing elite encounters in Act 3,
**I want** the most challenging mini-bosses in the game,
**so that** I'm truly tested before the final confrontation with the Hollow God.

---

## Narrative Context: The Almost-Champions

> *"These are the ones who nearly defeated the Hollow God. They came so close. That's why their fall was the hardest. They knew victory. They tasted it. Then they became what they fought."*

### Design Philosophy

Act 3 elites should feel like:
- What the player could become if they fail
- Champions who lost at the final moment
- The Hollow God's greatest trophies
- Tests that require everything—and promise nothing

---

## Elite Roster: The Fallen Champions

### Greater Demon (Archdemon Mal'goroth)

**HP:** 130 | **Role:** Summoner/Executioner

#### Who He Was

Saint Mal'gorath of the Silver Flame was the greatest paladin of his age. He entered the Sanctum not for glory or love or knowledge—but because it was right. Because someone had to try. Because evil must be opposed.

He fought beautifully. He reached the Hollow God. He raised his blessed sword and struck—

And nothing happened.

The Hollow God didn't fight back. It simply... waited. And in that moment of confusion, it showed Mal'gorath the truth: every soul he'd ever "saved" eventually died anyway. Every demon he'd slain was replaced by another. Every prayer he'd uttered went to gods too distant to care.

He saw the futility of hope.

His faith broke first. Then his name. Then everything else.

Now he summons Imps—mockeries of the faithful he once inspired. He laughs at the despair of others because it's the only laugh he has left.

#### Pre-Combat Display

```
╔══════════════════════════════════════════════════════════════╗
║              ARCHDEMON MAL'GOROTH                             ║
║                                                               ║
║   "Once Saint Mal'gorath, Champion of the Silver Flame"       ║
║                                                               ║
║   "I fought evil for forty years. Then I looked into it.      ║
║    Do you know what I saw?                                    ║
║    Nothing. Evil isn't a force. It's an absence.              ║
║    And you can't fight an absence. You can only... join it."  ║
╚══════════════════════════════════════════════════════════════╝
```

#### Phase Dialogue

**Phase 1 (Commander):**
- Turn 1: *"Welcome, champion. I used to be like you. Full of purpose. Full of light. Let me show you what light becomes in the dark."*
- On Summon Imps: *"These were believers once. Now they believe in nothing. It's... freeing, really."*
- On Demonic Roar: *"RISE! GROW STRONG! Strength without purpose is still strength!"*
- On Consume Minion: *[Absorbing an Imp]* "Thank you for your service. I barely remember what service means."*

**Phase 2 Transition (at 65 HP):**
> *[His holy symbol—still hanging around his neck, charred but intact—begins to glow]*
>
> "No. NO. I won't remember. I won't feel it again."
>
> *[The glow intensifies]*
>
> "The flame... the Silver Flame... it's still there. It was always there."
>
> *[He screams—part rage, part grief]*
>
> "BUT IT WASN'T ENOUGH! THE FLAME COULDN'T SAVE ANYONE! I COULDN'T SAVE ANYONE!"
>
> *[The glow dies. His eyes turn fully void.]*
>
> "If I can't save... I'll destroy. At least destruction is HONEST."

**Phase 2 (Unleashed):**
- On Cataclysm: *"BURN! EVERYONE BURNS! EVERYTHING BURNS! I wanted to be the light but the light was a LIE!"*
- On Soul Harvest: *"Give me your hope. I'll add it to the pile. I have so many dead hopes now."*
- On Demonic Ascension: *"I will be strong. Not righteous—just strong. Strong enough that nothing can hurt me. Not even memory."*

#### Death Sequence

> *[As Mal'goroth falls, the charred holy symbol around his neck begins to glow again—brighter this time]*
>
> "No... not again... I can't..."
>
> *[His form wavers between demon and paladin]*
>
> "I remember the light. I remember... believing. It felt so..."
>
> *[Tears—actual tears—stream down his transformed face]*
>
> "I wanted to save everyone. I couldn't save anyone. But you..."
>
> *[The light grows stronger]*
>
> "You still can. The Hollow God shows you despair. Don't look. Don't listen. Don't—"
>
> *[The demon form dissolves. For one moment, an old paladin kneels there—gray-haired, weary, but at peace]*
>
> "—don't give up. Faith isn't about winning. It's about trying anyway."
>
> *[He dissolves into silver light. The holy symbol remains, cleansed.]*

#### Lore Drop

After defeating Mal'goroth, the player finds:
> **Silver Flame Medallion**: *"Carried by Saint Mal'gorath for forty years. Even in damnation, he couldn't let it go. Even the void couldn't take this from him."*

#### Class-Specific Interactions

**Cleric:** *"Another servant of the divine. Your god let me fall. They'll let you fall too. Gods are distant. The void is close."*

**Knight:** *"Duty. Honor. I had those once. They're just words. Words don't stop the dark."*

**Diabolist:** *"You made a deal with darkness. At least you were honest about it. I pretended I was good while the darkness grew inside me."*

**Oathsworn:** *"Vows? I had vows. I kept every one. And still I fell. Vows don't protect you. Nothing protects you."*

**Fey-Touched:** *"The fey don't care about good and evil. Smart. I wish I'd known that. Would have saved me forty years."*

---

### Sanctum Warden (The Last Warden's Shadow)

**HP:** 150 | **Role:** Reality Anchor/Summoner

#### What It Is

The Sanctum Warden is not a person. It's a manifestation—a fragment of the dying Warden's will given form. Every Warden who holds the Sanctum creates a Shadow of themselves, an echo of their determination.

This Shadow remembers every previous Warden's defeat. It projects memories of fallen bosses because those are the threats it remembers. It limits your draws because it's trying to protect you—slowing you down so you don't rush into death like all the others.

It doesn't want to fight you. But it has to be sure. It has to know you're ready.

It's the Warden's last gift—and last test.

#### Pre-Combat Display

```
╔══════════════════════════════════════════════════════════════╗
║            THE SANCTUM WARDEN'S SHADOW                        ║
║                                                               ║
║      "A fragment of will. A memory of purpose."               ║
║                                                               ║
║  "I am what remains when a Warden fades.                      ║
║   I am the last lesson they teach.                            ║
║   I am the final gate before the god.                         ║
║   Prove to me that you're ready—or join my memories."         ║
╚══════════════════════════════════════════════════════════════╝
```

#### Combat Dialogue

**Opening:**
> "You've come far. Farther than most. But far is not enough."
>
> "I've seen champions fall at this threshold. Strong ones. Good ones."
>
> "Let me show you what you face."

**On Reality Anchor (draw limit):**
*"Slowly. Carefully. Rushing killed the others. I won't let it kill you."*

**On Memory Projection:**
*"Remember this threat? The Sanctum remembers. I remember. Do you remember how to defeat it?"*

- **Memory of Bonelord appears:** *"Lord Vexal. His pride was his weakness. What is yours?"*
- **Memory of Drowned King appears:** *"King Aldric. His love was his prison. What imprisons you?"*

**On Judgment Strike:**
*"This is how hard the Hollow God strikes. Can you survive it? You must survive it."*

**On Divine Barrier:**
*"I protect myself because I must protect you. If I fall before you're ready, you die."*

**On Seal of Binding:**
*"Your power is too much. Too fast. I'm limiting you to save you."*

**On Time Fracture:**
*"The Hollow God bends reality. I'm teaching you to fight in broken time."*

**On Warden's Duty (heal at 30% HP):**
> *"Not yet. I can't end yet. You're not ready yet."*
>
> "I've watched so many champions die. I can't watch another. I WON'T watch another."
>
> "Let me test you more. Let me be sure. Let me..."
>
> *[Pause]*
>
> "...let me pretend a little longer that I can still protect someone."

#### Death Sequence

> *[The Shadow flickers—a hundred Wardens appear and fade, superimposed]*
>
> "You... you passed. All of my tests. Every test I could remember."
>
> *[The Shadow's form stabilizes—it looks like the current Warden now, but younger. Healthier. How they were before.]*
>
> "I am what they were. What they sacrificed. What they'll become again when you take their place."
>
> *[It kneels]*
>
> "You've proven yourself to me. Now prove yourself to them."
>
> *[A whisper]*
>
> "Tell them... tell the one waiting... that I'm sorry I couldn't protect them better. That I tried. That we all tried."
>
> *[Fades. The memories fade with it. The hall is quiet.]*
>
> *[The actual Warden's voice, distant:]*
> "...thank you. My shadow was my doubt. You've defeated it. Now there's only the god."

#### Memory Minions

**Memory of Bonelord (40 HP):**
- Death Quote: *"Even memories die twice. I was Lord Vexal's pride. Now I'm nothing's echo."*
- Combat: *"I remember being grand. I remember being feared. I remember... nothing else."*

**Memory of Drowned King (40 HP):**
- Death Quote: *"Aldric loved too much. Even my memory of him loves. Even dying, I love."*
- Combat: *"The waters rise. They always rise. Even in memory, I'm drowning."*

#### Class-Specific Interactions

**Cleric:**
> "Your god was a Warden once. Did you know? They held this place before ascending. They remember this test. They passed it. Will you?"

**Knight:**
> "Ser Aldric took this test. He failed. He became the Bonelord's first victim. Don't fail like your mentor failed."

**Diabolist:**
> "The Shadow has no soul to bargain for. Your contractor has no leverage here. Face this test alone."

**Oathsworn:**
> "The Order's founder passed this test. They founded the Order to prevent anyone else from having to take it. They failed at that too. Here you are."

**Fey-Touched:**
> "Oberon cannot help you here. The Shadow exists between moments—where the fey don't play. This is mortal business. Your mortal self. Alone."

---

## Encounter Flow

### Elite Encounter Start

Before combat begins, display:
1. Elite's name and title (dramatic reveal)
2. Origin story (brief, impactful)
3. Opening monologue
4. Passive abilities explanation

### Phase/Mechanic Triggers

- **Greater Demon Phase 2**: Holy symbol glows, transformation
- **Memory Projection**: Visual of boss silhouette forming
- **Reality Anchor**: Deck visually "slows down"
- **Warden's Duty**: Desperate dialogue, brief pause

### Victory Impact

After defeating either elite:
- Full death sequence (cannot be skipped)
- Lore item drops (Silver Flame Medallion, Warden's Blessing)
- The Warden acknowledges the victory
- Final gate to Hollow God opens

---

## Acceptance Criteria

1. Act 3 has 2 elite enemy types: Greater Demon, Sanctum Warden
2. Each elite has 120-150 HP (highest elite HP in game)
3. Elites have multi-phase behavior with devastating mechanics
4. Elites drop best rewards (guaranteed rare card)
5. Each elite has deep narrative context
6. These fights should feel nearly as challenging as bosses

## Tasks / Subtasks

- [x] Design Greater Demon elite (AC: 1, 2, 3)
  - [x] **Greater Demon** (130 HP) - Lord of a demonic legion
    - **Passive: Infernal Presence** - All damage dealt by player reduced by 2 (deferred)
    - **Phase 1: Commander** (HP > 65)
      - Hellfire Blast (Attack 15, 30%)
      - Summon Imps (Spawn 2 Imps, 30%)
      - Demonic Roar (All demons gain 3 Might, 25%)
      - Consume Minion (Destroy an Imp, Heal 20, 15%)
    - **Phase 2: Unleashed** (HP <= 65)
      - Infernal presence increases to -4 player damage (deferred)
      - Cataclysm (Attack 12 to all targets including allies, 35%)
      - Soul Harvest (Attack 18, heal HP equal to damage dealt, 30%)
      - Demonic Ascension (Gain 20 block, +5 damage next attack, 35%)
    - **Lore**: "Archdemon Mal'goroth — Once a saint who fell to despair"

- [x] Design Sanctum Warden elite (AC: 1, 2, 3)
  - [x] **Sanctum Warden** (150 HP) - The dying Warden's last defender
    - **Passive: Reality Anchor** - Player can only draw 4 cards per turn (deferred)
    - **Normal Moves**:
      - Judgment Strike (Attack 16, 25%)
      - Divine Barrier (Gain 20 block, 20%)
      - Seal of Binding (Apply Bound - random card type - 2 turns, 20%)
      - Time Fracture (Shuffle player's hand into deck, draw 3 new cards, 15%)
      - Warden's Duty (If HP < 30%, heal to 50% HP, can only trigger once, 20%)
    - **Special: Memory Projection** (deferred - periodic summoning)
      - Every 3 turns, summon a "Memory" of a previous boss
      - Memory of Bonelord (40 HP, basic attacks)
      - Memory of Drowned King (40 HP, applies Flood 1/turn)
    - **Lore**: "The Last Warden's Shadow — A fragment of will given form"

- [x] Design Memory minions
  - [x] **Memory of Bonelord** (40 HP)
    - Bone Strike (Attack 8, 60%)
    - Hollow Echo (Block 6, 40%)
  - [x] **Memory of Drowned King** (40 HP)
    - Tidal Memory (Attack 7, Increase Flood by 1, 60%)
    - Fading Guard (Block 8, 40%)

- [x] Implement elite-specific mechanics (see Story 4.7)
  - [x] Infernal Presence (global damage reduction)
  - [x] Reality Anchor (draw reduction)
  - [x] Time Fracture (hand shuffle)
  - [x] Memory Projection (periodic summoning)
  - [x] Track "turns since last summon" for Warden

- [x] Update CombatEngine for elite mechanics (see Story 4.7)
  - [x] Apply passive damage reduction
  - [x] Override draw count
  - [x] Handle hand shuffle to deck
  - [x] Handle periodic events (every X turns)
  - [x] Track one-time abilities per enemy

- [ ] Update UI for elite encounters
  - [ ] Elite health bar with golden/red border
  - [ ] Passive effect indicator (always visible)
  - [ ] "Memory Projection in X turns" counter
  - [ ] Draw reduction indicator
  - [ ] Phase transition effects

- [ ] Implement elite rewards
  - [ ] Guaranteed rare card choice
  - [ ] +100% gold compared to normal combat
  - [ ] 75% potion drop chance
  - [ ] 25% relic drop chance

- [x] Write unit tests
  - [x] Test elite definitions (46 tests)
  - [x] Test Greater Demon has correct phases and moves
  - [x] Test Sanctum Warden has correct moves
  - [x] Test Memory minions have correct stats
  - [x] Test Warden's Duty has once-per-combat flag
  - [ ] Test Infernal Presence reduces damage (deferred)
  - [ ] Test Reality Anchor limits draw (deferred)
  - [ ] Test Memory Projection triggers every 3 turns (deferred)
  - [ ] Test Time Fracture shuffles hand (deferred)

## Dev Notes

### Elite Narrative Context

**Greater Demon (Mal'goroth)**:
Once a revered saint who entered the Sanctum seeking to purify it. The Hollow God showed him the futility of faith - every prayer unanswered, every soul he tried to save eventually consumed. His despair transformed him into what he fought against.

**Sanctum Warden's Shadow**:
Not a person, but a manifestation of the dying Warden's will to protect the Sanctum. It projects memories of defeated bosses because those are the threats the Warden remembers. Defeating it means the Warden has accepted you as their successor.

### Greater Demon Design

```typescript
const GREATER_DEMON: EliteDefinition = {
  id: 'greater_demon',
  name: 'Greater Demon',
  lore: {
    trueName: 'Archdemon Mal\'goroth',
    origin: 'Once a saint who fell to despair',
    wardenNote: 'I knew him before. His faith was strong. The void is stronger.',
  },
  maxHp: 130,
  passive: {
    name: 'Infernal Presence',
    description: 'All damage dealt by player reduced by 2.',
    effect: { type: 'damage_reduction', amount: 2, target: 'player_outgoing' },
    phaseScaling: { 2: { amount: 4 } }, // Increases in phase 2
  },
  phases: [
    {
      name: 'Commander',
      hpRange: { min: 66, max: 130 },
      moves: [
        { id: 'hellfire_blast', name: 'Hellfire Blast', intent: IntentType.ATTACK, damage: 15, weight: 30 },
        { id: 'summon_imps', name: 'Summon Imps', intent: IntentType.SPAWN,
          spawnId: 'imp', count: 2, weight: 30 },
        { id: 'demonic_roar', name: 'Demonic Roar', intent: IntentType.BUFF_ALLY,
          buff: { type: StatusType.MIGHT, amount: 3 }, targetType: 'demon', weight: 25 },
        { id: 'consume_minion', name: 'Consume Minion', intent: IntentType.HEAL,
          heal: 20, consumeMinion: 'imp', weight: 15 },
      ],
    },
    {
      name: 'Unleashed',
      hpRange: { min: 0, max: 65 },
      dialogue: 'I WILL NOT BE BOUND AGAIN!',
      moves: [
        { id: 'cataclysm', name: 'Cataclysm', intent: IntentType.ATTACK,
          damage: 12, target: 'all_including_allies', weight: 35 },
        { id: 'soul_harvest', name: 'Soul Harvest', intent: IntentType.ATTACK,
          damage: 18, lifesteal: true, weight: 30 },
        { id: 'demonic_ascension', name: 'Demonic Ascension', intent: IntentType.DEFEND,
          block: 20, nextAttackBonus: 5, weight: 35 },
      ],
    },
  ],
};
```

### Sanctum Warden Design

```typescript
const SANCTUM_WARDEN: EliteDefinition = {
  id: 'sanctum_warden',
  name: 'Sanctum Warden',
  lore: {
    trueName: "The Last Warden's Shadow",
    origin: 'A fragment of will given form',
    wardenNote: 'That is... me. What I was. What I will be again, in you.',
  },
  maxHp: 150,
  passive: {
    name: 'Reality Anchor',
    description: 'Player can only draw 4 cards per turn.',
    effect: { type: 'draw_limit', amount: 4 },
  },
  periodicAbility: {
    name: 'Memory Projection',
    interval: 3, // Every 3 turns
    action: {
      type: 'spawn_random',
      options: ['memory_bonelord', 'memory_drowned_king'],
    },
  },
  moves: [
    { id: 'judgment_strike', name: 'Judgment Strike', intent: IntentType.ATTACK, damage: 16, weight: 25 },
    { id: 'divine_barrier', name: 'Divine Barrier', intent: IntentType.DEFEND, block: 20, weight: 20 },
    { id: 'seal_of_binding', name: 'Seal of Binding', intent: IntentType.DEBUFF,
      status: { type: StatusType.BOUND, cardType: 'random', duration: 2 }, weight: 20 },
    { id: 'time_fracture', name: 'Time Fracture', intent: IntentType.SPECIAL,
      special: 'shuffle_hand_draw_3', weight: 15 },
    { id: 'wardens_duty', name: "Warden's Duty", intent: IntentType.HEAL,
      special: { type: 'conditional_heal', condition: 'hp_below_30_percent', healToPercent: 50, once: true },
      weight: 20 },
  ],
};
```

### Passive Effect Implementation

```typescript
// Infernal Presence - reduces player outgoing damage
function calculateDamage(baseDamage: number, source: 'player' | 'enemy'): number {
  if (source === 'player') {
    const infernalReduction = getActivePassive('infernal_presence');
    if (infernalReduction) {
      baseDamage = Math.max(0, baseDamage - infernalReduction.amount);
    }
  }
  return baseDamage;
}

// Reality Anchor - limits draw
function drawCards(count: number): void {
  const drawLimit = getActivePassive('reality_anchor');
  if (drawLimit) {
    count = Math.min(count, drawLimit.amount);
  }
  // Continue with normal draw
}
```

### Time Fracture Implementation

```typescript
function executeTimeFracture(): void {
  // Shuffle hand back into draw pile
  const handCards = [...player.hand];
  player.hand = [];

  for (const card of handCards) {
    player.drawPile.push(card);
  }

  // Shuffle draw pile
  shuffleArray(player.drawPile);

  // Draw 3 new cards
  drawCards(3);

  addCombatLog("Time fractures! Your hand is reshuffled!");
}
```

### Memory Projection Implementation

```typescript
interface EliteState {
  turnsSinceLastProjection: number;
}

function onEliteTurnStart(elite: Enemy, state: EliteState): void {
  if (elite.id === 'sanctum_warden') {
    state.turnsSinceLastProjection++;

    if (state.turnsSinceLastProjection >= 3) {
      executeMemoryProjection(elite);
      state.turnsSinceLastProjection = 0;
    }
  }
}

function executeMemoryProjection(elite: Enemy): void {
  const memories = ['memory_bonelord', 'memory_drowned_king'];
  const chosen = memories[Math.floor(Math.random() * memories.length)];

  const memory = createEnemy(chosen);
  state.enemies.push(memory);

  addCombatLog(`${elite.name} projects a memory of the past!`);
  emit(CombatEventType.ENEMY_SPAWNED, { parent: elite.id, spawn: memory });
}
```

### Balance Notes

| Elite | HP | Avg Damage/Turn | Special | Difficulty |
|-------|-----|-----------------|---------|------------|
| Greater Demon | 130 | 12.5 (+ minions) | Damage reduction | Very High |
| Sanctum Warden | 150 | 11.0 (+ memories) | Draw limit | Extreme |

These should be the hardest non-boss fights in the game.

**Greater Demon Strategies**:
- Kill Imps to prevent Roar stacking
- Save burst for phase 2 before ascension
- Accept some damage reduction, focus on high-damage cards

**Sanctum Warden Strategies**:
- Prioritize efficient cards (4-card hands are limiting)
- Kill Memories quickly before they stack
- Use Powers early (can't play as many per turn)

## Testing

### Test File Location
`src/tests/enemies/Act3Elites.test.ts`

### Key Test Scenarios

1. **Infernal Presence**: Player damage reduced by 2 (then 4)
2. **Reality Anchor**: Player draws max 4 cards
3. **Memory Projection**: Triggers every 3 turns
4. **Time Fracture**: Hand shuffled, 3 new cards drawn
5. **Warden's Duty**: Heals to 50% once when below 30%
6. **Consume Minion**: Destroys Imp, heals demon
7. **Elite Rewards**: Guaranteed rare card

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-03 | 1.0 | Initial story creation | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- No errors encountered during implementation

### Completion Notes List
- Created Greater Demon elite (130 HP) with 2 phases:
  - Phase 1 (Commander): Hellfire Blast, Summon Imps, Demonic Roar, Consume Minion
  - Phase 2 (Unleashed): Cataclysm, Soul Harvest, Demonic Ascension
- Created Sanctum Warden elite (150 HP) with 5 moves:
  - Judgment Strike, Divine Barrier, Seal of Binding, Time Fracture, Warden's Duty
- Created 2 Memory minions (40 HP each):
  - Memory of Bonelord: Bone Strike, Hollow Echo
  - Memory of Drowned King: Tidal Memory, Fading Guard
- Created 46 unit tests covering all elite definitions and mechanics
- Deferred mechanics requiring CombatEngine updates:
  - Infernal Presence (damage reduction passive)
  - Reality Anchor (draw limit passive)
  - Memory Projection (periodic summoning every 3 turns)
  - Time Fracture (hand shuffle mechanic)
  - Consume Minion (destroy ally to heal)
  - Cataclysm (AoE including allies)

### File List
- `src/data/enemies/act3-elites.ts` - NEW: Act 3 elite definitions (Greater Demon, Sanctum Warden, Memory minions)
- `src/data/enemies/act3-elites.test.ts` - NEW: 46 unit tests for Act 3 elites
- See Story 4.7 for CombatEngine implementation files

---

## QA Results
_To be filled by QA agent_
