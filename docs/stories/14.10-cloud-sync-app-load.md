# Story 14.10: Cloud Sync on App Load

## Status: Draft

## Story

**As a** logged-in player,
**I want** my progress to sync from the cloud when I open the game,
**so that** I have my latest progress regardless of which device I last played on.

## Acceptance Criteria

1. On app load, if logged in, pull save data from cloud
2. Compare cloud timestamp with local timestamp
3. If cloud is newer, update local storage with cloud data
4. If local is newer, push local data to cloud
5. If offline, use local data without error
6. Sync happens silently (no blocking loading screen)
7. UI shows "Syncing..." indicator during sync

## Tasks

- [ ] Add sync check to app initialization flow
- [ ] Implement timestamp comparison logic
- [ ] Handle network errors gracefully (use local data)
- [ ] Add syncing indicator to UI
- [ ] Test sync on fresh app load
- [ ] Test sync when returning to tab (optional enhancement)
- [ ] Test offline behavior

## Technical Notes

### App Initialization Flow

```typescript
// src/main.ts

async function initializeApp(): Promise<void> {
  // 1. Load local save data (instant)
  const localData = SaveManager.getSaveData();

  // 2. Render UI immediately with local data
  renderMainMenu();

  // 3. If logged in, sync in background
  if (AuthService.isAuthenticated()) {
    syncOnLoad();
  }
}

async function syncOnLoad(): Promise<void> {
  // Show syncing indicator
  showSyncIndicator('syncing');

  try {
    const result = await CloudSyncService.syncOnLoad();

    if (result.action === 'downloaded') {
      // Cloud was newer, reload UI with new data
      renderMainMenu();
      showSyncIndicator('synced');
    } else if (result.action === 'uploaded') {
      showSyncIndicator('synced');
    } else {
      showSyncIndicator('synced');
    }
  } catch (error) {
    console.error('Sync on load failed:', error);
    showSyncIndicator('offline');
    // Continue with local data, queue for retry
  }
}
```

### CloudSyncService.syncOnLoad()

```typescript
// src/services/CloudSyncService.ts

interface SyncResult {
  status: 'success' | 'error';
  action: 'uploaded' | 'downloaded' | 'none';
  message?: string;
}

async syncOnLoad(): Promise<SyncResult> {
  const localData = SaveManager.getSaveData();

  // Attempt to pull from cloud
  let cloudData: SaveData | null;
  try {
    cloudData = await this.pullFromCloud();
  } catch (error) {
    // Network error - continue offline
    console.warn('Could not reach cloud, using local data');
    return { status: 'error', action: 'none', message: 'Offline' };
  }

  // No cloud data
  if (!cloudData) {
    // Upload local to establish cloud save
    if (isLocalDataMeaningful(localData)) {
      await this.pushToCloud(localData);
      return { status: 'success', action: 'uploaded' };
    }
    return { status: 'success', action: 'none' };
  }

  // Compare timestamps (last-write-wins)
  if (cloudData.lastSaved > localData.lastSaved) {
    // Cloud is newer - update local
    SaveManager.loadSaveData(cloudData);
    return { status: 'success', action: 'downloaded' };
  } else if (localData.lastSaved > cloudData.lastSaved) {
    // Local is newer - update cloud
    await this.pushToCloud(localData);
    return { status: 'success', action: 'uploaded' };
  }

  // Same timestamp - already in sync
  return { status: 'success', action: 'none' };
}
```

### Sync Indicator UI

```typescript
// src/ui/components/SyncIndicator.ts

type SyncState = 'idle' | 'syncing' | 'synced' | 'offline' | 'error';

function renderSyncIndicator(state: SyncState): string {
  const icons = {
    idle: '',
    syncing: '<span class="sync-spinner"></span>',
    synced: '<span class="sync-check">✓</span>',
    offline: '<span class="sync-offline">⚡</span>',
    error: '<span class="sync-error">!</span>'
  };

  const labels = {
    idle: '',
    syncing: 'Syncing...',
    synced: 'Synced',
    offline: 'Offline',
    error: 'Sync failed'
  };

  if (state === 'idle') return '';

  return `
    <div class="sync-indicator sync-indicator--${state}">
      ${icons[state]}
      <span class="sync-label">${labels[state]}</span>
    </div>
  `;
}
```

### CSS for Sync Indicator

```css
.sync-indicator {
  display: flex;
  align-items: center;
  gap: 0.25rem;
  font-size: 0.75rem;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  transition: opacity 0.3s;
}

.sync-indicator--syncing {
  color: var(--color-accent);
}

.sync-indicator--synced {
  color: var(--color-success);
  animation: fadeOut 2s forwards 1s;
}

.sync-indicator--offline {
  color: var(--color-warning);
}

.sync-indicator--error {
  color: var(--color-error);
}

.sync-spinner {
  width: 12px;
  height: 12px;
  border: 2px solid currentColor;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

@keyframes fadeOut {
  to { opacity: 0; }
}
```

### Handling Tab Focus (Optional Enhancement)

Sync when player returns to the tab after being away:

```typescript
// src/main.ts

let lastSyncTime = Date.now();
const SYNC_COOLDOWN = 60000; // 1 minute

document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') {
    const now = Date.now();
    if (now - lastSyncTime > SYNC_COOLDOWN && AuthService.isAuthenticated()) {
      syncOnLoad();
      lastSyncTime = now;
    }
  }
});
```

### Error Handling

| Scenario | Behavior |
|----------|----------|
| Network timeout | Use local data, show "Offline" indicator |
| 401 Unauthorized | Token expired, trigger refresh or logout |
| 500 Server Error | Use local data, log error, retry later |
| Cloud data corrupted | Use local data, report error |

## Definition of Done

- [ ] Sync happens automatically on app load when logged in
- [ ] Newer data wins (timestamp comparison)
- [ ] Works offline (uses local data)
- [ ] Sync indicator shows current status
- [ ] No blocking delays on app startup

## Dependencies

- Story 14.9 (SaveManager Refactor)
- Story 14.6 or 14.7 (Auth)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-05 | 1.0 | Story created | Mary (Analyst) |
