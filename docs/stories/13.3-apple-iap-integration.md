# Story 13.3: Apple In-App Purchase Integration

## Status: Draft

## Story

**As a** mobile player,
**I want** to purchase DLC classes through Apple's App Store,
**so that** I can unlock premium content natively on iOS.

## Acceptance Criteria

1. All 6 DLC classes available as in-app purchases
2. Purchases use Apple's StoreKit 2 API
3. Purchase state persists across app reinstalls (receipt validation)
4. "Restore Purchases" functionality works
5. Proper error handling for failed/cancelled purchases
6. Purchase UI shows prices in user's local currency
7. Purchases unlock classes immediately after completion
8. Sandbox testing works for QA
9. Family Sharing supported for DLC (optional)
10. Compliant with App Store Review Guidelines

## Background

From brief.md:
- "Freemium model: 2 free classes, 3 premium DLC classes at $4.99 each"
- "Integration Requirements: Apple In-App Purchase (iOS)"
- Current implementation has 8 classes (6 premium beyond MVP's 2 free)

### Pricing Strategy
- Each DLC class: $4.99 (Tier 5)
- Bundle option: All 6 DLC classes for $19.99 (Tier 20) - 33% discount
- No subscriptions for content
- Non-consumable purchases (own forever)

## Tasks / Subtasks

- [ ] Install Capacitor IAP plugin (AC: 1, 2)
  - [ ] `npm install @capawesome/capacitor-in-app-purchases` or `cordova-plugin-purchase`
  - [ ] Configure plugin for iOS
  - [ ] Sync with Capacitor
- [ ] App Store Connect setup (AC: 1, 6)
  - [ ] Create App ID in Apple Developer
  - [ ] Configure in-app purchase products:
    - `com.sanctumruins.class.diabolist` - $4.99
    - `com.sanctumruins.class.oathsworn` - $4.99
    - `com.sanctumruins.class.feytouched` - $4.99
    - `com.sanctumruins.class.celestial` - $4.99
    - `com.sanctumruins.class.summoner` - $4.99
    - `com.sanctumruins.class.bargainer` - $4.99
    - `com.sanctumruins.bundle.allclasses` - $19.99
  - [ ] Set up sandbox test accounts
- [ ] Create PurchaseService (AC: 2, 5, 7)
  - [ ] Initialize store connection
  - [ ] Fetch product info (prices, descriptions)
  - [ ] Handle purchase flow
  - [ ] Handle errors gracefully
  - [ ] Unlock class on successful purchase
- [ ] Receipt validation (AC: 3)
  - [ ] Validate receipts locally or via server
  - [ ] Persist purchase state
  - [ ] Check ownership on app launch
- [ ] Restore purchases (AC: 4)
  - [ ] Implement restore button in settings
  - [ ] Re-validate and unlock owned content
  - [ ] Handle "no purchases to restore" case
- [ ] Purchase UI (AC: 6, 7)
  - [ ] Show purchase buttons on locked classes
  - [ ] Display localized prices
  - [ ] Loading state during purchase
  - [ ] Success/failure feedback
- [ ] Testing (AC: 8)
  - [ ] Configure sandbox environment
  - [ ] Test purchase flow end-to-end
  - [ ] Test restore functionality
  - [ ] Test failure scenarios
- [ ] App Store compliance (AC: 10)
  - [ ] No external payment links (3.1.1)
  - [ ] Accurate in-app purchase descriptions
  - [ ] Privacy policy update if needed

## Dev Notes

### Plugin Options

**Option 1: @capawesome/capacitor-in-app-purchases**
- Modern Capacitor-native plugin
- Good TypeScript support
- Uses StoreKit 2

**Option 2: cordova-plugin-purchase (via Capacitor)**
- More mature, battle-tested
- Larger community
- Supports both StoreKit 1 and 2

Recommend: Start with cordova-plugin-purchase for maturity.

### Purchase Flow

```typescript
// src/services/PurchaseService.ts
import { Purchases } from 'cordova-plugin-purchase';

class PurchaseService {
  private products: Map<string, Product> = new Map();

  async initialize(): Promise<void> {
    // Register products
    CdvPurchase.store.register([
      { id: 'com.sanctumruins.class.diabolist', type: CdvPurchase.ProductType.NON_CONSUMABLE },
      { id: 'com.sanctumruins.class.oathsworn', type: CdvPurchase.ProductType.NON_CONSUMABLE },
      // ... more products
    ]);

    // Handle approved purchases
    CdvPurchase.store.when()
      .approved(transaction => this.handleApproved(transaction))
      .verified(receipt => this.handleVerified(receipt));

    await CdvPurchase.store.initialize([CdvPurchase.Platform.APPLE_APPSTORE]);
  }

  async purchaseClass(classId: string): Promise<boolean> {
    const productId = `com.sanctumruins.class.${classId}`;
    const product = this.products.get(productId);
    if (!product) return false;

    const offer = product.getOffer();
    if (!offer) return false;

    await offer.order();
    return true; // Actual unlock happens in approved handler
  }

  private handleApproved(transaction: Transaction): void {
    transaction.verify();
  }

  private handleVerified(receipt: VerifiedReceipt): void {
    // Unlock the class
    const classId = this.extractClassId(receipt.productId);
    GameState.unlockClass(classId);
    receipt.finish();
  }

  async restorePurchases(): Promise<void> {
    await CdvPurchase.store.restorePurchases();
  }
}
```

### App Store Product Configuration

| Product ID | Type | Price Tier | Reference Name |
|------------|------|------------|----------------|
| class.diabolist | Non-Consumable | 5 ($4.99) | Diabolist Class |
| class.oathsworn | Non-Consumable | 5 ($4.99) | Oathsworn Class |
| class.feytouched | Non-Consumable | 5 ($4.99) | Fey-Touched Class |
| class.celestial | Non-Consumable | 5 ($4.99) | Celestial Class |
| class.summoner | Non-Consumable | 5 ($4.99) | Summoner Class |
| class.bargainer | Non-Consumable | 5 ($4.99) | Bargainer Class |
| bundle.allclasses | Non-Consumable | 20 ($19.99) | All Classes Bundle |

### Testing Checklist
- [ ] Fresh install, no purchases
- [ ] Purchase single class
- [ ] Purchase bundle
- [ ] Restore on new device
- [ ] Cancel during purchase
- [ ] Payment declined
- [ ] Network failure during purchase

### Relevant Files
- `src/services/PurchaseService.ts` (new)
- `src/ui/screens/ClassSelectScreen.ts` - add purchase buttons
- `src/data/classes.ts` - add isPremium flag
- `ios/App/App/Info.plist` - IAP capability

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-04 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

_To be filled by Dev agent_

---

## QA Results

_To be filled by QA agent_
