# Story 5.2: Meta-Progression System (Soul Echoes)

## Status: Approved

## Story

**As a** player,
**I want** to spend Soul Echoes on permanent upgrades,
**so that** I feel progression between runs and can customize my playstyle.

## Acceptance Criteria

1. Soul Echoes persist across all runs and sessions
2. Soul Echoes can be spent on permanent upgrades
3. Upgrades are organized into categories with unlock trees
4. Some upgrades are class-specific, others universal
5. Upgrades provide meaningful but not game-breaking bonuses
6. Players can respec upgrades (with cost)
7. UI clearly shows available upgrades and costs

## Tasks / Subtasks

- [ ] Design universal upgrade tree (AC: 2, 3, 4)
  - [ ] **Vitality Path** (HP & Survival)
    - [ ] Iron Constitution I (50 SE): +3 max HP
    - [ ] Iron Constitution II (100 SE): +5 max HP (requires I)
    - [ ] Iron Constitution III (200 SE): +7 max HP (requires II)
    - [ ] Second Wind (150 SE): Start each run with 1 Health Potion
    - [ ] Resilient Body (250 SE): Heal 2 HP after each combat
    - [ ] Death's Door (400 SE): First fatal hit per run leaves you at 1 HP instead

  - [ ] **Resolve Path** (Resource & Cards)
    - [ ] Mental Fortitude I (75 SE): +1 starting Resolve (4 total)
    - [ ] Mental Fortitude II (200 SE): +1 starting Resolve (5 total, requires I)
    - [ ] Quick Draw (100 SE): Draw 1 extra card on turn 1 of each combat
    - [ ] Efficient Mind (150 SE): First card each combat costs 1 less Resolve
    - [ ] Deep Pockets (100 SE): Start runs with +25 gold
    - [ ] Merchant's Friend (200 SE): 10% discount at merchants

  - [ ] **Combat Path** (Damage & Block)
    - [ ] Sharp Blades (75 SE): +1 damage on all attacks
    - [ ] Thick Skin (75 SE): +1 block on all block cards
    - [ ] Critical Training (150 SE): 5% chance for attacks to deal double damage
    - [ ] Defensive Stance (150 SE): Start each combat with 3 block
    - [ ] Momentum (250 SE): After playing 3 cards in a turn, gain 2 Might
    - [ ] Perseverance (300 SE): When reduced below 25% HP, gain 10 block (once per combat)

  - [ ] **Fortune Path** (Luck & Rewards)
    - [ ] Lucky Start (100 SE): Start each run with a random common relic
    - [ ] Treasure Hunter (150 SE): +15% gold from all sources
    - [ ] Card Collector (125 SE): See 4 cards instead of 3 on card rewards
    - [ ] Potion Finder (100 SE): +10% potion drop chance
    - [ ] Rare Finder (300 SE): +3% rare card drop chance
    - [ ] Elite Rewards (200 SE): Elites always drop a potion

- [ ] Design class-specific upgrades (AC: 4)
  - [ ] **Cleric Upgrades**
    - [ ] Faithful Start (100 SE): Start combats with 2 Devotion
    - [ ] Empowered Healing (150 SE): Healing generates +1 Devotion
    - [ ] Divine Protection (200 SE): Devotion abilities cost 1 less

  - [ ] **Dungeon Knight Upgrades**
    - [ ] Armored Start (100 SE): Start combats with 5 Fortify
    - [ ] Steel Will (150 SE): Fortify cap increased by 5
    - [ ] Counter Stance (200 SE): When at max Fortify, reflect 2 damage

  - [ ] **Diabolist Upgrades**
    - [ ] Blood Familiar (100 SE): Start combats with a Pain card exhausted (not in deck)
    - [ ] Curse Affinity (150 SE): Curses deal 1 less damage when drawn
    - [ ] Contract Negotiator (200 SE): Contract penalties reduced by 25%

  - [ ] **Oathsworn Upgrades**
    - [ ] Vow of Preparation (100 SE): Start combats with Oath of Valor active (2 charges)
    - [ ] Extended Oath (150 SE): All Vows have +1 charge
    - [ ] Forgiveness (200 SE): First Vow break per combat has no penalty

  - [ ] **Fey-Touched Upgrades**
    - [ ] Lucky Charm (100 SE): Start combats with 3 Luck
    - [ ] Chaos Affinity (150 SE): Whimsy outcomes are 20% better on average
    - [ ] Reroll (200 SE): Once per combat, reroll a Whimsy outcome

- [ ] Implement upgrade data structure
  - [ ] Create `src/data/upgrades.ts`
  - [ ] Define Upgrade interface with prerequisites
  - [ ] Define unlock trees
  - [ ] Define effects

- [ ] Implement upgrade service
  - [ ] Create `src/services/UpgradeService.ts`
  - [ ] Track purchased upgrades
  - [ ] Check prerequisites
  - [ ] Deduct Soul Echoes
  - [ ] Apply upgrade effects to runs

- [ ] Implement upgrade effects in game systems
  - [ ] Apply stat bonuses at run start
  - [ ] Apply combat bonuses at combat start
  - [ ] Apply card effects during play
  - [ ] Apply reward modifiers

- [ ] Implement respec system (AC: 6)
  - [ ] Respec costs 50% of spent Soul Echoes
  - [ ] Confirmation dialog
  - [ ] Refunds all upgrades
  - [ ] Tracks total SE spent for respec cost

- [ ] Implement upgrade UI (AC: 7)
  - [ ] Create `src/ui/UpgradeScreen.ts`
  - [ ] Tree visualization with paths
  - [ ] Available/locked/purchased states
  - [ ] Cost display
  - [ ] Current Soul Echoes display
  - [ ] Respec button

- [ ] Write unit tests
  - [ ] Test upgrade purchase
  - [ ] Test prerequisite checking
  - [ ] Test Soul Echo deduction
  - [ ] Test upgrade effects apply
  - [ ] Test respec refunds correctly

## Dev Notes

### Upgrade Philosophy

Meta-progression should:
1. **Feel rewarding** - Each unlock provides noticeable benefit
2. **Not trivialize the game** - Bonuses are small but meaningful
3. **Encourage experimentation** - Different builds suit different upgrades
4. **Respect player time** - Full unlock takes ~50 hours, not 500

### Upgrade Data Structure

```typescript
// src/types/upgrades.ts
export interface Upgrade {
  id: string;
  name: string;
  description: string;
  cost: number;
  path: 'vitality' | 'resolve' | 'combat' | 'fortune' | 'class';
  classId?: CharacterClassId; // Only for class upgrades
  prerequisites: string[]; // Upgrade IDs required
  effect: UpgradeEffect;
  tier: 1 | 2 | 3; // Visual positioning in tree
}

export type UpgradeEffect =
  | { type: 'max_hp'; amount: number }
  | { type: 'starting_resolve'; amount: number }
  | { type: 'starting_gold'; amount: number }
  | { type: 'starting_block'; amount: number }
  | { type: 'damage_bonus'; amount: number }
  | { type: 'block_bonus'; amount: number }
  | { type: 'card_reward_count'; amount: number }
  | { type: 'gold_multiplier'; percent: number }
  | { type: 'starting_relic'; rarity: 'common' }
  | { type: 'starting_potion'; potionId: string }
  | { type: 'merchant_discount'; percent: number }
  | { type: 'crit_chance'; percent: number }
  | { type: 'class_specific'; classId: CharacterClassId; effect: ClassUpgradeEffect };
```

### Upgrade Definitions

```typescript
// src/data/upgrades.ts
export const UPGRADES: Upgrade[] = [
  // Vitality Path
  {
    id: 'iron_constitution_1',
    name: 'Iron Constitution I',
    description: '+3 max HP',
    cost: 50,
    path: 'vitality',
    prerequisites: [],
    effect: { type: 'max_hp', amount: 3 },
    tier: 1,
  },
  {
    id: 'iron_constitution_2',
    name: 'Iron Constitution II',
    description: '+5 max HP',
    cost: 100,
    path: 'vitality',
    prerequisites: ['iron_constitution_1'],
    effect: { type: 'max_hp', amount: 5 },
    tier: 2,
  },
  {
    id: 'deaths_door',
    name: "Death's Door",
    description: 'First fatal hit per run leaves you at 1 HP instead.',
    cost: 400,
    path: 'vitality',
    prerequisites: ['iron_constitution_2'],
    effect: { type: 'deaths_door' },
    tier: 3,
  },

  // Class - Cleric
  {
    id: 'cleric_faithful_start',
    name: 'Faithful Start',
    description: 'Start combats with 2 Devotion.',
    cost: 100,
    path: 'class',
    classId: CharacterClassId.CLERIC,
    prerequisites: [],
    effect: { type: 'class_specific', classId: CharacterClassId.CLERIC,
      effect: { type: 'starting_devotion', amount: 2 } },
    tier: 1,
  },
];
```

### Upgrade Service

```typescript
// src/services/UpgradeService.ts
export class UpgradeService {
  private purchasedUpgrades: Set<string>;
  private totalSoulEchoesSpent: number = 0;

  constructor() {
    this.loadFromStorage();
  }

  canPurchase(upgradeId: string): { canBuy: boolean; reason?: string } {
    const upgrade = getUpgradeById(upgradeId);
    if (!upgrade) return { canBuy: false, reason: 'Upgrade not found' };

    if (this.purchasedUpgrades.has(upgradeId)) {
      return { canBuy: false, reason: 'Already purchased' };
    }

    const soulEchoes = this.getSoulEchoes();
    if (soulEchoes < upgrade.cost) {
      return { canBuy: false, reason: 'Not enough Soul Echoes' };
    }

    for (const prereq of upgrade.prerequisites) {
      if (!this.purchasedUpgrades.has(prereq)) {
        return { canBuy: false, reason: `Requires: ${getUpgradeById(prereq)?.name}` };
      }
    }

    return { canBuy: true };
  }

  purchase(upgradeId: string): boolean {
    const { canBuy } = this.canPurchase(upgradeId);
    if (!canBuy) return false;

    const upgrade = getUpgradeById(upgradeId)!;
    this.deductSoulEchoes(upgrade.cost);
    this.purchasedUpgrades.add(upgradeId);
    this.totalSoulEchoesSpent += upgrade.cost;
    this.saveToStorage();

    return true;
  }

  respec(): number {
    const refund = Math.floor(this.totalSoulEchoesSpent * 0.5);
    this.purchasedUpgrades.clear();
    this.totalSoulEchoesSpent = 0;
    this.addSoulEchoes(refund);
    this.saveToStorage();
    return refund;
  }

  getActiveUpgrades(classId?: CharacterClassId): Upgrade[] {
    return Array.from(this.purchasedUpgrades)
      .map(id => getUpgradeById(id))
      .filter(u => u && (!u.classId || u.classId === classId)) as Upgrade[];
  }

  // Apply all effects at run start
  applyToRunState(runState: RunState): void {
    const upgrades = this.getActiveUpgrades(runState.classId);

    for (const upgrade of upgrades) {
      switch (upgrade.effect.type) {
        case 'max_hp':
          runState.maxHp += upgrade.effect.amount;
          runState.currentHp += upgrade.effect.amount;
          break;
        case 'starting_gold':
          runState.gold += upgrade.effect.amount;
          break;
        case 'starting_relic':
          const relic = getRandomRelic(upgrade.effect.rarity);
          runState.relics.push(relic);
          break;
        // ... etc
      }
    }
  }
}
```

### Applying Effects During Combat

```typescript
// In CombatEngine or wrapper
function applyUpgradesToCombat(upgrades: Upgrade[]): void {
  for (const upgrade of upgrades) {
    switch (upgrade.effect.type) {
      case 'starting_block':
        this.state.player.block += upgrade.effect.amount;
        break;
      case 'damage_bonus':
        this.damageBonus += upgrade.effect.amount;
        break;
      case 'class_specific':
        this.applyClassUpgrade(upgrade.effect);
        break;
    }
  }
}

// In damage calculation
function calculateDamage(baseDamage: number): number {
  let damage = baseDamage + this.damageBonus;

  if (this.hasUpgrade('critical_training')) {
    if (Math.random() < 0.05) {
      damage *= 2;
      this.addCombatLog('Critical hit!');
    }
  }

  return damage;
}
```

### Upgrade Tree UI Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SOUL SANCTUM                               Soul Echoes: 450 ðŸ”®    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [Vitality] [Resolve] [Combat] [Fortune] [Class: Cleric]           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                           VITALITY PATH                            â”‚
â”‚                                                                    â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚     â”‚ Iron Const Iâ”‚                                                â”‚
â”‚     â”‚  +3 max HP  â”‚â—€â”€â”€ Tier 1                                      â”‚
â”‚     â”‚   âœ“ 50 SE   â”‚                                                â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚            â”‚                                                       â”‚
â”‚            â–¼                                                       â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚     â”‚Iron Const IIâ”‚      â”‚ Second Wind â”‚                          â”‚
â”‚     â”‚  +5 max HP  â”‚      â”‚Start w/     â”‚â—€â”€â”€ Tier 2                â”‚
â”‚     â”‚   100 SE    â”‚      â”‚Health Potionâ”‚                          â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â”‚   150 SE    â”‚                          â”‚
â”‚            â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚            â–¼                                                       â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚     â”‚Iron Const 3 â”‚      â”‚Resilient    â”‚                          â”‚
â”‚     â”‚  +7 max HP  â”‚      â”‚Body         â”‚â—€â”€â”€ Tier 3                â”‚
â”‚     â”‚   200 SE    â”‚      â”‚Heal 2/combatâ”‚                          â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â”‚   250 SE    â”‚                          â”‚
â”‚            â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚            â–¼                                                       â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚     â”‚ Death's Doorâ”‚                                                â”‚
â”‚     â”‚Survive fatalâ”‚â—€â”€â”€ Tier 4 (Capstone)                          â”‚
â”‚     â”‚   400 SE    â”‚                                                â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚                                                                    â”‚
â”‚  [Respec All: 375 SE refund]                              [Back]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Balance Notes

**Total Soul Echoes to unlock everything:**
- Vitality (6 upgrades): ~1,150 SE
- Resolve (6 upgrades): ~825 SE
- Combat (6 upgrades): ~1,000 SE
- Fortune (6 upgrades): ~975 SE
- Per Class (3 upgrades Ã— 5): ~2,250 SE
- **Total: ~6,200 SE**

With ~1,750 SE available from achievements, players need ~4,450 SE from runs.
At ~50 SE per winning run, that's ~90 wins for full unlock (dedicated players).

**Power Budget:**
- Max bonus HP: +15 (20% increase for 75 HP class)
- Max damage bonus: +1 (small but consistent)
- Max starting Resolve: +2 (significant early game boost)

## Testing

### Test File Location
`src/tests/services/UpgradeService.test.ts`

### Key Test Scenarios

1. **Purchase**: Correct SE deduction, upgrade added
2. **Prerequisites**: Can't buy without prereqs
3. **Insufficient Funds**: Can't buy without enough SE
4. **No Duplicates**: Can't buy same upgrade twice
5. **Effect Application**: Stats correctly modified at run start
6. **Respec**: Correct refund amount, all upgrades cleared
7. **Class Filtering**: Class upgrades only apply to that class

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-03 | 1.0 | Initial story creation | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_
