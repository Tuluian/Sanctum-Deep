# Epic 14: Cloud Save & User Accounts

## Status: Planning

## Epic Overview

**As a** player,
**I want** to create an account and sync my progress to the cloud,
**so that** I can play on multiple devices without losing my progress, achievements, or purchases.

## Context & Decisions

This epic was defined through a brainstorming session on 2024-12-05. Key decisions made:

| Decision | Choice | Rationale |
|----------|--------|-----------|
| **Database** | Heroku Postgres (lower tier, scalable) | Cost-effective, familiar, easy to scale |
| **Auth Providers** | Google OAuth + Email/Password | Google for convenience, email for universal fallback |
| **Guest Mode** | Required - play without account | Remove friction, let players try before committing |
| **Conflict Resolution** | Last-write-wins (timestamp) | Simple, predictable, no user prompts |
| **Settings Sync** | Device-specific (no sync) | Volume/preferences are personal to device |
| **Offline Play** | 100% supported | localStorage is primary, cloud is backup |
| **Sync Triggers** | App load, run end, account creation, manual button | Balance between freshness and API calls |

## Data Sync Scope

| Data | Syncs to Cloud? | Notes |
|------|-----------------|-------|
| Soul Echoes | Yes | Meta currency |
| Achievements | Yes | Unlocked achievements list |
| Purchased Upgrades | Yes | Upgrade tree progress |
| Purchased Classes | Yes | DLC ownership |
| Statistics | Yes | Play history |
| Active Run | Yes | Current run state |
| Settings | No | Device-specific |

## Stories in This Epic

### Infrastructure (Backend)
- [14.1 - Heroku Postgres Setup](./14.1-heroku-postgres-setup.md)
- [14.2 - Database Schema (Users & Auth)](./14.2-database-schema-users-auth.md)
- [14.3 - Save Data Schema](./14.3-save-data-schema.md)
- [14.4 - API Layer Setup](./14.4-api-layer-setup.md)

### Authentication
- [14.5 - Guest Mode](./14.5-guest-mode.md)
- [14.6 - Google OAuth Integration](./14.6-google-oauth-integration.md)
- [14.7 - Email/Password Auth](./14.7-email-password-auth.md)
- [14.8 - Guest-to-Account Conversion](./14.8-guest-to-account-conversion.md)

### Sync System
- [14.9 - SaveManager Refactor](./14.9-savemanager-refactor.md)
- [14.10 - Cloud Sync on App Load](./14.10-cloud-sync-app-load.md)
- [14.11 - Cloud Sync on Run End](./14.11-cloud-sync-run-end.md)
- [14.12 - Offline Queue & Retry](./14.12-offline-queue-retry.md)
- [14.13 - Manual Cloud Save Button](./14.13-manual-cloud-save.md)

### Account UI
- [14.14 - Login/Register Screen](./14.14-login-register-screen.md)
- [14.15 - Account Menu & Sync Status](./14.15-account-menu-sync-status.md)
- [14.16 - Create Account Prompt for Guests](./14.16-guest-account-prompt.md)

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                        GAME CLIENT                               │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │ SaveManager │──│ AuthService │──│   CloudSyncService      │  │
│  │ (localStorage│  │             │  │   - syncOnLoad()        │  │
│  │  primary)    │  │             │  │   - syncOnRunEnd()      │  │
│  └─────────────┘  └─────────────┘  │   - queueOfflineSync()  │  │
│         │                │         └───────────┬─────────────┘  │
│         │                │                     │                 │
│         ▼                ▼                     ▼                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │ localStorage │  │ OAuth Popup │  │      REST API           │  │
│  └─────────────┘  │ (Google)    │  │  /api/auth/*            │  │
│                   └─────────────┘  │  /api/sync/*            │  │
│                                    └───────────┬─────────────┘  │
└────────────────────────────────────────────────┼────────────────┘
                                                 │
                                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                     HEROKU BACKEND                               │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    Express API                           │    │
│  │  POST /api/auth/register    POST /api/auth/login        │    │
│  │  POST /api/auth/google      POST /api/auth/refresh      │    │
│  │  GET  /api/sync/pull        POST /api/sync/push         │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                 Heroku Postgres                          │    │
│  │  users, oauth_connections, save_data, purchases         │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

## Sync Flow

```
1. Player opens game
   ├─ Not logged in → Use localStorage only (guest mode)
   └─ Logged in → Pull from cloud
       ├─ No cloud data → Continue with localStorage
       ├─ Cloud newer → Load cloud data into localStorage
       └─ Local newer → Keep local, push to cloud

2. Player ends run (victory/defeat)
   ├─ Not logged in → Save to localStorage only
   └─ Logged in → Save to localStorage AND push to cloud
       └─ Push fails → Queue for retry on next load

3. Player creates account (was guest)
   └─ Push localStorage to cloud (first sync)

4. Player clicks "Save to Cloud" button
   └─ Force push localStorage to cloud
```

## Dependencies

- Story 5.5 (original cloud sync story) - This epic supersedes it with granular stories
- Heroku account and billing setup (manual prerequisite)
- Google Cloud Console project for OAuth (existing)

## Out of Scope

- Discord OAuth (may add later)
- Leaderboards
- Account deletion / GDPR (separate future story)
- Password reset flow (separate future story)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-05 | 1.0 | Epic created from brainstorming session | Mary (Analyst) |

---

*Generated using BMAD-METHOD brainstorming framework*
