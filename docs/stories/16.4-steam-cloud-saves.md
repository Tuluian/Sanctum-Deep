# Story 16.4: Steam Cloud Saves

## Status: Draft

## Story

**As a** player on Steam,
**I want** my game progress to sync via Steam Cloud,
**so that** I can continue playing on any computer with my Steam account.

## Acceptance Criteria

1. Steam Cloud configured in Steamworks dashboard
2. Save data uploads to Steam Cloud automatically
3. Save data downloads on game launch
4. Conflict resolution handles multiple devices
5. Cloud saves work alongside local saves
6. Save size stays within Steam Cloud limits
7. Cloud sync status visible to player

## Tasks / Subtasks

- [ ] Configure Steam Cloud in Steamworks (AC: 1)
  - [ ] Enable Steam Cloud for app
  - [ ] Set storage quota (100KB-1MB typical for save data)
  - [ ] Configure file paths for sync
- [ ] Implement save upload (AC: 2)
  - [ ] Write save data to Steam Cloud path
  - [ ] Trigger upload after save
  - [ ] Handle upload failures gracefully
- [ ] Implement save download (AC: 3)
  - [ ] Check for cloud save on launch
  - [ ] Download if newer than local
  - [ ] Apply cloud save data
- [ ] Handle conflicts (AC: 4)
  - [ ] Detect cloud vs local conflict
  - [ ] Compare timestamps
  - [ ] Let user choose or auto-resolve
- [ ] Integrate with SaveManager (AC: 5)
  - [ ] Cloud sync supplements local save
  - [ ] Local always available as fallback
- [ ] Monitor save size (AC: 6)
  - [ ] Track save data size
  - [ ] Warn if approaching limit
  - [ ] Optimize save format if needed
- [ ] Show sync status (AC: 7)
  - [ ] Display cloud sync icon in UI
  - [ ] Show last sync time
  - [ ] Indicate sync in progress

## Dev Notes

### Steam Cloud Configuration

In Steamworks dashboard:
1. Go to App Admin ‚Üí Steam Cloud
2. Enable Steam Cloud
3. Set byte quota (e.g., 1048576 = 1MB)
4. Set file count quota (e.g., 10)
5. Add file path pattern: `saves/*`

### Steam Cloud API Usage

```javascript
// electron/steamCloud.js
const steamworks = require('steamworks.js');

class SteamCloudService {
  isEnabled() {
    return steamworks.cloud.isEnabledForAccount() &&
           steamworks.cloud.isEnabledForApp();
  }

  async writeFile(filename, data) {
    if (!this.isEnabled()) return false;

    try {
      const buffer = Buffer.from(JSON.stringify(data));
      return steamworks.cloud.writeFile(filename, buffer);
    } catch (error) {
      console.error('Steam Cloud write failed:', error);
      return false;
    }
  }

  async readFile(filename) {
    if (!this.isEnabled()) return null;

    try {
      if (!steamworks.cloud.fileExists(filename)) {
        return null;
      }
      const buffer = steamworks.cloud.readFile(filename);
      return JSON.parse(buffer.toString());
    } catch (error) {
      console.error('Steam Cloud read failed:', error);
      return null;
    }
  }

  async deleteFile(filename) {
    if (!this.isEnabled()) return false;

    try {
      return steamworks.cloud.deleteFile(filename);
    } catch (error) {
      console.error('Steam Cloud delete failed:', error);
      return false;
    }
  }

  getQuotaInfo() {
    return {
      total: steamworks.cloud.getQuota(),
      available: steamworks.cloud.getAvailableQuota(),
    };
  }

  getFileTimestamp(filename) {
    if (!steamworks.cloud.fileExists(filename)) return 0;
    return steamworks.cloud.getFileTimestamp(filename);
  }
}

module.exports = new SteamCloudService();
```

### IPC Handlers

```javascript
// electron/main.js
const steamCloud = require('./steamCloud');

ipcMain.handle('steam-cloud-save', async (event, filename, data) => {
  return steamCloud.writeFile(filename, data);
});

ipcMain.handle('steam-cloud-load', async (event, filename) => {
  return steamCloud.readFile(filename);
});

ipcMain.handle('steam-cloud-timestamp', async (event, filename) => {
  return steamCloud.getFileTimestamp(filename);
});

ipcMain.handle('steam-cloud-quota', async () => {
  return steamCloud.getQuotaInfo();
});
```

### Preload Exposure

```javascript
// electron/preload.js
contextBridge.exposeInMainWorld('steam', {
  // ... existing methods
  cloud: {
    save: (filename, data) => ipcRenderer.invoke('steam-cloud-save', filename, data),
    load: (filename) => ipcRenderer.invoke('steam-cloud-load', filename),
    getTimestamp: (filename) => ipcRenderer.invoke('steam-cloud-timestamp', filename),
    getQuota: () => ipcRenderer.invoke('steam-cloud-quota'),
  },
});
```

### Integration with SaveManager

```typescript
// src/services/SaveManager.ts
class SaveManager {
  private steamCloudAvailable = typeof window.steam?.cloud !== 'undefined';

  async save(data: SaveData): Promise<void> {
    // Always save locally first
    localStorage.setItem('sanctum_save', JSON.stringify(data));

    // Then sync to Steam Cloud
    if (this.steamCloudAvailable) {
      await this.syncToCloud(data);
    }
  }

  async load(): Promise<SaveData | null> {
    const localData = this.loadLocal();

    if (this.steamCloudAvailable) {
      const cloudData = await this.loadFromCloud();

      if (cloudData && localData) {
        // Conflict resolution
        return this.resolveConflict(localData, cloudData);
      } else if (cloudData) {
        return cloudData;
      }
    }

    return localData;
  }

  private async syncToCloud(data: SaveData): Promise<void> {
    try {
      await window.steam.cloud.save('save.json', data);
      console.log('Saved to Steam Cloud');
    } catch (error) {
      console.error('Steam Cloud sync failed:', error);
    }
  }

  private async loadFromCloud(): Promise<SaveData | null> {
    try {
      return await window.steam.cloud.load('save.json');
    } catch (error) {
      console.error('Steam Cloud load failed:', error);
      return null;
    }
  }

  private resolveConflict(local: SaveData, cloud: SaveData): SaveData {
    // Compare timestamps, use newer
    // Or compare progress, use more advanced
    if (cloud.lastModified > local.lastModified) {
      console.log('Using Steam Cloud save (newer)');
      return cloud;
    } else {
      console.log('Using local save (newer)');
      return local;
    }
  }
}
```

### Save Data Size Optimization

Keep save data small:
```typescript
interface OptimizedSaveData {
  v: number;                    // Version
  t: number;                    // Timestamp
  u: string[];                  // Unlocked classes (IDs only)
  a: string[];                  // Achievements (IDs only)
  g: number;                    // Gold
  r: number;                    // Total runs
  w: number;                    // Wins
  up: Record<string, number>;   // Upgrades (ID -> level)
  // Avoid storing full card/enemy objects
}
```

### Sync Status UI

```typescript
// src/ui/components/CloudSyncStatus.ts
class CloudSyncStatus {
  private lastSync: Date | null = null;
  private syncing = false;

  render(): string {
    if (this.syncing) {
      return '<span class="sync-icon syncing">‚òÅÔ∏è</span>';
    } else if (this.lastSync) {
      return `<span class="sync-icon synced" title="Last sync: ${this.lastSync.toLocaleString()}">‚òÅÔ∏è‚úì</span>`;
    } else {
      return '<span class="sync-icon no-cloud">üíæ</span>';
    }
  }
}
```

### Relevant Files
- `electron/steamCloud.js` (new)
- `electron/main.js` (add IPC handlers)
- `electron/preload.js` (add cloud methods)
- `src/services/SaveManager.ts` (modify)
- `src/ui/components/CloudSyncStatus.ts` (new)

## Testing

- Test file location: N/A (integration testing)
- Manual verification:
  - Save game, verify upload to Steam Cloud
  - Load on different PC, verify save downloads
  - Create conflict, verify resolution works
  - Check Steam Cloud storage in Steam client

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-05 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

_To be filled by Dev agent_

---

## QA Results

_To be filled by QA agent_
