# Story 14.14: Login/Register Screen

## Status: Draft

## Story

**As a** player,
**I want** a dedicated screen to log in or create an account,
**so that** I can access cloud saves and sync my progress across devices.

## Acceptance Criteria

1. Login/Register screen is accessible from main menu
2. Screen has tabs for Login and Sign Up
3. Sign Up form collects display name, email, password
4. Login form collects email, password
5. "Sign in with Google" button is prominent
6. Form validation shows errors inline
7. Loading states during auth operations
8. "Continue as Guest" option is always available
9. Successful auth returns to previous screen with sync complete

## Tasks

- [ ] Create AuthScreen component
- [ ] Implement tab switching (Login/Sign Up)
- [ ] Build login form with validation
- [ ] Build registration form with validation
- [ ] Add Google OAuth button
- [ ] Add "Continue as Guest" link
- [ ] Integrate with AuthService
- [ ] Handle and display errors
- [ ] Show loading states
- [ ] Redirect after successful auth

## Technical Notes

### Screen Layout

```
┌─────────────────────────────────────────────┐
│  ← Back                     SANCTUM RUINS   │
├─────────────────────────────────────────────┤
│                                             │
│     ┌─────────────┬─────────────┐          │
│     │   Sign In   │   Sign Up   │          │
│     └─────────────┴─────────────┘          │
│                                             │
│   ┌───────────────────────────────────┐    │
│   │  [G] Sign in with Google          │    │
│   └───────────────────────────────────┘    │
│                                             │
│              ─── or ───                     │
│                                             │
│   Email                                     │
│   ┌───────────────────────────────────┐    │
│   │ email@example.com                 │    │
│   └───────────────────────────────────┘    │
│                                             │
│   Password                                  │
│   ┌───────────────────────────────────┐    │
│   │ ••••••••                          │    │
│   └───────────────────────────────────┘    │
│                                             │
│   ┌───────────────────────────────────┐    │
│   │           Sign In                 │    │
│   └───────────────────────────────────┘    │
│                                             │
│          Continue as Guest                  │
│                                             │
└─────────────────────────────────────────────┘
```

### AuthScreen Component

```typescript
// src/ui/screens/AuthScreen.ts

type AuthTab = 'login' | 'signup';

class AuthScreen {
  private currentTab: AuthTab = 'login';
  private isLoading: boolean = false;
  private errorMessage: string | null = null;
  private returnTo: string = 'main-menu';

  constructor(returnTo?: string) {
    if (returnTo) this.returnTo = returnTo;
  }

  render(): string {
    return `
      <div class="auth-screen">
        <header class="auth-header">
          <button class="back-btn" onclick="navigateTo('${this.returnTo}')">
            ← Back
          </button>
          <h1>Sanctum Ruins</h1>
        </header>

        <div class="auth-container">
          ${this.renderTabs()}
          ${this.renderGoogleButton()}
          ${this.renderDivider()}
          ${this.currentTab === 'login' ? this.renderLoginForm() : this.renderSignupForm()}
          ${this.renderGuestOption()}
        </div>
      </div>
    `;
  }

  private renderTabs(): string {
    return `
      <div class="auth-tabs">
        <button
          class="auth-tab ${this.currentTab === 'login' ? 'active' : ''}"
          onclick="authScreen.setTab('login')"
        >
          Sign In
        </button>
        <button
          class="auth-tab ${this.currentTab === 'signup' ? 'active' : ''}"
          onclick="authScreen.setTab('signup')"
        >
          Sign Up
        </button>
      </div>
    `;
  }

  private renderGoogleButton(): string {
    return `
      <button
        class="oauth-btn google"
        onclick="authScreen.loginWithGoogle()"
        ${this.isLoading ? 'disabled' : ''}
      >
        <svg class="google-icon" viewBox="0 0 24 24" width="20" height="20">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        Sign in with Google
      </button>
    `;
  }

  private renderDivider(): string {
    return `<div class="auth-divider"><span>or</span></div>`;
  }

  private renderLoginForm(): string {
    return `
      <form class="auth-form" onsubmit="authScreen.handleLogin(event)">
        ${this.errorMessage ? `<div class="error-banner">${this.errorMessage}</div>` : ''}

        <div class="form-group">
          <label for="login-email">Email</label>
          <input
            type="email"
            id="login-email"
            name="email"
            required
            autocomplete="email"
          />
        </div>

        <div class="form-group">
          <label for="login-password">Password</label>
          <input
            type="password"
            id="login-password"
            name="password"
            required
            autocomplete="current-password"
          />
        </div>

        <button type="submit" class="btn primary" ${this.isLoading ? 'disabled' : ''}>
          ${this.isLoading ? '<span class="spinner"></span> Signing in...' : 'Sign In'}
        </button>
      </form>
    `;
  }

  private renderSignupForm(): string {
    return `
      <form class="auth-form" onsubmit="authScreen.handleSignup(event)">
        ${this.errorMessage ? `<div class="error-banner">${this.errorMessage}</div>` : ''}

        <div class="form-group">
          <label for="signup-name">Display Name</label>
          <input
            type="text"
            id="signup-name"
            name="displayName"
            required
            minlength="1"
            maxlength="50"
            autocomplete="name"
          />
        </div>

        <div class="form-group">
          <label for="signup-email">Email</label>
          <input
            type="email"
            id="signup-email"
            name="email"
            required
            autocomplete="email"
          />
        </div>

        <div class="form-group">
          <label for="signup-password">Password</label>
          <input
            type="password"
            id="signup-password"
            name="password"
            required
            minlength="8"
            autocomplete="new-password"
          />
          <small class="hint">Minimum 8 characters</small>
        </div>

        <button type="submit" class="btn primary" ${this.isLoading ? 'disabled' : ''}>
          ${this.isLoading ? '<span class="spinner"></span> Creating account...' : 'Create Account'}
        </button>
      </form>
    `;
  }

  private renderGuestOption(): string {
    return `
      <p class="guest-option">
        <a href="#" onclick="navigateTo('${this.returnTo}')">Continue as Guest</a>
        <br />
        <small>Progress won't sync across devices</small>
      </p>
    `;
  }

  // Event handlers
  setTab(tab: AuthTab): void {
    this.currentTab = tab;
    this.errorMessage = null;
    this.rerender();
  }

  async handleLogin(event: Event): Promise<void> {
    event.preventDefault();
    const form = event.target as HTMLFormElement;
    const formData = new FormData(form);

    const email = formData.get('email') as string;
    const password = formData.get('password') as string;

    this.isLoading = true;
    this.errorMessage = null;
    this.rerender();

    try {
      await AuthService.login(email, password);
      // Sync happens automatically in AuthService.login()
      navigateTo(this.returnTo);
      showToast({ type: 'success', message: 'Welcome back!' });
    } catch (error: any) {
      this.errorMessage = error.message || 'Login failed. Please try again.';
      this.isLoading = false;
      this.rerender();
    }
  }

  async handleSignup(event: Event): Promise<void> {
    event.preventDefault();
    const form = event.target as HTMLFormElement;
    const formData = new FormData(form);

    const displayName = formData.get('displayName') as string;
    const email = formData.get('email') as string;
    const password = formData.get('password') as string;

    this.isLoading = true;
    this.errorMessage = null;
    this.rerender();

    try {
      await AuthService.register(email, password, displayName);
      // Sync happens automatically in AuthService.register()
      navigateTo(this.returnTo);
      showToast({ type: 'success', message: 'Account created! Progress saved to cloud.' });
    } catch (error: any) {
      this.errorMessage = error.message || 'Registration failed. Please try again.';
      this.isLoading = false;
      this.rerender();
    }
  }

  async loginWithGoogle(): Promise<void> {
    this.isLoading = true;
    this.errorMessage = null;
    this.rerender();

    try {
      await AuthService.loginWithGoogle();
      navigateTo(this.returnTo);
      showToast({ type: 'success', message: 'Signed in with Google!' });
    } catch (error: any) {
      this.errorMessage = error.message || 'Google sign-in failed.';
      this.isLoading = false;
      this.rerender();
    }
  }

  private rerender(): void {
    const container = document.getElementById('screen-container');
    if (container) {
      container.innerHTML = this.render();
    }
  }
}

// Global instance for onclick handlers
let authScreen: AuthScreen;

function showAuthScreen(returnTo?: string): void {
  authScreen = new AuthScreen(returnTo);
  const container = document.getElementById('screen-container');
  if (container) {
    container.innerHTML = authScreen.render();
  }
}

(window as any).showAuthScreen = showAuthScreen;
(window as any).authScreen = authScreen;
```

### CSS Styles

```css
.auth-screen {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  background: var(--color-bg);
}

.auth-header {
  display: flex;
  align-items: center;
  padding: 1rem;
  border-bottom: 1px solid var(--color-border);
}

.auth-header .back-btn {
  background: none;
  border: none;
  color: var(--color-accent);
  cursor: pointer;
  font-size: 1rem;
}

.auth-header h1 {
  flex: 1;
  text-align: center;
  font-size: 1.25rem;
  margin-right: 3rem; /* Balance the back button */
}

.auth-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 2rem;
  max-width: 400px;
  margin: 0 auto;
  width: 100%;
}

.auth-tabs {
  display: flex;
  margin-bottom: 1.5rem;
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid var(--color-border);
}

.auth-tab {
  flex: 1;
  padding: 0.75rem;
  background: transparent;
  border: none;
  color: var(--color-muted);
  cursor: pointer;
  transition: all 0.2s;
}

.auth-tab.active {
  background: var(--color-accent);
  color: white;
}

.oauth-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.75rem;
  width: 100%;
  padding: 0.875rem;
  border: 1px solid var(--color-border);
  border-radius: 8px;
  background: white;
  color: #333;
  font-size: 1rem;
  cursor: pointer;
  transition: background 0.2s;
}

.oauth-btn:hover {
  background: #f5f5f5;
}

.auth-divider {
  display: flex;
  align-items: center;
  margin: 1.5rem 0;
}

.auth-divider::before,
.auth-divider::after {
  content: '';
  flex: 1;
  border-bottom: 1px solid var(--color-border);
}

.auth-divider span {
  padding: 0 1rem;
  color: var(--color-muted);
  font-size: 0.875rem;
}

.auth-form {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.form-group label {
  font-size: 0.875rem;
  color: var(--color-muted);
}

.form-group input {
  padding: 0.75rem;
  border: 1px solid var(--color-border);
  border-radius: 6px;
  font-size: 1rem;
  background: var(--color-input-bg);
  color: var(--color-text);
}

.form-group input:focus {
  outline: none;
  border-color: var(--color-accent);
}

.form-group .hint {
  font-size: 0.75rem;
  color: var(--color-muted);
}

.error-banner {
  padding: 0.75rem;
  background: var(--color-error-bg);
  color: var(--color-error);
  border-radius: 6px;
  font-size: 0.875rem;
}

.guest-option {
  text-align: center;
  margin-top: 1.5rem;
  font-size: 0.875rem;
}

.guest-option a {
  color: var(--color-accent);
}

.guest-option small {
  color: var(--color-muted);
}
```

## Definition of Done

- [ ] Screen renders with Login/Signup tabs
- [ ] Tab switching works
- [ ] Login form validates and submits
- [ ] Signup form validates and submits
- [ ] Google OAuth button works
- [ ] "Continue as Guest" returns to previous screen
- [ ] Error messages display correctly
- [ ] Loading states show during auth
- [ ] Successful auth navigates away and syncs

## Dependencies

- Story 14.6 (Google OAuth)
- Story 14.7 (Email/Password Auth)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-05 | 1.0 | Story created | Mary (Analyst) |
