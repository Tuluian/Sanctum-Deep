# Story 14.6: Google OAuth Integration

## Status: Draft

## Story

**As a** player,
**I want** to sign in with my Google account,
**so that** I can quickly create an account without remembering another password.

## Acceptance Criteria

1. "Sign in with Google" button appears on login screen
2. Clicking button opens Google OAuth consent screen
3. Successful auth creates user account (if new) or logs in (if existing)
4. Google profile info (name, email, avatar) is used for account
5. After auth, player's localStorage is synced to cloud
6. OAuth tokens are securely handled (not exposed to client)
7. Works on both desktop and mobile browsers

## Tasks

- [ ] Set up Google Cloud Console project (if not exists)
- [ ] Configure OAuth consent screen
- [ ] Add OAuth 2.0 credentials (web application)
- [ ] Implement backend OAuth callback endpoint
- [ ] Implement frontend OAuth popup flow
- [ ] Create/link user account on successful auth
- [ ] Store OAuth connection in database
- [ ] Trigger cloud sync after successful login
- [ ] Handle OAuth errors gracefully

## Technical Notes

### Google Cloud Console Setup

1. Go to https://console.cloud.google.com
2. Create project or select existing
3. Enable Google+ API (for profile info)
4. Configure OAuth consent screen:
   - User Type: External
   - App name: Sanctum Ruins
   - Scopes: email, profile, openid
5. Create OAuth 2.0 Client ID:
   - Type: Web application
   - Authorized redirect URIs:
     - `http://localhost:3001/api/auth/google/callback` (dev)
     - `https://your-app.herokuapp.com/api/auth/google/callback` (prod)

### Backend OAuth Flow

```typescript
// server/src/routes/auth.ts
import { Router } from 'express';
import { OAuth2Client } from 'google-auth-library';
import { config } from '../config';
import { userService } from '../services/userService';
import { tokenService } from '../services/tokenService';

const router = Router();
const googleClient = new OAuth2Client(
  config.googleClientId,
  config.googleClientSecret,
  config.googleRedirectUri
);

// Step 1: Redirect to Google
router.get('/google', (req, res) => {
  const url = googleClient.generateAuthUrl({
    access_type: 'offline',
    scope: ['email', 'profile', 'openid'],
    prompt: 'consent'
  });
  res.redirect(url);
});

// Step 2: Handle callback
router.get('/google/callback', async (req, res) => {
  const { code } = req.query;

  if (!code || typeof code !== 'string') {
    return res.redirect('/auth-error?error=no_code');
  }

  try {
    // Exchange code for tokens
    const { tokens } = await googleClient.getToken(code);
    googleClient.setCredentials(tokens);

    // Get user info
    const ticket = await googleClient.verifyIdToken({
      idToken: tokens.id_token!,
      audience: config.googleClientId
    });
    const payload = ticket.getPayload()!;

    const googleId = payload.sub;
    const email = payload.email!;
    const name = payload.name || email.split('@')[0];
    const avatar = payload.picture;

    // Find or create user
    let user = await userService.findByOAuthConnection('google', googleId);

    if (!user) {
      // Check if email already exists
      const existingUser = await userService.findByEmail(email);
      if (existingUser) {
        // Link Google to existing account
        await userService.linkOAuthConnection(existingUser.id, 'google', googleId, email);
        user = existingUser;
      } else {
        // Create new user
        user = await userService.createFromOAuth({
          provider: 'google',
          providerUserId: googleId,
          email,
          displayName: name,
          avatarUrl: avatar
        });
      }
    }

    // Generate tokens
    const accessToken = tokenService.generateAccessToken({
      userId: user.id,
      email: user.email!
    });
    const refreshToken = await tokenService.generateRefreshToken(user.id);

    // Send tokens back to client via postMessage
    res.send(`
      <html>
        <body>
          <script>
            window.opener.postMessage({
              type: 'oauth_success',
              accessToken: '${accessToken}',
              refreshToken: '${refreshToken}',
              user: ${JSON.stringify(user)}
            }, '${config.clientOrigin}');
            window.close();
          </script>
        </body>
      </html>
    `);
  } catch (error) {
    console.error('Google OAuth error:', error);
    res.send(`
      <html>
        <body>
          <script>
            window.opener.postMessage({
              type: 'oauth_error',
              message: 'Authentication failed'
            }, '${config.clientOrigin}');
            window.close();
          </script>
        </body>
      </html>
    `);
  }
});

export { router as googleAuthRouter };
```

### Frontend OAuth Flow

```typescript
// src/services/AuthService.ts

async loginWithGoogle(): Promise<void> {
  return new Promise((resolve, reject) => {
    // Open popup
    const width = 500;
    const height = 600;
    const left = window.screenX + (window.innerWidth - width) / 2;
    const top = window.screenY + (window.innerHeight - height) / 2;

    const popup = window.open(
      `${API_URL}/api/auth/google`,
      'Google Login',
      `width=${width},height=${height},left=${left},top=${top}`
    );

    if (!popup) {
      reject(new Error('Popup blocked'));
      return;
    }

    // Listen for callback
    const handleMessage = (event: MessageEvent) => {
      if (event.origin !== API_URL) return;

      if (event.data.type === 'oauth_success') {
        this.setTokens(event.data.accessToken, event.data.refreshToken);
        this.user = event.data.user;
        this.notifyListeners();

        // Trigger cloud sync
        cloudSyncService.syncOnLogin().then(() => {
          resolve();
        });
      } else if (event.data.type === 'oauth_error') {
        reject(new Error(event.data.message));
      }

      window.removeEventListener('message', handleMessage);
    };

    window.addEventListener('message', handleMessage);

    // Check if popup was closed without completing
    const checkClosed = setInterval(() => {
      if (popup.closed) {
        clearInterval(checkClosed);
        window.removeEventListener('message', handleMessage);
        reject(new Error('Login cancelled'));
      }
    }, 500);
  });
}
```

### UI Button

```html
<button class="oauth-btn google" onclick="authService.loginWithGoogle()">
  <svg class="google-icon" viewBox="0 0 24 24">
    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
  </svg>
  Sign in with Google
</button>
```

## Definition of Done

- [ ] Google OAuth flow completes successfully
- [ ] New users are created with Google profile info
- [ ] Existing users can link Google account
- [ ] Tokens are issued and stored securely
- [ ] Cloud sync triggers after login
- [ ] Errors display user-friendly messages

## Dependencies

- Story 14.4 (API Layer Setup)
- Google Cloud Console project configured

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-05 | 1.0 | Story created | Mary (Analyst) |
