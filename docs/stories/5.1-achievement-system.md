# Story 5.1: Achievement System

## Status: Approved

## Story

**As a** player,
**I want** to earn achievements for accomplishing goals,
**so that** I feel rewarded for exploration and mastery, and earn Soul Echoes for permanent upgrades.

## Acceptance Criteria

1. Achievement system tracks player accomplishments across runs
2. Achievements award Soul Echoes (meta-currency) on first completion
3. Achievements have tiers: Bronze (10 SE), Silver (25 SE), Gold (50 SE), Platinum (100 SE)
4. Achievement progress persists across sessions
5. Achievement notification appears on unlock
6. Achievement gallery viewable from main menu
7. Some achievements are hidden until unlocked

## Tasks / Subtasks

- [ ] Design achievement categories and rewards
  - [ ] **Combat Achievements** (15 achievements)
    - [ ] First Blood (Bronze): Win your first combat
    - [ ] Untouchable (Silver): Win a combat without taking damage
    - [ ] Overkill (Bronze): Deal 50+ damage in a single attack
    - [ ] Massacre (Silver): Defeat 3+ enemies in a single turn
    - [ ] Perfect Defense (Silver): Block 100+ damage in a single combat
    - [ ] Devoted (Silver): Reach 20 Devotion in a single combat (Cleric)
    - [ ] Unbreakable Wall (Silver): Have 15 Fortify for 5 consecutive turns (Knight)
    - [ ] Contract Fulfilled (Silver): Have 10+ Curses and win (Diabolist)
    - [ ] Oath Keeper (Silver): Complete a combat without breaking a Vow (Oathsworn)
    - [ ] Chaos Master (Silver): Trigger 10 Whimsy effects in one combat (Fey-Touched)
    - [ ] Glass Cannon (Gold): Win a combat with 1 HP remaining
    - [ ] Speedrunner (Gold): Win a combat in 3 turns or fewer
    - [ ] No Cards Needed (Platinum): Win a combat playing only 5 cards total
    - [ ] Untouched (Platinum): Complete Act 1 without taking any damage
    - [ ] Pacifist Turn (Silver): Win a combat where you dealt 0 damage on final turn

  - [ ] **Run Achievements** (15 achievements)
    - [ ] Dungeon Delver (Bronze): Complete your first run (win or lose)
    - [ ] Survivor (Bronze): Complete Act 1
    - [ ] Deep Diver (Silver): Complete Act 2
    - [ ] Sanctum Breaker (Gold): Defeat the Hollow God
    - [ ] Minimalist (Silver): Win a run with 15 or fewer cards in deck
    - [ ] Hoarder (Silver): Win a run with 40+ cards in deck
    - [ ] Wealthy (Bronze): Finish a run with 500+ gold
    - [ ] Relic Hunter (Silver): Collect 10 relics in a single run
    - [ ] Potion Master (Bronze): Use 10 potions in a single run
    - [ ] Elite Slayer (Silver): Defeat 5 elite enemies in a single run
    - [ ] Perfect Run (Platinum): Win a run without ever dying (no Ankh Talisman)
    - [ ] Speedrun (Gold): Complete a winning run in under 20 minutes
    - [ ] Cursed Victor (Gold): Win with 5+ Curses in deck
    - [ ] Shrine Pilgrim (Silver): Visit every shrine in a single run
    - [ ] Boss Rush (Gold): Defeat all 3 bosses without resting at campfires

  - [ ] **Class Achievements** (10 achievements, 2 per class)
    - [ ] Holy Warrior (Silver): Win a run as Cleric
    - [ ] Divine Ascension (Gold): Win 5 runs as Cleric
    - [ ] Shield Bearer (Silver): Win a run as Dungeon Knight
    - [ ] Immovable Object (Gold): Win 5 runs as Dungeon Knight
    - [ ] Soul Trader (Silver): Win a run as Diabolist
    - [ ] Lord of Contracts (Gold): Win 5 runs as Diabolist
    - [ ] Vow Fulfilled (Silver): Win a run as Oathsworn
    - [ ] Eternal Oath (Gold): Win 5 runs as Oathsworn
    - [ ] Touched by Chaos (Silver): Win a run as Fey-Touched
    - [ ] Chaos Incarnate (Gold): Win 5 runs as Fey-Touched

  - [ ] **Secret Achievements** (10 achievements, hidden until unlocked)
    - [ ] The Warden's Chosen (Platinum): Become the Warden with all 5 classes
    - [ ] True Ending (Platinum): Complete the True Ending
    - [ ] Mercy (Silver): Spare an enemy (future mechanic)
    - [ ] Gambler (Silver): Win 5 combats with Fey-Touched where luck decided outcome
    - [ ] Sacrifice (Gold): Use Final Sacrifice to win a combat (Diabolist)
    - [ ] Memory Keeper (Silver): Collect all Memory Fragments in a run
    - [ ] Friend of the Warden (Silver): Choose the same dialogue option 10 times
    - [ ] Against All Odds (Gold): Win a combat with 0 cards in draw pile
    - [ ] One With Nothing (Platinum): Win a run with only starter cards
    - [ ] Hollow Victory (Gold): Defeat the Hollow God with 10+ Corruption Stacks

- [ ] Implement achievement data structure
  - [ ] Create `src/data/achievements.ts`
  - [ ] Define Achievement interface
  - [ ] Define all achievements with conditions
  - [ ] Define Soul Echo rewards per tier

- [ ] Implement achievement tracking service
  - [ ] Create `src/services/AchievementService.ts`
  - [ ] Track achievement progress
  - [ ] Check conditions after relevant events
  - [ ] Award Soul Echoes on unlock
  - [ ] Persist unlocked achievements

- [ ] Implement achievement event hooks
  - [ ] Hook into CombatEngine events
  - [ ] Hook into run completion
  - [ ] Hook into card play events
  - [ ] Hook into damage/heal events
  - [ ] Track per-run and per-combat statistics

- [ ] Implement achievement notification UI
  - [ ] Achievement popup on unlock
  - [ ] Soul Echo reward display
  - [ ] Sound effect on unlock
  - [ ] Animation (slide in from side)

- [ ] Implement achievement gallery UI
  - [ ] Grid view of all achievements
  - [ ] Category filters
  - [ ] Progress bars for multi-stage achievements
  - [ ] Hidden achievements show "???" until unlocked
  - [ ] Total Soul Echoes earned display

- [ ] Write unit tests
  - [ ] Test achievement condition checking
  - [ ] Test Soul Echo awarding
  - [ ] Test progress persistence
  - [ ] Test hidden achievement reveal
  - [ ] Test multi-stage progress

## Dev Notes

### Achievement Data Structure

```typescript
// src/types/achievements.ts
export enum AchievementTier {
  BRONZE = 'bronze',
  SILVER = 'silver',
  GOLD = 'gold',
  PLATINUM = 'platinum',
}

export const SOUL_ECHO_REWARDS: Record<AchievementTier, number> = {
  [AchievementTier.BRONZE]: 10,
  [AchievementTier.SILVER]: 25,
  [AchievementTier.GOLD]: 50,
  [AchievementTier.PLATINUM]: 100,
};

export interface Achievement {
  id: string;
  name: string;
  description: string;
  tier: AchievementTier;
  category: 'combat' | 'run' | 'class' | 'secret';
  hidden: boolean;
  condition: AchievementCondition;
  progress?: {
    current: number;
    target: number;
  };
}

export type AchievementCondition =
  | { type: 'combat_win_no_damage' }
  | { type: 'damage_single_attack'; amount: number }
  | { type: 'wins_with_class'; classId: CharacterClassId; count: number }
  | { type: 'complete_act'; act: number }
  | { type: 'deck_size_at_win'; comparison: 'lte' | 'gte'; size: number }
  | { type: 'custom'; checkFn: string }; // Function name to call
```

### Achievement Definitions

```typescript
// src/data/achievements.ts
export const ACHIEVEMENTS: Achievement[] = [
  // Combat - Bronze
  {
    id: 'first_blood',
    name: 'First Blood',
    description: 'Win your first combat.',
    tier: AchievementTier.BRONZE,
    category: 'combat',
    hidden: false,
    condition: { type: 'combat_wins'; count: 1 },
  },

  // Combat - Silver
  {
    id: 'untouchable',
    name: 'Untouchable',
    description: 'Win a combat without taking damage.',
    tier: AchievementTier.SILVER,
    category: 'combat',
    hidden: false,
    condition: { type: 'combat_win_no_damage' },
  },

  // Run - Gold
  {
    id: 'sanctum_breaker',
    name: 'Sanctum Breaker',
    description: 'Defeat the Hollow God.',
    tier: AchievementTier.GOLD,
    category: 'run',
    hidden: false,
    condition: { type: 'defeat_boss'; bossId: 'hollow_god' },
  },

  // Secret - Platinum
  {
    id: 'wardens_chosen',
    name: "The Warden's Chosen",
    description: '???',
    tier: AchievementTier.PLATINUM,
    category: 'secret',
    hidden: true,
    condition: { type: 'become_warden_all_classes' },
  },
];
```

### Achievement Service

```typescript
// src/services/AchievementService.ts
export class AchievementService {
  private unlockedAchievements: Set<string>;
  private achievementProgress: Map<string, number>;
  private listeners: ((achievement: Achievement) => void)[] = [];

  constructor() {
    this.loadFromStorage();
  }

  checkCombatAchievements(combatStats: CombatStats): void {
    // Check combat-related achievements
    if (combatStats.damageTaken === 0 && combatStats.victory) {
      this.tryUnlock('untouchable');
    }

    if (combatStats.maxSingleAttackDamage >= 50) {
      this.tryUnlock('overkill');
    }

    if (combatStats.enemiesDefeatedInSingleTurn >= 3) {
      this.tryUnlock('massacre');
    }
  }

  checkRunAchievements(runStats: RunStats): void {
    if (runStats.victory) {
      this.incrementProgress('sanctum_breaker', 1);

      if (runStats.deckSize <= 15) {
        this.tryUnlock('minimalist');
      }

      // Class-specific wins
      this.incrementProgress(`wins_${runStats.classId}`, 1);
    }
  }

  private tryUnlock(achievementId: string): boolean {
    if (this.unlockedAchievements.has(achievementId)) {
      return false; // Already unlocked
    }

    const achievement = getAchievementById(achievementId);
    if (!achievement) return false;

    this.unlockedAchievements.add(achievementId);
    this.awardSoulEchoes(SOUL_ECHO_REWARDS[achievement.tier]);
    this.notifyListeners(achievement);
    this.saveToStorage();

    return true;
  }

  private awardSoulEchoes(amount: number): void {
    const current = this.getSoulEchoes();
    localStorage.setItem('soulEchoes', String(current + amount));
  }

  getSoulEchoes(): number {
    return parseInt(localStorage.getItem('soulEchoes') || '0', 10);
  }

  onAchievementUnlocked(callback: (achievement: Achievement) => void): void {
    this.listeners.push(callback);
  }
}
```

### Combat Stats Tracking

```typescript
// Track stats during combat for achievement checking
interface CombatStats {
  damageTaken: number;
  damageDealt: number;
  maxSingleAttackDamage: number;
  totalBlockGained: number;
  cardsPlayed: number;
  turnsElapsed: number;
  enemiesDefeated: number;
  enemiesDefeatedInSingleTurn: number;
  victory: boolean;
  // Class-specific
  maxDevotion?: number;
  turnsWithMaxFortify?: number;
  cursesInDeck?: number;
  vowsBroken?: number;
  whimsyTriggered?: number;
}

// In CombatEngine
private combatStats: CombatStats = {
  damageTaken: 0,
  damageDealt: 0,
  // ... initialize all
};

// Update stats throughout combat
private onPlayerDamaged(amount: number): void {
  this.combatStats.damageTaken += amount;
}

private onEnemyDamaged(enemyId: string, amount: number): void {
  this.combatStats.damageDealt += amount;
  this.combatStats.maxSingleAttackDamage = Math.max(
    this.combatStats.maxSingleAttackDamage,
    amount
  );
}
```

### Achievement Notification UI

```typescript
// src/ui/AchievementNotification.ts
export function showAchievementNotification(achievement: Achievement): void {
  const notification = document.createElement('div');
  notification.className = `achievement-notification tier-${achievement.tier}`;
  notification.innerHTML = `
    <div class="achievement-icon">${getTierIcon(achievement.tier)}</div>
    <div class="achievement-content">
      <div class="achievement-title">Achievement Unlocked!</div>
      <div class="achievement-name">${achievement.name}</div>
      <div class="achievement-reward">+${SOUL_ECHO_REWARDS[achievement.tier]} Soul Echoes</div>
    </div>
  `;

  document.body.appendChild(notification);

  // Animate in
  requestAnimationFrame(() => {
    notification.classList.add('visible');
  });

  // Remove after delay
  setTimeout(() => {
    notification.classList.remove('visible');
    setTimeout(() => notification.remove(), 500);
  }, 4000);
}
```

### Achievement Gallery Design

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ACHIEVEMENTS                    Total: 1,250 Soul Echoes   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [All] [Combat] [Run] [Class] [Secret]                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ğŸ¥‰       â”‚  â”‚ ğŸ¥ˆ       â”‚  â”‚ â¬œ       â”‚  â”‚ â“       â”‚    â”‚
â”‚  â”‚First     â”‚  â”‚Untoucha- â”‚  â”‚ Overkill â”‚  â”‚  ???     â”‚    â”‚
â”‚  â”‚Blood     â”‚  â”‚ble       â”‚  â”‚          â”‚  â”‚          â”‚    â”‚
â”‚  â”‚ âœ“ 10 SE  â”‚  â”‚ âœ“ 25 SE  â”‚  â”‚ 0/50 dmg â”‚  â”‚  HIDDEN  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â”‚  Progress: 12/50 achievements (24%)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Balance Notes

Total Soul Echoes available from achievements:
- Combat (15): ~400 SE
- Run (15): ~450 SE
- Class (10): ~350 SE
- Secret (10): ~550 SE
- **Total: ~1,750 SE**

This should provide meaningful progression without making meta-upgrades trivial to unlock.

## Testing

### Test File Location
`src/tests/services/AchievementService.test.ts`

### Key Test Scenarios

1. **First Unlock**: Achievement unlocks correctly on condition met
2. **No Duplicate**: Same achievement can't unlock twice
3. **Soul Echo Award**: Correct amount awarded per tier
4. **Progress Tracking**: Multi-stage achievements track correctly
5. **Persistence**: Achievements persist across sessions
6. **Hidden Reveal**: Secret achievements reveal on unlock
7. **Combat Stats**: Stats tracked accurately during combat

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-03 | 1.0 | Initial story creation | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_
