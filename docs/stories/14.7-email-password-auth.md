# Story 14.7: Email/Password Authentication

## Status: Draft

## Story

**As a** player,
**I want** to create an account with email and password,
**so that** I can sign in without relying on third-party providers.

## Acceptance Criteria

1. Registration form accepts email, password, and display name
2. Password requirements: minimum 8 characters
3. Email must be unique (case-insensitive)
4. Passwords are hashed before storage (bcrypt, 12 rounds)
5. Login form accepts email and password
6. Failed login shows generic error (don't reveal if email exists)
7. Successful login issues JWT tokens
8. Rate limiting prevents brute force attacks (5 attempts/minute)

## Tasks

- [ ] Create registration endpoint (POST /api/auth/register)
- [ ] Create login endpoint (POST /api/auth/login)
- [ ] Implement password hashing with bcrypt
- [ ] Add email validation (format check)
- [ ] Add password strength validation
- [ ] Implement login rate limiting
- [ ] Create registration UI form
- [ ] Create login UI form
- [ ] Handle and display errors
- [ ] Trigger cloud sync after successful login

## Technical Notes

### Registration Endpoint

```typescript
// server/src/routes/auth.ts
import { Router } from 'express';
import { body, validationResult } from 'express-validator';
import { userService } from '../services/userService';
import { tokenService } from '../services/tokenService';
import { hashPassword } from '../utils/password';

const router = Router();

router.post('/register',
  body('email').isEmail().normalizeEmail(),
  body('password').isLength({ min: 8 }),
  body('displayName').trim().isLength({ min: 1, max: 50 }),
  async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({ error: 'Invalid input', details: errors.array() });
    }

    const { email, password, displayName } = req.body;

    try {
      // Check if email exists
      const existing = await userService.findByEmail(email);
      if (existing) {
        return res.status(409).json({ error: 'Email already registered' });
      }

      // Hash password
      const passwordHash = await hashPassword(password);

      // Create user
      const user = await userService.create({
        email,
        passwordHash,
        displayName
      });

      // Generate tokens
      const accessToken = tokenService.generateAccessToken({
        userId: user.id,
        email: user.email!
      });
      const refreshToken = await tokenService.generateRefreshToken(user.id);

      res.status(201).json({
        accessToken,
        refreshToken,
        user: {
          id: user.id,
          email: user.email,
          displayName: user.displayName
        }
      });
    } catch (error) {
      console.error('Registration error:', error);
      res.status(500).json({ error: 'Registration failed' });
    }
  }
);
```

### Login Endpoint

```typescript
// server/src/routes/auth.ts
import { verifyPassword } from '../utils/password';
import { loginRateLimiter } from '../middleware/rateLimit';

router.post('/login',
  loginRateLimiter,
  body('email').isEmail().normalizeEmail(),
  body('password').notEmpty(),
  async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({ error: 'Invalid input' });
    }

    const { email, password } = req.body;

    try {
      const user = await userService.findByEmail(email);

      // Generic error to prevent email enumeration
      if (!user || !user.passwordHash) {
        return res.status(401).json({ error: 'Invalid email or password' });
      }

      const valid = await verifyPassword(password, user.passwordHash);
      if (!valid) {
        return res.status(401).json({ error: 'Invalid email or password' });
      }

      // Generate tokens
      const accessToken = tokenService.generateAccessToken({
        userId: user.id,
        email: user.email!
      });
      const refreshToken = await tokenService.generateRefreshToken(user.id);

      res.json({
        accessToken,
        refreshToken,
        user: {
          id: user.id,
          email: user.email,
          displayName: user.displayName
        }
      });
    } catch (error) {
      console.error('Login error:', error);
      res.status(500).json({ error: 'Login failed' });
    }
  }
);
```

### Login Rate Limiting

```typescript
// server/src/middleware/rateLimit.ts
import rateLimit from 'express-rate-limit';

export const loginRateLimiter = rateLimit({
  windowMs: 60 * 1000, // 1 minute
  max: 5, // 5 attempts per minute
  message: { error: 'Too many login attempts, please try again later' },
  standardHeaders: true,
  legacyHeaders: false
});
```

### Frontend Auth Service

```typescript
// src/services/AuthService.ts

async register(email: string, password: string, displayName: string): Promise<void> {
  const response = await fetch(`${API_URL}/api/auth/register`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, password, displayName })
  });

  if (!response.ok) {
    const error = await response.json();
    throw new AuthError(error.error, response.status);
  }

  const { accessToken, refreshToken, user } = await response.json();
  this.setTokens(accessToken, refreshToken);
  this.user = user;
  this.notifyListeners();

  // Sync local progress to cloud
  await cloudSyncService.syncOnLogin();
}

async login(email: string, password: string): Promise<void> {
  const response = await fetch(`${API_URL}/api/auth/login`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, password })
  });

  if (!response.ok) {
    const error = await response.json();
    throw new AuthError(error.error, response.status);
  }

  const { accessToken, refreshToken, user } = await response.json();
  this.setTokens(accessToken, refreshToken);
  this.user = user;
  this.notifyListeners();

  // Sync with cloud
  await cloudSyncService.syncOnLogin();
}
```

### Registration Form UI

```typescript
// src/ui/screens/AuthScreen.ts

function renderRegisterForm(): string {
  return `
    <form id="register-form" class="auth-form">
      <h2>Create Account</h2>

      <div class="form-group">
        <label for="reg-name">Display Name</label>
        <input type="text" id="reg-name" required minlength="1" maxlength="50" />
      </div>

      <div class="form-group">
        <label for="reg-email">Email</label>
        <input type="email" id="reg-email" required />
      </div>

      <div class="form-group">
        <label for="reg-password">Password</label>
        <input type="password" id="reg-password" required minlength="8" />
        <small>Minimum 8 characters</small>
      </div>

      <div id="reg-error" class="error-message hidden"></div>

      <button type="submit" class="btn primary">Create Account</button>

      <p class="switch-form">
        Already have an account? <a href="#" onclick="showLoginForm()">Sign In</a>
      </p>
    </form>
  `;
}
```

### Error Messages

| Scenario | User-Facing Message |
|----------|---------------------|
| Email already registered | "Email already registered" |
| Invalid email format | "Please enter a valid email address" |
| Password too short | "Password must be at least 8 characters" |
| Invalid credentials | "Invalid email or password" |
| Too many attempts | "Too many login attempts, please try again later" |
| Server error | "Something went wrong. Please try again." |

## Definition of Done

- [ ] Users can register with email/password
- [ ] Users can login with email/password
- [ ] Passwords are securely hashed
- [ ] Rate limiting prevents brute force
- [ ] Error messages are user-friendly
- [ ] Cloud sync triggers after login

## Dependencies

- Story 14.4 (API Layer Setup)
- Story 14.2 (Database Schema)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-05 | 1.0 | Story created | Mary (Analyst) |
