# Story 15.1: PWA Configuration

## Status: InProgress

## Story

**As a** player on mobile or desktop,
**I want** to install Sanctum Ruins as an app,
**so that** I can play offline and have quick access from my home screen.

## Acceptance Criteria

1. `manifest.json` configured with app metadata
2. Service worker caches all game assets for offline play
3. Game is installable on mobile (Add to Home Screen)
4. Game works fully offline after first load
5. App icons display correctly on all platforms
6. Splash/launch screen displays during load
7. Lighthouse PWA score 90+

## Offline Work Tasks

These tasks can be done without internet access:

### 1. Create Web App Manifest (30-45 min)
Create `public/manifest.json`:

```json
{
  "name": "Sanctum Ruins",
  "short_name": "Sanctum",
  "description": "A roguelike deck-builder inspired by Slay the Spire",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#1a1a2e",
  "theme_color": "#16213e",
  "orientation": "portrait-primary",
  "icons": [
    {
      "src": "/icons/icon-72x72.png",
      "sizes": "72x72",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-96x96.png",
      "sizes": "96x96",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-128x128.png",
      "sizes": "128x128",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-144x144.png",
      "sizes": "144x144",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-152x152.png",
      "sizes": "152x152",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/icons/icon-384x384.png",
      "sizes": "384x384",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ],
  "categories": ["games", "entertainment"],
  "screenshots": [
    {
      "src": "/screenshots/combat.png",
      "sizes": "1280x720",
      "type": "image/png",
      "label": "Strategic card combat"
    },
    {
      "src": "/screenshots/map.png",
      "sizes": "1280x720",
      "type": "image/png",
      "label": "Roguelike progression map"
    }
  ]
}
```

### 2. Create App Icons (1-2 hours)
Design or generate icons for:
- `public/icons/icon-72x72.png`
- `public/icons/icon-96x96.png`
- `public/icons/icon-128x128.png`
- `public/icons/icon-144x144.png`
- `public/icons/icon-152x152.png`
- `public/icons/icon-192x192.png`
- `public/icons/icon-384x384.png`
- `public/icons/icon-512x512.png`

**Tool**: Use a 512x512 master icon and https://www.pwabuilder.com/imageGenerator or similar

### 3. Create Service Worker (45-60 min)
Create `public/sw.js`:

```javascript
const CACHE_NAME = 'sanctum-ruins-v1';
const ASSETS_TO_CACHE = [
  '/',
  '/index.html',
  '/manifest.json',
  // Add all JS/CSS bundles (from dist after build)
  // Add all images from /images/
  // Add all audio from /audio/
];

// Install event - cache all assets
self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(CACHE_NAME).then((cache) => {
      return cache.addAll(ASSETS_TO_CACHE);
    })
  );
  self.skipWaiting();
});

// Activate event - clean old caches
self.addEventListener('activate', (event) => {
  event.waitUntil(
    caches.keys().then((cacheNames) => {
      return Promise.all(
        cacheNames
          .filter((name) => name !== CACHE_NAME)
          .map((name) => caches.delete(name))
      );
    })
  );
  self.clients.claim();
});

// Fetch event - serve from cache, fallback to network
self.addEventListener('fetch', (event) => {
  event.respondWith(
    caches.match(event.request).then((response) => {
      return response || fetch(event.request).then((fetchResponse) => {
        // Optionally cache new requests
        if (event.request.method === 'GET') {
          const responseClone = fetchResponse.clone();
          caches.open(CACHE_NAME).then((cache) => {
            cache.put(event.request, responseClone);
          });
        }
        return fetchResponse;
      });
    })
  );
});
```

### 4. Update index.html (15 min)
Add to `<head>`:

```html
<!-- PWA Meta Tags -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#16213e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Sanctum Ruins">
<link rel="apple-touch-icon" href="/icons/icon-152x152.png">

<!-- iOS Splash Screens (optional but recommended) -->
<link rel="apple-touch-startup-image" href="/splash/splash-640x1136.png" media="(device-width: 320px)">
```

Add before closing `</body>`:

```html
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then((reg) => console.log('SW registered:', reg.scope))
        .catch((err) => console.error('SW registration failed:', err));
    });
  }
</script>
```

### 5. Configure Vite for PWA (15 min)
Option A: Manual (already done above)
Option B: Use vite-plugin-pwa

```bash
npm install vite-plugin-pwa -D
```

```typescript
// vite.config.ts
import { VitePWA } from 'vite-plugin-pwa';

export default defineConfig({
  plugins: [
    VitePWA({
      registerType: 'autoUpdate',
      workbox: {
        globPatterns: ['**/*.{js,css,html,ico,png,svg,jpg,mp3,ogg}']
      },
      manifest: {
        name: 'Sanctum Ruins',
        short_name: 'Sanctum',
        // ... rest of manifest
      }
    })
  ]
});
```

### 6. Test Offline Functionality (30 min)
- Build production (`npm run build`)
- Serve locally (`npm run start`)
- Load game, verify assets cached
- Go offline (DevTools Network tab → Offline)
- Refresh - game should still work
- Play a full run offline

## Dev Notes

### Asset Inventory for Cache
Run this to list all assets:
```bash
find public -type f | sort
```

The service worker needs to cache:
- All JS/CSS bundles from dist/
- All images from public/images/
- All audio from public/audio/
- index.html and manifest.json

### Cache Versioning Strategy
- Bump `CACHE_NAME` version on each deploy with breaking changes
- Use content hashing in Vite build for automatic cache busting
- Service worker update triggers on any byte change

### Lighthouse Testing
Run Lighthouse audit:
1. Build production
2. Serve with `npm run start`
3. Open Chrome DevTools → Lighthouse
4. Run audit for "Progressive Web App"

Target scores:
- Performance: 90+
- Accessibility: 90+
- Best Practices: 90+
- SEO: 90+
- PWA: Pass all checks

### Relevant Files
- `public/manifest.json` (new)
- `public/sw.js` (new)
- `public/icons/` (new folder)
- `index.html` (modify)
- `vite.config.ts` (optional modification)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-05 | 1.0 | Initial story creation | John (PM) |
