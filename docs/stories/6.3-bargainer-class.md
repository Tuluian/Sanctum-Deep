# Story 6.3: Bargainer Class & Favor/Price System

## Status: Approved

## Story

**As a** player choosing the Bargainer class,
**I want** a unique starter deck with demon pact cards that have powerful effects but ongoing costs,
**so that** I can experience a high-risk/reward playstyle managing demonic Favor and paying devastating Prices.

## Acceptance Criteria

1. Bargainer starts with: 3x Dark Pact (1 Resolve, Deal 8 damage, PRICE: Lose 1 HP per turn), 3x Infernal Shield (1 Resolve, Gain 10 block, PRICE: -1 max Resolve until combat ends), 2x Collect Favor (1 Resolve, Gain 2 Favor), 1x Debt Collector (2 Resolve, Deal damage equal to 3x your total active Prices), 1x Blood Payment (0 Resolve, Pay 5 HP to remove all Prices)
2. Bargainer starts with 80 max HP (higher to offset HP drain Prices)
3. Bargainer starts with 3 max Resolve per turn
4. Favor is a resource spent to reduce or negate Prices
5. Each card with a PRICE inflicts an ongoing negative effect when played
6. Price types: HP_DRAIN (lose HP per turn), RESOLVE_TAX (reduced max Resolve), CURSE_CARDS (add Curse cards to deck), DEBT_STACK (accumulating damage)
7. Prices persist until paid off or combat ends
8. Player can spend Favor to reduce/remove Prices (1 Favor = remove 1 Price stack)
9. Favor persists between combats but caps at 10
10. Active Prices and Favor visible in UI

## Tasks / Subtasks

- [ ] Create Bargainer class configuration (AC: 2, 3)
  - [ ] Add `BARGAINER` to CharacterClassId enum in types
  - [ ] Add `BARGAINER` class configuration with 80 HP, 3 Resolve
  - [ ] Define starter deck recipe in class config

- [ ] Design and implement Price system (AC: 5, 6, 7)
  - [ ] Create Price interface in types
  - [ ] Create PriceType enum (HP_DRAIN, RESOLVE_TAX, CURSE_CARDS, DEBT_STACK)
  - [ ] Add `activePrices: Price[]` array to PlayerState
  - [ ] Implement Price application when cards are played
  - [ ] Implement Price effects at appropriate times:
    - [ ] HP_DRAIN: Trigger at start of player turn
    - [ ] RESOLVE_TAX: Apply immediately, remove at combat end
    - [ ] CURSE_CARDS: Add curse card to draw pile immediately
    - [ ] DEBT_STACK: Accumulates, triggers damage at threshold (10 stacks = take 20 damage)
  - [ ] Implement Price cleanup at combat end

- [ ] Implement Favor system (AC: 4, 8, 9)
  - [ ] Add `favor` property to PlayerState
  - [ ] Add MAX_FAVOR constant (10)
  - [ ] Implement GAIN_FAVOR effect type
  - [ ] Implement SPEND_FAVOR_REMOVE_PRICE effect (UI interaction needed)
  - [ ] Favor persists between combats (part of run state)

- [ ] Implement Bargainer starter deck cards (AC: 1)
  - [ ] Define Dark Pact: { id: 'dark_pact', type: ATTACK, cost: 1, effects: [{ type: DAMAGE, amount: 8 }], price: { type: HP_DRAIN, amount: 1 } }
  - [ ] Define Infernal Shield: { id: 'infernal_shield', type: SKILL, cost: 1, effects: [{ type: BLOCK, amount: 10 }], price: { type: RESOLVE_TAX, amount: 1 } }
  - [ ] Define Collect Favor: { id: 'collect_favor', type: SKILL, cost: 1, effects: [{ type: GAIN_FAVOR, amount: 2 }] }
  - [ ] Define Debt Collector: { id: 'debt_collector', type: ATTACK, cost: 2, effects: [{ type: DAMAGE_PER_PRICE, multiplier: 3 }] }
  - [ ] Define Blood Payment: { id: 'blood_payment', type: SKILL, cost: 0, effects: [{ type: LOSE_HP, amount: 5 }, { type: REMOVE_ALL_PRICES }] }

- [ ] Create curse card definitions (AC: 6)
  - [ ] Define Demonic Debt: { id: 'demonic_debt', type: CURSE, cost: UNPLAYABLE, effects: [], description: 'Unplayable. At end of turn, if in hand, lose 2 HP.' }
  - [ ] Implement curse card end-of-turn damage

- [ ] Create bargainer cards data file (AC: 1)
  - [ ] Create `src/data/cards/bargainer.ts`
  - [ ] Export BARGAINER_CARDS record
  - [ ] Register in `src/data/cards/index.ts`

- [ ] Implement Price UI (AC: 10)
  - [ ] Display active Prices list in player stats area
  - [ ] Show Price type, amount, and source card
  - [ ] Display Favor counter
  - [ ] Button/interaction to spend Favor on Prices
  - [ ] Visual feedback when Prices trigger (HP drain, debt damage)
  - [ ] Emit PRICE_ADDED, PRICE_TRIGGERED, PRICE_REMOVED events

- [ ] Write unit tests for Bargainer class
  - [ ] Test Bargainer starts with 80 HP
  - [ ] Test Bargainer starts with 3 max Resolve
  - [ ] Test starter deck contains exactly 10 cards
  - [ ] Test Dark Pact deals 8 damage and adds HP_DRAIN Price
  - [ ] Test HP_DRAIN triggers at start of turn
  - [ ] Test RESOLVE_TAX reduces max Resolve
  - [ ] Test CURSE_CARDS adds curse to deck
  - [ ] Test DEBT_STACK accumulates and triggers at threshold
  - [ ] Test Favor can remove Prices (1:1 ratio)
  - [ ] Test Favor persists between combats
  - [ ] Test Favor caps at 10
  - [ ] Test Blood Payment removes all Prices for HP cost
  - [ ] Test Debt Collector deals damage based on active Prices
  - [ ] Test Prices clear at combat end

## Dev Notes

### Favor/Price System Overview

The Bargainer is a high-risk/reward class that makes **demonic pacts**:
- **Favor**: A persistent resource earned through cards, spent to mitigate Prices
- **Price**: Ongoing negative effects attached to powerful cards

### Price Types

| Type | Effect | Trigger |
|------|--------|---------|
| HP_DRAIN | Lose X HP | Start of player turn |
| RESOLVE_TAX | -X max Resolve | Immediate, until combat end |
| CURSE_CARDS | Add X Curse cards to deck | Immediate |
| DEBT_STACK | Accumulates; at 10 stacks, take 20 damage and clear | On each stack gain |

### Price Interface

```typescript
interface Price {
  id: string;              // Unique ID
  type: PriceType;
  amount: number;          // Intensity (HP per turn, Resolve reduction, etc.)
  stacks: number;          // For DEBT_STACK type
  sourceCardId: string;    // Card that created this Price
  duration: 'combat' | 'permanent';
}

enum PriceType {
  HP_DRAIN = 'hp_drain',
  RESOLVE_TAX = 'resolve_tax',
  CURSE_CARDS = 'curse_cards',
  DEBT_STACK = 'debt_stack',
}
```

### Price Processing

```typescript
function processStartOfTurnPrices(): void {
  for (const price of player.activePrices) {
    switch (price.type) {
      case PriceType.HP_DRAIN:
        player.hp -= price.amount;
        emitEvent('PRICE_TRIGGERED', { price, damage: price.amount });
        break;
    }
  }
}

function applyPrice(price: Price): void {
  switch (price.type) {
    case PriceType.HP_DRAIN:
      player.activePrices.push(price);
      break;

    case PriceType.RESOLVE_TAX:
      player.maxResolve -= price.amount;
      player.activePrices.push(price);
      break;

    case PriceType.CURSE_CARDS:
      for (let i = 0; i < price.amount; i++) {
        addCardToDrawPile(getCurseCard('demonic_debt'));
      }
      break;

    case PriceType.DEBT_STACK:
      const existingDebt = player.activePrices.find(p => p.type === PriceType.DEBT_STACK);
      if (existingDebt) {
        existingDebt.stacks += price.amount;
        if (existingDebt.stacks >= 10) {
          player.hp -= 20;
          existingDebt.stacks = 0;
          emitEvent('DEBT_THRESHOLD_TRIGGERED', { damage: 20 });
        }
      } else {
        player.activePrices.push({ ...price, stacks: price.amount });
      }
      break;
  }
}

function spendFavorOnPrice(priceId: string): boolean {
  if (player.favor <= 0) return false;

  const priceIndex = player.activePrices.findIndex(p => p.id === priceId);
  if (priceIndex === -1) return false;

  player.favor -= 1;
  player.activePrices.splice(priceIndex, 1);

  // Restore RESOLVE_TAX if removed
  const removedPrice = player.activePrices[priceIndex];
  if (removedPrice?.type === PriceType.RESOLVE_TAX) {
    player.maxResolve += removedPrice.amount;
  }

  emitEvent('PRICE_REMOVED', { priceId });
  return true;
}
```

### Card Definitions

```typescript
const BARGAINER_CARDS = {
  dark_pact: {
    id: 'dark_pact',
    name: 'Dark Pact',
    type: CardType.ATTACK,
    cost: 1,
    description: 'Deal 8 damage. PRICE: Lose 1 HP per turn.',
    effects: [{ type: EffectType.DAMAGE, amount: 8 }],
    price: { type: PriceType.HP_DRAIN, amount: 1 },
    classId: CharacterClassId.BARGAINER
  },
  infernal_shield: {
    id: 'infernal_shield',
    name: 'Infernal Shield',
    type: CardType.SKILL,
    cost: 1,
    description: 'Gain 10 block. PRICE: -1 max Resolve until combat ends.',
    effects: [{ type: EffectType.BLOCK, amount: 10 }],
    price: { type: PriceType.RESOLVE_TAX, amount: 1 },
    classId: CharacterClassId.BARGAINER
  },
  collect_favor: {
    id: 'collect_favor',
    name: 'Collect Favor',
    type: CardType.SKILL,
    cost: 1,
    description: 'Gain 2 Favor.',
    effects: [{ type: EffectType.GAIN_FAVOR, amount: 2 }],
    classId: CharacterClassId.BARGAINER
  },
  debt_collector: {
    id: 'debt_collector',
    name: 'Debt Collector',
    type: CardType.ATTACK,
    cost: 2,
    description: 'Deal damage equal to 3x your active Prices.',
    effects: [{ type: EffectType.DAMAGE_PER_PRICE, multiplier: 3 }],
    classId: CharacterClassId.BARGAINER
  },
  blood_payment: {
    id: 'blood_payment',
    name: 'Blood Payment',
    type: CardType.SKILL,
    cost: 0,
    description: 'Lose 5 HP. Remove all Prices.',
    effects: [
      { type: EffectType.LOSE_HP, amount: 5 },
      { type: EffectType.REMOVE_ALL_PRICES }
    ],
    classId: CharacterClassId.BARGAINER
  },
  demonic_debt: {
    id: 'demonic_debt',
    name: 'Demonic Debt',
    type: CardType.CURSE,
    cost: -1, // Unplayable
    description: 'Unplayable. At end of turn, if in hand, lose 2 HP.',
    effects: [],
    classId: CharacterClassId.BARGAINER
  }
};
```

### File Structure

```
src/
  data/
    cards/
      bargainer.ts    - Bargainer card definitions
      index.ts        - Add bargainer cards to registry
    classes.ts        - Add Bargainer class config
  engine/
    CombatEngine.ts   - Add Price system, Favor handling
  types/
    index.ts          - Add Price interface, PriceType enum, BARGAINER class
  ui/
    renderer.ts       - Add Price list display, Favor counter, interaction buttons
```

## Testing

### Test File Location
`src/tests/classes/Bargainer.test.ts`

### Key Test Scenarios

1. **Class Stats**: Bargainer has 80 HP and 3 Resolve
2. **Deck Composition**: 3 Dark Pact, 3 Infernal Shield, 2 Collect Favor, 1 Debt Collector, 1 Blood Payment
3. **HP_DRAIN**: Dark Pact adds Price, lose 1 HP at start of each turn
4. **RESOLVE_TAX**: Infernal Shield reduces max Resolve by 1 for combat
5. **CURSE_CARDS**: Curse card adds to deck, triggers 2 HP loss if in hand at end of turn
6. **DEBT_STACK**: At 10 stacks, take 20 damage and clear stacks
7. **Favor Gain**: Collect Favor grants 2 Favor
8. **Favor Spending**: 1 Favor removes 1 Price
9. **Favor Persistence**: Favor carries between combats
10. **Favor Cap**: Cannot exceed 10 Favor
11. **Debt Collector Scaling**: 3 active Prices = 9 damage
12. **Blood Payment**: Pay 5 HP, remove all Prices
13. **Combat End Cleanup**: RESOLVE_TAX Prices restore max Resolve

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-03 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_
