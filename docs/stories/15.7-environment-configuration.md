# Story 15.7: Environment Configuration

## Status: Draft

## Story

**As a** developer managing multiple environments,
**I want** proper environment variable configuration,
**so that** development, staging, and production settings are cleanly separated.

## Acceptance Criteria

1. `.env.example` file documents all required variables
2. Environment variables load correctly in development
3. Production variables are set via Heroku config
4. Sensitive values are never committed to git
5. Vite exposes only VITE_-prefixed variables to client
6. Build-time vs runtime variables are clearly documented
7. Local development works without external services

## Tasks / Subtasks

- [ ] Create environment variable documentation (AC: 1, 6)
  - [ ] Create `.env.example` with all variables
  - [ ] Document which are required vs optional
  - [ ] Document build-time vs runtime distinction
- [ ] Set up local development environment (AC: 2, 7)
  - [ ] Create `.env.local` (gitignored)
  - [ ] Add fallback values for optional services
  - [ ] Verify game runs without Sentry/analytics
- [ ] Configure production environment (AC: 3)
  - [ ] Set Heroku config vars
  - [ ] Document how to update production config
- [ ] Audit for secrets exposure (AC: 4, 5)
  - [ ] Verify `.gitignore` includes `.env*` (except example)
  - [ ] Verify no secrets in committed code
  - [ ] Ensure only VITE_ vars reach client bundle
- [ ] Add environment validation (AC: 2, 3)
  - [ ] Create startup check for required variables
  - [ ] Log warnings for missing optional variables

## Dev Notes

### Environment Variable Categories

**Build-time (VITE_ prefix, embedded in bundle):**
- `VITE_SENTRY_DSN` - Error tracking endpoint
- `VITE_APP_VERSION` - App version for releases
- `VITE_API_URL` - Backend API endpoint (future)
- `VITE_GOOGLE_CLIENT_ID` - OAuth client ID (future)

**Server-side only (not exposed to client):**
- `DATABASE_URL` - Postgres connection string
- `SENTRY_AUTH_TOKEN` - For source map uploads
- `SESSION_SECRET` - For session encryption

### .env.example Template

```bash
# ===========================================
# Sanctum Ruins Environment Configuration
# ===========================================
# Copy this file to .env.local for development
# Do NOT commit .env.local or any file with real secrets

# ----- Client-Side (VITE_ prefix) -----
# These are embedded in the JavaScript bundle

# Error Tracking (optional - game works without it)
VITE_SENTRY_DSN=

# App Version (set by CI/CD usually)
VITE_APP_VERSION=0.0.0-dev

# API URL (for future cloud save)
VITE_API_URL=http://localhost:3001

# Google OAuth Client ID (for future auth)
VITE_GOOGLE_CLIENT_ID=

# ----- Server-Side Only -----
# These are NOT exposed to the client

# Database (for future cloud save)
DATABASE_URL=

# Sentry Auth (for source map uploads in CI)
SENTRY_AUTH_TOKEN=

# Session Secret (for future auth)
SESSION_SECRET=local-dev-secret-change-in-prod

# ----- Development Flags -----
# Enable debug logging
DEBUG=false
```

### Vite Environment Loading

Vite automatically loads:
1. `.env` - All environments
2. `.env.local` - Local overrides (gitignored)
3. `.env.production` - Production only
4. `.env.development` - Development only

Access in code:
```typescript
// Client-side (only VITE_ prefixed)
const dsn = import.meta.env.VITE_SENTRY_DSN;
const version = import.meta.env.VITE_APP_VERSION;
const isProd = import.meta.env.PROD;
const isDev = import.meta.env.DEV;
```

### Environment Validation Helper

```typescript
// src/utils/env.ts
export function validateEnv() {
  const warnings: string[] = [];

  // Optional services - warn but don't fail
  if (!import.meta.env.VITE_SENTRY_DSN) {
    warnings.push('VITE_SENTRY_DSN not set - error tracking disabled');
  }

  if (warnings.length > 0 && import.meta.env.DEV) {
    console.warn('Environment warnings:', warnings);
  }
}
```

### Heroku Configuration

```bash
# Set production variables
heroku config:set VITE_SENTRY_DSN=https://xxx@sentry.io/xxx
heroku config:set VITE_APP_VERSION=1.0.0
heroku config:set NODE_ENV=production

# View current config
heroku config
```

### .gitignore Entries

```
# Environment files
.env
.env.local
.env.*.local
.env.production
.env.development

# Keep the example
!.env.example
```

### Relevant Files
- `.env.example` (new)
- `.env.local` (new, gitignored)
- `.gitignore` (verify entries)
- `src/utils/env.ts` (new, optional)
- `src/main.ts` (add validation call)

## Testing

- Test file location: N/A (configuration)
- Verification:
  - Delete `.env.local`, verify game still runs
  - Check browser DevTools for exposed variables
  - Verify `import.meta.env` doesn't contain secrets

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-05 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

_To be filled by Dev agent_

---

## QA Results

_To be filled by QA agent_
