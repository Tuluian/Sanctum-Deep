# Story 3.1: The Diabolist Class & Contracts Mechanic

## Status: Draft

## Story

**As a** player who purchases the Diabolist DLC,
**I want** a unique class with high-risk/high-reward infernal pact mechanics,
**so that** I can experience a playstyle focused on raw power with dangerous consequences.

---

## Narrative Context

> *"The contract was simple: enter the Sanctum, retrieve a fragment of the Hollow God, return to my contractor. The fine print? There is no exit clause. There never was."*

**True Name:** Mordecai Ashworth (suggested default, customizable)

### Why They Entered
Mordecai was dying. A wasting curse—payment for dabblings in forbidden magic—had given them three months to live. A devil named **Xan'thrax** appeared with an offer: enter the Sanctum, bring back a fragment of the Hollow God, and the curse lifts.

What Mordecai didn't know: Xan'thrax cannot enter the Sanctum. The barrier that contains the Hollow God also repels hellborn. The devil wants that fragment to become a *new* Hollow God—one it controls.

The trap: Either Mordecai retrieves the fragment (empowering a devil to cosmic status) or dies trying (voiding the debt, leaving the curse uncured). There is no winning move. Xan'thrax made sure of that.

### What They Discover
As Mordecai delves deeper, they learn the Sanctum's true nature. The Warden whispers: *"Your contractor lies. But you knew that, didn't you?"*

By Act 3, Mordecai realizes there's a third option: become the Warden. The barrier works both ways. From inside, Mordecai could seal Xan'thrax out permanently. The curse? It would be... complicated. Wardens don't age. They don't die naturally. Does a curse that kills you slowly matter when you're immortal?

### Character Arc
- **Act 1:** Survival. The curse progresses. The clock ticks. Get the fragment. Don't think about what happens next.
- **Act 2:** Doubt. The Drowned King made a deal to save his kingdom. It worked—but at what cost? Are all bargains equal?
- **Act 3:** Defiance. Xan'thrax expected a pawn. Mordecai refuses to be anyone's piece. The contract was flawed. Time to renegotiate.

### Personality
Sardonic. Theatrical. Hides fear behind wit. Makes dark jokes about their own mortality—gallows humor from someone standing on the gallows. The performative confidence cracks in quieter moments. Deep down: terrified. Not of death, but of having lived a wasted life.

### Soul Debt (Narrative Meaning)
Not just a counter—it's the literal tally of souls consumed to power your magic. Each Pain card in your deck was a person once. At 10+ Soul Debt, you hear Xan'thrax's whispers:
- *"You're doing so well, little mageling..."*
- *"The fragment is close. I can taste it..."*
- *"Remember our bargain..."*

At 20+ Soul Debt, the whispers become commands. Mordecai's portrait flickers. The line between contractor and contracted blurs.

### Contract Cards (Narrative Meaning)
Contracts represent deals-within-deals. The Diabolist's life is a web of obligations. Each Contract active represents another thread tying them down. Fulfilling a Contract—paying off the debt—is momentary freedom. But there's always another deal to make.

### Voice Lines (UI/Combat Barks)
- On combat start: "Let's make this quick. I'm on borrowed time."
- On taking damage: "Add it to my tab."
- On gaining Soul Debt: "Everything has a price. Apparently."
- On dealing killing blow: "Your soul will be useful."
- On low HP: "Xan'thrax is laughing somewhere. I can feel it."
- On victory: "Still alive. Still paying interest."

### Warden Dialogue (Class-Specific)
- First meeting: "You reek of brimstone and bad bargains. The devil cannot enter here—but he's watching."
- Act 2 Entry: "The Drowned King made a deal to save his kingdom. He kept his word. What will you do?"
- Act 3 Entry: "Your contractor waits at the edge. Hungry. Impatient. You could seal him out forever—if you're willing to stay."

---

## Acceptance Criteria

1. Diabolist starts with 50 max HP (glass cannon)
2. Diabolist starts with 3 max Resolve per turn
3. Starter deck: 4x Soul Rend (1 Resolve, Deal 7 damage, lose 1 HP), 3x Dark Bargain (1 Resolve, Gain 6 block, add 1 Pain to discard), 2x Blood Pact (1 Resolve, Deal 10 damage, add Pain to deck), 1x Hellfire (2 Resolve, Deal 6 damage to ALL enemies, lose 2 HP)
4. Core mechanic: **Contracts** - powerful effects that add Curse cards or have HP costs
5. Pain cards (Curse): Cost 0, Unplayable, take 1 damage when drawn
6. Contracts can be "fulfilled" to remove Curses and gain bonuses
7. Some cards cost HP instead of (or in addition to) Resolve
8. Diabolist has unique resource: **Soul Debt** - tracks total Curses added this run

## Tasks / Subtasks

- [ ] Create Diabolist class configuration (AC: 1, 2)
  - [ ] Define DIABOLIST class with 70 HP, 3 Resolve
  - [ ] Mark as premium/DLC class
  - [ ] Define starter deck recipe

- [ ] Implement Diabolist starter deck cards (AC: 3)
  - [ ] **Soul Rend**: { id: 'soul_rend', type: ATTACK, cost: 1, effects: [DAMAGE 7, LOSE_HP 1] }
  - [ ] **Dark Bargain**: { id: 'dark_bargain', type: SKILL, cost: 1, effects: [BLOCK 6, ADD_CARD_TO_DISCARD 'pain'] }
  - [ ] **Blood Pact**: { id: 'blood_pact', type: ATTACK, cost: 1, effects: [DAMAGE 10, ADD_CARD_TO_DECK 'pain'] }
  - [ ] **Hellfire**: { id: 'hellfire', type: ATTACK, cost: 2, effects: [DAMAGE_ALL 6, LOSE_HP 2] }

- [ ] Create diabolist cards data file
  - [ ] Create `src/data/cards/diabolist.ts`
  - [ ] Export DIABOLIST_CARDS record
  - [ ] Register in card index

- [ ] Implement Pain curse card (AC: 5)
  - [ ] **Pain**: { id: 'pain', type: CURSE, cost: 0, unplayable: true, effects: [ON_DRAW: LOSE_HP 1] }
  - [ ] Implement "unplayable" card property
  - [ ] Implement "on draw" trigger system
  - [ ] Pain damages player when drawn

- [ ] Implement Contracts mechanic (AC: 4, 6)
  - [ ] Contract cards have conditions that can be "fulfilled"
  - [ ] Fulfilled contracts remove associated Curses
  - [ ] Track active contracts in combat state
  - [ ] Contract examples:
    - "Deal with the Pit Lord": +3 Might until HP < 50%, then remove
    - "Infernal Bargain": Draw 2 extra cards per turn, add Pain each turn

- [ ] Implement HP cost system (AC: 7)
  - [ ] New effect type: LOSE_HP (self-damage)
  - [ ] Cards can have HP cost in addition to Resolve
  - [ ] HP cost paid on card play, before effects
  - [ ] Cannot play card if HP cost would kill you

- [ ] Implement Soul Debt tracking (AC: 8)
  - [ ] Add `soulDebt` to run state (persists across combats)
  - [ ] Increment when Curse added to deck
  - [ ] Display in UI
  - [ ] Some cards/relics interact with Soul Debt

- [ ] Implement ADD_CARD effects
  - [ ] ADD_CARD_TO_DECK: Add card to draw pile (shuffled in)
  - [ ] ADD_CARD_TO_DISCARD: Add card to discard pile
  - [ ] ADD_CARD_TO_HAND: Add card directly to hand

- [ ] Update UI for Diabolist
  - [ ] Soul Debt counter display
  - [ ] HP cost indicator on cards
  - [ ] Curse card styling (dark/red theme)
  - [ ] Pain damage animation when drawn
  - [ ] Contract status indicators

- [ ] Write unit tests
  - [ ] Test Diabolist starts with 70 HP
  - [ ] Test Soul Rend deals 7 damage, costs 1 HP
  - [ ] Test Dark Bargain adds Pain to discard
  - [ ] Test Pain deals 1 damage when drawn
  - [ ] Test unplayable cards cannot be played
  - [ ] Test Hellfire damages all enemies
  - [ ] Test Soul Debt increments on Curse add

## Dev Notes

### Diabolist Philosophy

The Diabolist is about managing risk:
- High damage output but self-damage and deck pollution
- Must balance power gains against Curse accumulation
- Skilled players can "outrun" their debts by killing fast
- Some cards let you purge Curses or benefit from them

### Curse System

```typescript
interface CardDefinition {
  // ... existing
  unplayable?: boolean;    // Cannot be played (Curses)
  onDraw?: CardEffect[];   // Effects when drawn
}

// Pain curse
const PAIN: CardDefinition = {
  id: 'pain',
  name: 'Pain',
  type: CardType.CURSE,
  cost: 0,
  description: 'Unplayable. When drawn, lose 1 HP.',
  unplayable: true,
  onDraw: [{ type: EffectType.LOSE_HP, amount: 1 }],
  effects: []
};
```

### Contract System

```typescript
interface Contract {
  id: string;
  name: string;
  benefit: StatusEffect;      // What you gain
  condition: ContractCondition; // When it ends
  curse?: string;             // Associated curse to remove on fulfill
}

interface ContractCondition {
  type: 'hp_below' | 'turns_elapsed' | 'cards_played' | 'damage_dealt';
  threshold: number;
}

// Example: Deal with the Pit Lord
const PIT_LORD_DEAL: Contract = {
  id: 'pit_lord_deal',
  name: 'Deal with the Pit Lord',
  benefit: { type: StatusType.MIGHT, amount: 3 },
  condition: { type: 'hp_below', threshold: 0.5 },
  curse: 'pit_lords_due' // Removed when contract ends
};
```

### HP Cost Implementation

```typescript
interface CardDefinition {
  // ... existing
  hpCost?: number;  // HP paid to play (in addition to Resolve)
}

function canPlayCard(card: Card): boolean {
  if (card.cost > player.resolve) return false;
  if (card.hpCost && card.hpCost >= player.currentHp) return false;
  if (card.unplayable) return false;
  return true;
}

function playCard(card: Card): void {
  player.resolve -= card.cost;
  if (card.hpCost) {
    player.currentHp -= card.hpCost;
    emit('PLAYER_HP_CHANGED', { hp: player.currentHp });
  }
  executeEffects(card.effects);
}
```

### Starter Deck Analysis

| Card | Count | Damage | Cost | Drawback |
|------|-------|--------|------|----------|
| Soul Rend | 4 | 7 | 1 | Lose 1 HP |
| Dark Bargain | 3 | 0 (6 block) | 1 | Pain to discard |
| Blood Pact | 2 | 10 | 1 | Pain to deck |
| Hellfire | 1 | 6 AoE | 2 | Lose 2 HP |

**Total**: 10 cards
**Theme**: High damage but accumulates Pain and self-damage

## Testing

### Test File Location
`src/tests/classes/Diabolist.test.ts`

### Key Test Scenarios

1. **Class Stats**: 70 HP, 3 Resolve
2. **Soul Rend**: Deals 7, player loses 1 HP
3. **Dark Bargain**: Adds Pain to discard pile
4. **Blood Pact**: Adds Pain to deck
5. **Hellfire**: Damages all enemies, player loses 2 HP
6. **Pain On Draw**: Drawing Pain deals 1 damage
7. **Unplayable**: Pain cannot be played
8. **Soul Debt**: Increments when Pain added

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-03 | 1.0 | Initial story creation | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_
