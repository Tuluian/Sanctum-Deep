# Story 7.7: Map Node Connection Rendering Fix

## Status: Ready for Review

## Story

**As a** player navigating the dungeon map,
**I want** connection lines between nodes to render correctly at all zoom levels,
**so that** I can clearly see available paths through the dungeon.

## Acceptance Criteria

1. Connection lines follow the same zoom ratio as nodes
2. Connection lines remain visible in the last 25% of the map
3. Lines connect visually to node centers at all zoom levels
4. Panning and zooming preserves line-to-node relationships
5. Connection lines render with consistent thickness at all scales
6. Performance remains smooth during zoom/pan operations

## Tasks / Subtasks

- [x] Investigate connection rendering bug (AC: 1, 2)
  - [x] Reproduce at different zoom levels
  - [x] Identify transform mismatch between nodes and lines
- [x] Fix connection line zoom scaling (AC: 1, 3)
  - [x] Apply same transform to lines as nodes
  - [x] Recalculate line endpoints on zoom
- [x] Fix last 25% cutoff issue (AC: 2)
  - [x] Check viewport clipping logic
  - [x] Extend render area or remove early cutoff
- [x] Test line-node alignment (AC: 3, 4)
  - [x] Verify at min/max zoom
  - [x] Test with pan + zoom combinations
- [x] Optimize rendering performance (AC: 6)

## Dev Notes

### Bug Description
- Map connection nodes are cut off after the last 25%
- When zooming, connection lines don't follow the same ratio as nodes do
- Nodes move but lines stay in original positions

### Relevant Files
- `src/ui/screens/MapScreen.ts` - map rendering
- `src/ui/renderer.ts` - drawing utilities
- CSS for map zoom transforms

### Testing
- Manual testing at various zoom levels
- Check Act 1, 2, 3 maps for consistency

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-04 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### Completion Notes List
- Moved SVG from `.map-scroll-area` to inside `.map-nodes` container
- Changed coordinate calculation to use positions relative to `.map-nodes` container
- This ensures lines and nodes share the same coordinate system
- Updated CSS to position SVG within `.map-nodes` with z-index: 1
- Increased line visibility (available: 0.6 opacity, 3px width; future: 0.3 opacity)

### File List
- `src/ui/screens/MapScreen.ts` - Fixed coordinate calculation in drawConnections()
- `src/styles/main.css` - Updated .map-connections and .map-line styles

---

## QA Results

_To be filled by QA agent_
