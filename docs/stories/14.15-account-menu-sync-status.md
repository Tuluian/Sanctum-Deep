# Story 14.15: Account Menu & Sync Status

## Status: Draft

## Story

**As a** logged-in player,
**I want** to see my account status and sync status in the menu,
**so that** I know my progress is being saved to the cloud.

## Acceptance Criteria

1. Main menu shows logged-in user's display name
2. Sync status indicator shows current state (synced, syncing, pending, offline)
3. Clicking account area opens account menu
4. Account menu shows: user info, last synced time, logout option
5. Logout clears auth tokens but keeps local save data
6. Guest users see "Sign In" button instead of account info

## Tasks

- [ ] Add account status component to main menu header
- [ ] Create sync status indicator component
- [ ] Create account dropdown/modal menu
- [ ] Implement logout functionality
- [ ] Show appropriate UI for guests vs logged-in users
- [ ] Display last synced timestamp
- [ ] Test logout flow preserves local data

## Technical Notes

### Main Menu Header Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  â˜ï¸ Synced  Â·  PlayerName  â–¼                    â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                         â”‚
â”‚                    SANCTUM RUINS                        â”‚
â”‚                                                         â”‚
â”‚                  [ Continue Run ]                       â”‚
â”‚                  [ New Game ]                           â”‚
â”‚                  [ Upgrades ]                           â”‚
â”‚                  [ Settings ]                           â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Account Status Component

```typescript
// src/ui/components/AccountStatus.ts

function renderAccountStatus(): string {
  if (!AuthService.isAuthenticated()) {
    return renderGuestStatus();
  }

  const user = AuthService.getUser();
  const syncStatus = SaveManager.getSyncStatus();

  return `
    <div class="account-status" onclick="toggleAccountMenu()">
      ${renderSyncIcon(syncStatus)}
      <span class="sync-label">${getSyncLabel(syncStatus)}</span>
      <span class="divider">Â·</span>
      <span class="user-name">${user?.displayName || 'Player'}</span>
      <span class="dropdown-arrow">â–¼</span>
    </div>
  `;
}

function renderGuestStatus(): string {
  return `
    <div class="account-status guest">
      <span class="guest-label">Playing as Guest</span>
      <button class="sign-in-link" onclick="showAuthScreen('main-menu')">
        Sign In
      </button>
    </div>
  `;
}

function renderSyncIcon(status: SyncStatus): string {
  const icons = {
    idle: 'â˜ï¸',
    syncing: '<span class="sync-spinner-small"></span>',
    synced: 'â˜ï¸',
    pending: 'â³',
    offline: 'ğŸ“´',
    error: 'âš ï¸'
  };
  return icons[status] || 'â˜ï¸';
}

function getSyncLabel(status: SyncStatus): string {
  const labels = {
    idle: 'Synced',
    syncing: 'Syncing...',
    synced: 'Synced',
    pending: 'Pending',
    offline: 'Offline',
    error: 'Sync failed'
  };
  return labels[status] || 'Synced';
}
```

### Account Menu Dropdown

```typescript
// src/ui/components/AccountMenu.ts

let isAccountMenuOpen = false;

function toggleAccountMenu(): void {
  isAccountMenuOpen = !isAccountMenuOpen;
  renderAccountMenu();
}

function renderAccountMenu(): void {
  const existing = document.getElementById('account-menu');
  if (existing) existing.remove();

  if (!isAccountMenuOpen) return;

  const user = AuthService.getUser();
  const lastSynced = SaveManager.getLastSaved();

  const menu = document.createElement('div');
  menu.id = 'account-menu';
  menu.className = 'account-menu';
  menu.innerHTML = `
    <div class="account-menu-content">
      <div class="account-info">
        <div class="account-avatar">
          ${user?.avatarUrl
            ? `<img src="${user.avatarUrl}" alt="" />`
            : `<span class="avatar-placeholder">${user?.displayName?.charAt(0) || 'P'}</span>`
          }
        </div>
        <div class="account-details">
          <span class="account-name">${user?.displayName}</span>
          <span class="account-email">${user?.email || ''}</span>
        </div>
      </div>

      <div class="sync-info">
        <span class="sync-label">Last synced</span>
        <span class="sync-time">${formatRelativeTime(lastSynced)}</span>
      </div>

      <div class="menu-divider"></div>

      <button class="menu-item" onclick="handleSyncNow()">
        â˜ï¸ Sync Now
      </button>

      <button class="menu-item" onclick="navigateTo('settings')">
        âš™ï¸ Settings
      </button>

      <div class="menu-divider"></div>

      <button class="menu-item logout" onclick="handleLogout()">
        ğŸšª Sign Out
      </button>
    </div>
  `;

  // Close when clicking outside
  menu.addEventListener('click', (e) => {
    if (e.target === menu) {
      toggleAccountMenu();
    }
  });

  document.body.appendChild(menu);
}

async function handleLogout(): Promise<void> {
  toggleAccountMenu();

  try {
    await AuthService.logout();
    showToast({
      type: 'info',
      message: 'Signed out. Your local progress is preserved.',
      duration: 4000
    });
    renderMainMenu(); // Re-render to show guest state
  } catch (error) {
    showToast({
      type: 'error',
      message: 'Sign out failed. Please try again.',
      duration: 3000
    });
  }
}

async function handleSyncNow(): Promise<void> {
  toggleAccountMenu();

  try {
    await SaveManager.syncToCloud();
    showToast({
      type: 'success',
      message: 'Progress synced!',
      duration: 2000
    });
  } catch (error) {
    showToast({
      type: 'error',
      message: 'Sync failed. Will retry automatically.',
      duration: 3000
    });
  }
}

function formatRelativeTime(date: Date): string {
  const now = Date.now();
  const diff = now - date.getTime();

  if (diff < 60000) return 'Just now';
  if (diff < 3600000) return `${Math.floor(diff / 60000)} min ago`;
  if (diff < 86400000) return `${Math.floor(diff / 3600000)} hours ago`;
  return date.toLocaleDateString();
}

// Expose to window
(window as any).toggleAccountMenu = toggleAccountMenu;
(window as any).handleLogout = handleLogout;
(window as any).handleSyncNow = handleSyncNow;
```

### CSS Styles

```css
/* Account Status in Header */
.account-status {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 0.75rem;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 20px;
  cursor: pointer;
  font-size: 0.875rem;
  transition: background 0.2s;
}

.account-status:hover {
  background: rgba(255, 255, 255, 0.15);
}

.account-status.guest {
  background: transparent;
}

.account-status .divider {
  color: var(--color-muted);
}

.account-status .dropdown-arrow {
  font-size: 0.625rem;
  opacity: 0.7;
}

.sign-in-link {
  background: var(--color-accent);
  color: white;
  border: none;
  padding: 0.25rem 0.75rem;
  border-radius: 12px;
  font-size: 0.75rem;
  cursor: pointer;
  margin-left: 0.5rem;
}

.sync-spinner-small {
  display: inline-block;
  width: 12px;
  height: 12px;
  border: 2px solid currentColor;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

/* Account Menu Dropdown */
.account-menu {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding-top: 60px;
  z-index: 1000;
}

.account-menu-content {
  background: var(--color-surface);
  border-radius: 12px;
  padding: 1rem;
  min-width: 280px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.account-info {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding-bottom: 1rem;
}

.account-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  overflow: hidden;
  background: var(--color-accent);
  display: flex;
  align-items: center;
  justify-content: center;
}

.account-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.avatar-placeholder {
  font-size: 1.5rem;
  color: white;
  font-weight: bold;
}

.account-details {
  display: flex;
  flex-direction: column;
}

.account-name {
  font-weight: 600;
  font-size: 1rem;
}

.account-email {
  font-size: 0.75rem;
  color: var(--color-muted);
}

.sync-info {
  display: flex;
  justify-content: space-between;
  font-size: 0.75rem;
  color: var(--color-muted);
  padding: 0.5rem 0;
}

.menu-divider {
  height: 1px;
  background: var(--color-border);
  margin: 0.5rem 0;
}

.menu-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  width: 100%;
  padding: 0.75rem;
  background: transparent;
  border: none;
  border-radius: 6px;
  color: var(--color-text);
  font-size: 0.875rem;
  cursor: pointer;
  text-align: left;
  transition: background 0.2s;
}

.menu-item:hover {
  background: rgba(255, 255, 255, 0.1);
}

.menu-item.logout {
  color: var(--color-error);
}
```

### Logout Behavior

When logging out:
1. Clear auth tokens from localStorage
2. Clear user state in AuthService
3. Keep save data in localStorage (don't delete progress)
4. Show confirmation toast
5. Update UI to show guest state

```typescript
// src/services/AuthService.ts

async logout(): Promise<void> {
  // Optionally notify server to revoke refresh token
  try {
    await fetch(`${API_URL}/api/auth/logout`, {
      method: 'POST',
      headers: this.getAuthHeaders()
    });
  } catch (e) {
    // Ignore errors - logout locally anyway
  }

  // Clear tokens
  this.clearTokens();
  this.user = null;
  this.notifyListeners();

  // Note: We do NOT clear SaveManager data
  // Local progress is preserved
}
```

## Definition of Done

- [ ] Logged-in users see their name in header
- [ ] Sync status indicator updates correctly
- [ ] Account menu opens on click
- [ ] Menu shows user info and last sync time
- [ ] "Sync Now" button works
- [ ] Logout works and preserves local data
- [ ] Guests see "Sign In" button

## Dependencies

- Story 14.6 or 14.7 (Auth)
- Story 14.9 (SaveManager Refactor - for sync status)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-05 | 1.0 | Story created | Mary (Analyst) |
