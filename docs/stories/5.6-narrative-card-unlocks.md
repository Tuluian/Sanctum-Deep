# Story 5.6: Narrative Card Unlocks

## Status: Approved

## Story

**As a** player progressing through the game,
**I want** to unlock new cards through narrative achievements and discoveries,
**so that** my deck-building options expand meaningfully as I experience the story.

## Narrative Philosophy

Cards aren't just mechanics—they're knowledge gained, techniques learned, and powers discovered. A Cleric who defeats the Bonelord might learn "Shatter the Undead" from witnessing his weakness. A Knight who finds their mentor's remains might unlock "Ser Aldric's Last Stand."

This system ties card progression to story moments, making unlocks feel earned and meaningful rather than random.

## Acceptance Criteria

1. Cards can be locked behind narrative triggers (boss defeats, discoveries, class-specific moments)
2. Unlocked cards are added to the class's reward pool permanently
3. Unlock progress persists across runs (meta-progression)
4. Visual/audio feedback when a card is unlocked
5. Card unlock screen shows the narrative context for why it was unlocked
6. Locked cards visible but grayed out in collection view with unlock hints
7. Some cards require multiple conditions (e.g., "Defeat Bonelord as Cleric")

## Unlock Trigger Types

### Boss Defeats
Cards unlocked by defeating specific bosses (any class)

| Card | Trigger | Narrative |
|------|---------|-----------|
| Shatter Bones | Defeat Bonelord | "You learned where the undead are weakest." |
| Drown the Darkness | Defeat Drowned King | "Water can purify. You witnessed it firsthand." |
| Void Resistance | Defeat Hollow God | "You stared into nothing and nothing blinked first." |

### Class-Specific Boss Defeats
Cards unlocked by defeating bosses as a specific class

| Card | Class | Trigger | Narrative |
|------|-------|---------|-----------|
| Lord Vexal's Folly | Knight | Defeat Bonelord | "Pride was his weakness. Let it be your strength." |
| Aldric's Sacrifice | Cleric | Defeat Drowned King | "He gave everything for love. You understand now." |
| Unmaking Word | Diabolist | Defeat Hollow God | "Xan'thrax taught you to destroy. The void taught you what destruction means." |

### Discovery Events
Cards unlocked by finding specific things during runs

| Card | Trigger | Location | Narrative |
|------|---------|----------|-----------|
| Mentor's Technique | Find Ser Aldric's crest | Act 1 Elite | "His shield is broken, but his teachings remain." |
| Prayer of the Lost | Find the abandoned altar | Act 1 Shrine | "Someone prayed here once. Their words still echo." |
| Thalassar's Memory | Find the Queen's letters | Act 2 | "Love letters from a kingdom that no longer exists." |

### Shrine Choices
Cards unlocked by making specific shrine choices

| Card | Shrine | Choice | Narrative |
|------|--------|--------|-----------|
| Blood Offering | Shrine of Sacrifice | Sacrifice 10 HP | "Pain can be transformed into power." |
| Curse Eater | Shrine of Shadows | Accept a curse | "You learned to digest darkness." |
| Fate's Gambit | Shrine of Fortune | Win the gamble | "Fortune favors the bold—this time." |

### Achievement-Based
Cards unlocked through gameplay achievements

| Card | Achievement | Narrative |
|------|-------------|-----------|
| One With Nothing | Win a combat with 0 cards in hand | "Emptiness became your weapon." |
| Endless Resolve | Spend 20+ Resolve in a single turn | "Your will is bottomless." |
| Untouchable | Win a combat without taking damage | "They couldn't touch you. They never will." |
| Survivor's Instinct | Win a run after triggering Death's Door | "You came back from the edge. You brought something with you." |

### Run Milestones
Cards unlocked by reaching certain points

| Card | Milestone | Narrative |
|------|-----------|-----------|
| Warden's Whisper | Reach Act 3 for the first time | "The Warden speaks to you now. Listen." |
| True Ending Glimpse | Complete a run with any class | "You know how the story ends. Now learn to change it." |
| Legacy of Five | Complete a run with all 5 classes | "Every path leads here. Every lesson combines." |

## Tasks / Subtasks

- [ ] Design unlock data structure
  - [ ] Create `src/types/unlocks.ts`
  - [ ] Define `CardUnlock` interface
  - [ ] Define `UnlockTrigger` types
  - [ ] Define `UnlockProgress` persistence

- [ ] Implement unlock service
  - [ ] Create `src/services/CardUnlockService.ts`
  - [ ] Track unlocked cards per class
  - [ ] Check trigger conditions
  - [ ] Fire unlock events
  - [ ] Persist to localStorage

- [ ] Define unlockable cards
  - [ ] Create `src/data/unlockableCards.ts`
  - [ ] Define 5+ boss-unlock cards
  - [ ] Define 5+ discovery-unlock cards
  - [ ] Define 5+ achievement-unlock cards
  - [ ] Add unlock requirements to each

- [ ] Integrate with game systems
  - [ ] Hook boss defeat events
  - [ ] Hook shrine choice events
  - [ ] Hook discovery events
  - [ ] Hook achievement triggers

- [ ] Implement unlock UI
  - [ ] Create card unlock popup/modal
  - [ ] Show narrative text
  - [ ] Play unlock sound effect
  - [ ] Add unlock animation

- [ ] Implement collection view
  - [ ] Show all cards (locked and unlocked)
  - [ ] Locked cards grayed with "???" or silhouette
  - [ ] Hover shows unlock hint
  - [ ] Track unlock progress

- [ ] Write unit tests
  - [ ] Test trigger detection
  - [ ] Test persistence
  - [ ] Test card pool modification
  - [ ] Test multi-condition unlocks

## Dev Notes

### Unlock Data Structure

```typescript
// src/types/unlocks.ts

export type UnlockTriggerType =
  | 'BOSS_DEFEAT'
  | 'CLASS_BOSS_DEFEAT'
  | 'DISCOVERY'
  | 'SHRINE_CHOICE'
  | 'ACHIEVEMENT'
  | 'MILESTONE';

export interface UnlockTrigger {
  type: UnlockTriggerType;
  // Boss defeats
  bossId?: string;
  // Class-specific
  requiredClass?: CharacterClassId;
  // Discovery/Shrine
  eventId?: string;
  choiceId?: string;
  // Achievement
  achievementId?: string;
  // Milestone
  milestoneId?: string;
}

export interface CardUnlock {
  cardId: string;
  triggers: UnlockTrigger[]; // All must be satisfied (AND logic)
  narrativeText: string;
  hintText: string; // Shown when locked
  classRestriction?: CharacterClassId; // Only this class can use it
}

export interface UnlockProgress {
  unlockedCards: string[];
  seenEvents: string[]; // Track discoveries/choices made
  defeatedBosses: Record<string, CharacterClassId[]>; // bossId -> classes that beat it
  achievementsEarned: string[];
  milestonesReached: string[];
}
```

### Unlock Definitions

```typescript
// src/data/unlockableCards.ts

export const UNLOCKABLE_CARDS: CardUnlock[] = [
  // Boss Unlock - Any Class
  {
    cardId: 'shatter_bones',
    triggers: [{ type: 'BOSS_DEFEAT', bossId: 'bonelord' }],
    narrativeText: "Lord Vexal's skeleton crumbles. In its fall, you see the weakness of all undead—the joints, the bindings, the hollow core. This knowledge becomes power.",
    hintText: "Defeat the Bonelord",
  },

  // Class-Specific Boss Unlock
  {
    cardId: 'lord_vexals_folly',
    triggers: [
      { type: 'BOSS_DEFEAT', bossId: 'bonelord' },
      { type: 'CLASS_BOSS_DEFEAT', bossId: 'bonelord', requiredClass: CharacterClassId.DUNGEON_KNIGHT },
    ],
    narrativeText: "He sought immortality through pride. You watched him fall. Let his mistake be your lesson—and your weapon.",
    hintText: "Defeat the Bonelord as the Dungeon Knight",
    classRestriction: CharacterClassId.DUNGEON_KNIGHT,
  },

  // Discovery Unlock
  {
    cardId: 'mentors_technique',
    triggers: [{ type: 'DISCOVERY', eventId: 'find_aldric_crest' }],
    narrativeText: "Ser Aldric's crest is cold in your hands. The metal remembers his grip, his stance, his final teaching: 'Hold until you cannot. Then hold longer.'",
    hintText: "Find Ser Aldric's remains in the Sanctum",
    classRestriction: CharacterClassId.DUNGEON_KNIGHT,
  },

  // Shrine Choice Unlock
  {
    cardId: 'blood_offering',
    triggers: [{ type: 'SHRINE_CHOICE', eventId: 'shrine_sacrifice', choiceId: 'sacrifice_hp' }],
    narrativeText: "Your blood drips onto the altar. It doesn't disappear—it transforms. Pain becomes something you can give to others.",
    hintText: "Sacrifice HP at the Shrine of Sacrifice",
  },

  // Achievement Unlock
  {
    cardId: 'one_with_nothing',
    triggers: [{ type: 'ACHIEVEMENT', achievementId: 'empty_hand_victory' }],
    narrativeText: "They expected a card. You had none. They expected defeat. You gave them emptiness—and emptiness won.",
    hintText: "Win a combat with 0 cards in hand",
  },

  // Multi-Condition Unlock
  {
    cardId: 'true_faith',
    triggers: [
      { type: 'BOSS_DEFEAT', bossId: 'hollow_god' },
      { type: 'CLASS_BOSS_DEFEAT', bossId: 'hollow_god', requiredClass: CharacterClassId.CLERIC },
      { type: 'ACHIEVEMENT', achievementId: 'max_devotion_victory' },
    ],
    narrativeText: "You stared into absolute nothing and believed anyway. Your god may be silent, but you are not. You are the answer to your own prayers.",
    hintText: "Master devotion and face the ultimate void as the Cleric",
    classRestriction: CharacterClassId.CLERIC,
  },
];
```

### Card Unlock Service

```typescript
// src/services/CardUnlockService.ts

export class CardUnlockService {
  private progress: UnlockProgress;

  constructor() {
    this.loadProgress();
  }

  // Check if a specific trigger is satisfied
  private isTriggerSatisfied(trigger: UnlockTrigger): boolean {
    switch (trigger.type) {
      case 'BOSS_DEFEAT':
        return !!this.progress.defeatedBosses[trigger.bossId!];

      case 'CLASS_BOSS_DEFEAT':
        const classes = this.progress.defeatedBosses[trigger.bossId!] || [];
        return classes.includes(trigger.requiredClass!);

      case 'DISCOVERY':
        return this.progress.seenEvents.includes(trigger.eventId!);

      case 'SHRINE_CHOICE':
        return this.progress.seenEvents.includes(`${trigger.eventId}_${trigger.choiceId}`);

      case 'ACHIEVEMENT':
        return this.progress.achievementsEarned.includes(trigger.achievementId!);

      case 'MILESTONE':
        return this.progress.milestonesReached.includes(trigger.milestoneId!);

      default:
        return false;
    }
  }

  // Check if a card should be unlocked
  isCardUnlocked(cardId: string): boolean {
    if (this.progress.unlockedCards.includes(cardId)) return true;

    const unlock = UNLOCKABLE_CARDS.find(u => u.cardId === cardId);
    if (!unlock) return true; // Not in unlock list = always available

    // All triggers must be satisfied
    return unlock.triggers.every(t => this.isTriggerSatisfied(t));
  }

  // Record a boss defeat
  recordBossDefeat(bossId: string, classId: CharacterClassId): CardUnlock[] {
    if (!this.progress.defeatedBosses[bossId]) {
      this.progress.defeatedBosses[bossId] = [];
    }
    if (!this.progress.defeatedBosses[bossId].includes(classId)) {
      this.progress.defeatedBosses[bossId].push(classId);
    }

    return this.checkNewUnlocks();
  }

  // Record a discovery/event
  recordEvent(eventId: string, choiceId?: string): CardUnlock[] {
    const key = choiceId ? `${eventId}_${choiceId}` : eventId;
    if (!this.progress.seenEvents.includes(key)) {
      this.progress.seenEvents.push(key);
    }

    return this.checkNewUnlocks();
  }

  // Record an achievement
  recordAchievement(achievementId: string): CardUnlock[] {
    if (!this.progress.achievementsEarned.includes(achievementId)) {
      this.progress.achievementsEarned.push(achievementId);
    }

    return this.checkNewUnlocks();
  }

  // Check for newly unlocked cards
  private checkNewUnlocks(): CardUnlock[] {
    const newUnlocks: CardUnlock[] = [];

    for (const unlock of UNLOCKABLE_CARDS) {
      if (this.progress.unlockedCards.includes(unlock.cardId)) continue;

      if (unlock.triggers.every(t => this.isTriggerSatisfied(t))) {
        this.progress.unlockedCards.push(unlock.cardId);
        newUnlocks.push(unlock);
      }
    }

    if (newUnlocks.length > 0) {
      this.saveProgress();
    }

    return newUnlocks;
  }

  // Get available cards for a class (base pool + unlocked)
  getAvailableCards(classId: CharacterClassId): CardDefinition[] {
    const basePool = getClassCardPool(classId);
    const unlocked = this.progress.unlockedCards
      .map(id => getCardById(id))
      .filter(card => card && (!card.classRestriction || card.classRestriction === classId));

    return [...basePool, ...unlocked];
  }

  // Get unlock hint for a locked card
  getUnlockHint(cardId: string): string | null {
    const unlock = UNLOCKABLE_CARDS.find(u => u.cardId === cardId);
    return unlock?.hintText ?? null;
  }
}
```

### Unlock UI Flow

```
┌──────────────────────────────────────────────────────────────┐
│                     ✨ CARD UNLOCKED ✨                      │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│                    ┌─────────────────┐                       │
│                    │   SHATTER       │                       │
│                    │    BONES        │                       │
│                    │                 │                       │
│                    │  Deal 12 damage │                       │
│                    │  to undead.     │                       │
│                    │  Deal 8 to      │                       │
│                    │  others.        │                       │
│                    │        2        │                       │
│                    └─────────────────┘                       │
│                                                              │
│  "Lord Vexal's skeleton crumbles. In its fall, you see      │
│   the weakness of all undead—the joints, the bindings,      │
│   the hollow core. This knowledge becomes power."           │
│                                                              │
│              This card is now in your reward pool.          │
│                                                              │
│                      [ Continue ]                            │
└──────────────────────────────────────────────────────────────┘
```

### Integration Points

**Boss Defeat:**
```typescript
// In handleBossDefeat()
const newUnlocks = CardUnlockService.recordBossDefeat(bossId, currentClassId);
for (const unlock of newUnlocks) {
  showCardUnlockPopup(unlock);
  AudioManager.playSfx('card-unlock');
}
```

**Shrine Choice:**
```typescript
// In handleShrineChoice()
const newUnlocks = CardUnlockService.recordEvent(shrineId, choiceId);
// Show unlocks after shrine resolution
```

**Achievement:**
```typescript
// In AchievementService.grant()
const newUnlocks = CardUnlockService.recordAchievement(achievementId);
// Queue unlock popups after achievement popup
```

### Narrative Card Examples

**Shatter Bones** (Unlocked: Defeat Bonelord)
- Cost: 2
- Type: Attack
- Effect: Deal 12 damage to Undead enemies. Deal 8 damage to others.
- Flavor: "The dead have weaknesses. You learned them the hard way."

**Lord Vexal's Folly** (Unlocked: Defeat Bonelord as Knight)
- Cost: 1
- Type: Skill
- Effect: Gain 8 Block. If enemy intends to buff, gain 12 instead.
- Flavor: "Pride goes before the fall. You've seen it firsthand."

**Mentor's Technique** (Unlocked: Find Ser Aldric's crest)
- Cost: 2
- Type: Attack
- Effect: Deal 10 damage. Gain Fortify equal to damage dealt.
- Flavor: "Hold until you cannot. Then hold longer."

**One With Nothing** (Unlocked: Win with 0 cards in hand)
- Cost: 0
- Type: Skill
- Effect: If your hand is empty, gain 15 Block and draw 2 cards.
- Flavor: "Emptiness is not weakness. It is potential."

## Testing

### Test File Location
`src/tests/services/CardUnlockService.test.ts`

### Key Test Scenarios

1. **Single Trigger Unlock**: Boss defeat unlocks card
2. **Multi-Trigger Unlock**: All conditions must be met
3. **Class-Specific**: Only unlocks for correct class
4. **Persistence**: Unlocks persist across sessions
5. **No Duplicates**: Can't unlock same card twice
6. **Card Pool Integration**: Unlocked cards appear in rewards

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-03 | 1.0 | Initial story creation | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_
