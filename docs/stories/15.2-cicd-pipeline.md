# Story 15.2: CI/CD Pipeline (GitHub Actions)

## Status: Draft

## Story

**As a** developer deploying Sanctum Ruins,
**I want** automated testing and deployment via GitHub Actions,
**so that** code quality is ensured and deployments are consistent and reliable.

## Acceptance Criteria

1. GitHub Actions workflow runs on push to main branch
2. Workflow runs TypeScript type checking (`npm run build`)
3. Workflow runs all tests (`npm run test:run`)
4. Workflow runs linting (`npm run lint`)
5. Build artifacts are produced on successful pipeline
6. Failed checks block merging to main (branch protection)
7. Deployment to Heroku triggers automatically on main branch success

## Tasks / Subtasks

- [ ] Create GitHub Actions workflow file (AC: 1, 2, 3, 4)
  - [ ] Create `.github/workflows/ci.yml`
  - [ ] Configure Node.js environment (v18+)
  - [ ] Add npm install step with caching
  - [ ] Add type check step (`npm run build`)
  - [ ] Add test step (`npm run test:run`)
  - [ ] Add lint step (`npm run lint`)
- [ ] Configure build artifacts (AC: 5)
  - [ ] Upload dist/ folder as artifact on success
  - [ ] Set artifact retention period
- [ ] Set up branch protection (AC: 6)
  - [ ] Require status checks to pass before merging
  - [ ] Require branches to be up to date before merging
- [ ] Configure Heroku deployment (AC: 7)
  - [ ] Add Heroku API key to GitHub secrets
  - [ ] Add deployment job that runs after CI passes
  - [ ] Configure Heroku app name in workflow

## Dev Notes

### GitHub Actions Workflow Structure

```yaml
# .github/workflows/ci.yml
name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - run: npm run lint
      - run: npm run build
      - run: npm run test:run
      - uses: actions/upload-artifact@v4
        if: success()
        with:
          name: dist
          path: dist/
          retention-days: 7

  deploy:
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: akhileshns/heroku-deploy@v3.12.14
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: "sanctum-ruins"
          heroku_email: ${{ secrets.HEROKU_EMAIL }}
```

### Required GitHub Secrets
- `HEROKU_API_KEY` - From Heroku account settings
- `HEROKU_EMAIL` - Heroku account email

### Branch Protection Settings
In GitHub repo Settings → Branches → Add rule:
- Branch name pattern: `main`
- Require status checks: `build-and-test`
- Require branches to be up to date

### Relevant Files
- `.github/workflows/ci.yml` (new)
- `package.json` (verify scripts exist)

## Testing

- Test file location: N/A (infrastructure)
- Manual verification:
  - Push to a PR branch, verify workflow runs
  - Merge to main, verify deployment triggers
  - Intentionally fail a test, verify PR is blocked

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-05 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

_To be filled by Dev agent_

---

## QA Results

_To be filled by QA agent_
