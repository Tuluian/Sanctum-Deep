# Story 14.13: Manual Cloud Save Button

## Status: Draft

## Story

**As a** logged-in player,
**I want** a button to manually save my progress to the cloud,
**so that** I can ensure my progress is backed up before closing the game.

## Acceptance Criteria

1. "Save to Cloud" button appears in settings/menu when logged in
2. Button is disabled/hidden for guests
3. Clicking button triggers immediate cloud sync
4. Button shows loading state during sync
5. Success/failure feedback is shown to player
6. Button is disabled while sync is in progress

## Tasks

- [ ] Add "Save to Cloud" button to settings screen
- [ ] Implement click handler calling SaveManager.syncToCloud()
- [ ] Add loading state to button
- [ ] Show success toast on completion
- [ ] Show error toast on failure
- [ ] Hide/disable button for guests

## Technical Notes

### Button Placement

The button should appear in the Settings screen or main menu pause overlay:

```
┌─────────────────────────────────┐
│           Settings              │
├─────────────────────────────────┤
│  Volume: [========] 80%         │
│  Music:  [======] 60%           │
│  SFX:    [==========] 100%      │
│                                 │
│  Animation Speed: [Normal ▼]    │
│  Screen Shake: [✓]              │
│                                 │
├─────────────────────────────────┤
│  [☁️ Save to Cloud]             │  ← Only for logged-in users
│  Last synced: 2 minutes ago     │
├─────────────────────────────────┤
│  [Back to Menu]                 │
└─────────────────────────────────┘
```

### Button Component

```typescript
// src/ui/components/CloudSaveButton.ts

type ButtonState = 'idle' | 'syncing' | 'success' | 'error';

function renderCloudSaveButton(): string {
  if (!AuthService.isAuthenticated()) {
    return ''; // Hide for guests
  }

  const syncStatus = SaveManager.getSyncStatus();
  const lastSynced = getLastSyncedText();

  return `
    <div class="cloud-save-section">
      <button
        id="cloud-save-btn"
        class="btn cloud-save-btn"
        onclick="handleCloudSave()"
        ${syncStatus === 'syncing' ? 'disabled' : ''}
      >
        ${getButtonContent(syncStatus)}
      </button>
      <p class="last-synced">${lastSynced}</p>
    </div>
  `;
}

function getButtonContent(status: SyncStatus): string {
  switch (status) {
    case 'syncing':
      return '<span class="spinner"></span> Saving...';
    case 'synced':
      return '☁️ Save to Cloud';
    case 'error':
      return '⚠️ Retry Save';
    default:
      return '☁️ Save to Cloud';
  }
}

function getLastSyncedText(): string {
  const lastSaved = SaveManager.getLastSaved();
  const now = Date.now();
  const diff = now - lastSaved.getTime();

  if (diff < 60000) {
    return 'Last synced: Just now';
  } else if (diff < 3600000) {
    const mins = Math.floor(diff / 60000);
    return `Last synced: ${mins} minute${mins > 1 ? 's' : ''} ago`;
  } else if (diff < 86400000) {
    const hours = Math.floor(diff / 3600000);
    return `Last synced: ${hours} hour${hours > 1 ? 's' : ''} ago`;
  } else {
    return `Last synced: ${lastSaved.toLocaleDateString()}`;
  }
}
```

### Click Handler

```typescript
// src/ui/handlers/cloudSave.ts

async function handleCloudSave(): Promise<void> {
  const button = document.getElementById('cloud-save-btn') as HTMLButtonElement;

  if (!button || button.disabled) return;

  // Disable button and show loading state
  button.disabled = true;
  button.innerHTML = '<span class="spinner"></span> Saving...';

  try {
    await SaveManager.syncToCloud();

    // Show success
    button.innerHTML = '✓ Saved!';
    button.classList.add('success');

    showToast({
      type: 'success',
      message: 'Progress saved to cloud',
      duration: 3000
    });

    // Reset button after delay
    setTimeout(() => {
      button.innerHTML = '☁️ Save to Cloud';
      button.classList.remove('success');
      button.disabled = false;
    }, 2000);

  } catch (error) {
    // Show error
    button.innerHTML = '⚠️ Failed';
    button.classList.add('error');

    showToast({
      type: 'error',
      message: 'Could not save to cloud. Will retry automatically.',
      duration: 4000
    });

    // Reset button after delay
    setTimeout(() => {
      button.innerHTML = '⚠️ Retry Save';
      button.classList.remove('error');
      button.disabled = false;
    }, 2000);
  }
}

// Expose to window for onclick handler
(window as any).handleCloudSave = handleCloudSave;
```

### CSS Styles

```css
.cloud-save-section {
  padding: 1rem 0;
  border-top: 1px solid var(--color-border);
  margin-top: 1rem;
}

.cloud-save-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  width: 100%;
  padding: 0.75rem 1rem;
  font-size: 1rem;
  background: var(--color-accent);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
}

.cloud-save-btn:hover:not(:disabled) {
  background: var(--color-accent-hover);
}

.cloud-save-btn:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}

.cloud-save-btn.success {
  background: var(--color-success);
}

.cloud-save-btn.error {
  background: var(--color-error);
}

.cloud-save-btn .spinner {
  width: 16px;
  height: 16px;
  border: 2px solid white;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

.last-synced {
  font-size: 0.75rem;
  color: var(--color-muted);
  text-align: center;
  margin-top: 0.5rem;
}
```

### For Guests: Sign In Prompt

```typescript
function renderCloudSaveForGuest(): string {
  return `
    <div class="cloud-save-section guest">
      <p class="cloud-save-prompt">
        Playing as guest. Progress is saved locally only.
      </p>
      <button class="btn secondary" onclick="showAuthScreen()">
        Sign in to enable cloud saves
      </button>
    </div>
  `;
}
```

## Definition of Done

- [ ] Button appears in settings for logged-in users
- [ ] Button hidden/alternative shown for guests
- [ ] Click triggers cloud sync
- [ ] Loading state shows during sync
- [ ] Success feedback shown
- [ ] Error feedback shown with retry option
- [ ] "Last synced" timestamp displayed

## Dependencies

- Story 14.9 (SaveManager Refactor)
- Story 14.6 or 14.7 (Auth)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-05 | 1.0 | Story created | Mary (Analyst) |
