# Story 14.8: Guest-to-Account Conversion

## Status: Draft

## Story

**As a** guest player,
**I want** to create an account and keep my progress,
**so that** I don't lose my Soul Echoes, achievements, and upgrades when I sign up.

## Acceptance Criteria

1. Guest progress (localStorage) is preserved when creating account
2. First cloud sync uploads guest progress (not downloads empty cloud data)
3. If account already has cloud data, use last-write-wins (timestamp comparison)
4. Guest UI prompts encourage account creation without being annoying
5. Conversion works for both email/password and Google OAuth signup
6. Player sees confirmation that progress was saved to cloud

## Tasks

- [ ] Implement "first sync" logic that uploads localStorage on new account
- [ ] Add timestamp comparison for existing accounts
- [ ] Show success message after progress is synced
- [ ] Test conversion flow for email signup
- [ ] Test conversion flow for Google OAuth
- [ ] Test edge case: account exists with older cloud data
- [ ] Test edge case: account exists with newer cloud data

## Technical Notes

### First Sync Logic

When a guest creates an account, the sync flow must detect this is a "first sync":

```typescript
// src/services/CloudSyncService.ts

async syncOnLogin(): Promise<SyncResult> {
  const localData = saveManager.getSaveData();
  const cloudData = await this.pullFromCloud();

  // Case 1: No cloud data (new account or never synced)
  if (!cloudData) {
    console.log('First sync: uploading local progress to cloud');
    await this.pushToCloud(localData);
    return {
      status: 'success',
      action: 'uploaded',
      message: 'Your progress has been saved to the cloud!'
    };
  }

  // Case 2: Both have data - compare timestamps (last-write-wins)
  if (localData.lastSaved > cloudData.lastSaved) {
    console.log('Local is newer: uploading to cloud');
    await this.pushToCloud(localData);
    return {
      status: 'success',
      action: 'uploaded',
      message: 'Your local progress was more recent and has been saved.'
    };
  } else if (cloudData.lastSaved > localData.lastSaved) {
    console.log('Cloud is newer: downloading to local');
    saveManager.loadSaveData(cloudData);
    return {
      status: 'success',
      action: 'downloaded',
      message: 'Your cloud progress has been restored.'
    };
  }

  // Case 3: Same timestamp (unlikely but possible)
  return {
    status: 'success',
    action: 'none',
    message: 'Progress is already synced.'
  };
}
```

### Sync Result Display

```typescript
// Show result to user after login/register
async function handleAuthSuccess(): Promise<void> {
  try {
    const result = await cloudSyncService.syncOnLogin();

    showToast({
      type: 'success',
      message: result.message,
      duration: 4000
    });
  } catch (error) {
    showToast({
      type: 'warning',
      message: 'Signed in, but sync failed. Will retry later.',
      duration: 4000
    });
  }
}
```

### Progress Summary

When showing sync results, include a summary of what was synced:

```typescript
function formatSyncSummary(data: SaveData): string {
  const { meta } = data;
  return `
    Soul Echoes: ${meta.soulEchoes}
    Achievements: ${meta.unlockedAchievements.length}
    Upgrades: ${meta.purchasedUpgrades.length}
  `.trim();
}

// Show in toast or modal
showToast({
  type: 'success',
  message: `Progress saved to cloud!\n${formatSyncSummary(localData)}`,
  duration: 5000
});
```

### Edge Cases

| Scenario | Behavior |
|----------|----------|
| Guest has progress, creates new account | Upload local → cloud |
| Guest has progress, links existing Google with empty cloud | Upload local → cloud |
| Guest has progress, links existing Google with older cloud data | Upload local → cloud (local wins) |
| Guest has progress, links existing Google with newer cloud data | Download cloud → local (cloud wins) |
| Guest has no progress, links existing Google with cloud data | Download cloud → local |
| Guest has no progress, creates new account | Nothing to sync |

### Detecting "Fresh" Local Data

A guest who just opened the game for the first time shouldn't overwrite existing cloud data:

```typescript
function isLocalDataMeaningful(data: SaveData): boolean {
  // Has any progress beyond defaults?
  return (
    data.meta.soulEchoes > 0 ||
    data.meta.unlockedAchievements.length > 0 ||
    data.meta.purchasedUpgrades.length > 0 ||
    data.meta.statistics.totalRuns > 0
  );
}

async syncOnLogin(): Promise<SyncResult> {
  const localData = saveManager.getSaveData();
  const cloudData = await this.pullFromCloud();

  const localHasProgress = isLocalDataMeaningful(localData);
  const cloudHasProgress = cloudData && isLocalDataMeaningful(cloudData);

  // Fresh local + cloud has data → download cloud
  if (!localHasProgress && cloudHasProgress) {
    saveManager.loadSaveData(cloudData);
    return { status: 'success', action: 'downloaded' };
  }

  // Local has progress + no cloud → upload local
  if (localHasProgress && !cloudHasProgress) {
    await this.pushToCloud(localData);
    return { status: 'success', action: 'uploaded' };
  }

  // Both have progress → timestamp wins
  // ...
}
```

### UI Flow

```
1. Guest plays game, earns Soul Echoes, unlocks achievements
2. Guest clicks "Sign In" button
3. Guest chooses "Create Account" or "Sign in with Google"
4. Auth completes successfully
5. CloudSyncService.syncOnLogin() runs automatically
6. Toast appears: "Progress saved to cloud! (150 Soul Echoes, 3 Achievements)"
7. Auth status updates to show logged-in user
```

## Definition of Done

- [ ] Guest progress is preserved on account creation
- [ ] Timestamp comparison works correctly
- [ ] Success message shows what was synced
- [ ] Works for email signup
- [ ] Works for Google OAuth
- [ ] Edge cases handled correctly

## Dependencies

- Story 14.6 (Google OAuth)
- Story 14.7 (Email/Password Auth)
- Story 14.10 (Cloud Sync on App Load)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-05 | 1.0 | Story created | Mary (Analyst) |
