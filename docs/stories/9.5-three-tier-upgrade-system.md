# Story 9.5: Three-Tier Upgrade System

## Status: Draft

## Story

**As a** player making strategic decisions,
**I want** three distinct types of upgrades with different durations,
**so that** I can make meaningful choices about short-term vs long-term power.

## Acceptance Criteria

1. **Combat Upgrades**: Last for "rest of this combat" only
2. **Run Upgrades**: Last for "rest of this run" only
3. **Permanent Upgrades**: Persist forever across all runs
4. Clear visual distinction between upgrade types
5. UI shows active upgrades and their durations
6. Balanced cost/benefit for each tier
7. All three types available through gameplay (shrines, merchants, rewards)

## Upgrade Type Definitions

### Tier 1: Combat Upgrades (Temporary)
**Duration**: Current combat only
**Source**: Card effects, potions, shrine blessings
**Examples**:
- "+2 damage this combat"
- "Draw +1 card per turn this combat"
- "Enemies deal -1 damage this combat"

**Design Intent**: Tactical decisions, immediate power spikes

### Tier 2: Run Upgrades (Session)
**Duration**: Rest of current run (resets on death/victory)
**Source**: Shrines, merchants, boss rewards, campfire upgrades
**Examples**:
- "+5 max HP for this run"
- "Start each combat with 1 Strength"
- "Cards cost 1 less on first turn of combat"

**Design Intent**: Build-defining choices, run identity

### Tier 3: Permanent Upgrades (Forever)
**Duration**: Persists across all runs forever
**Source**: Meta-progression, achievements, class mastery
**Examples**:
- "Cleric starts with +3 max HP"
- "Unlock card X for card pool"
- "Gold bonus +5% from all sources"

**Design Intent**: Long-term progression, account power

## Tasks / Subtasks

- [ ] Define upgrade type system (AC: 1, 2, 3)
  - [ ] Create UpgradeType enum
  - [ ] Define duration/scope for each
  - [ ] Create Upgrade interface
- [ ] Implement Combat Upgrades (AC: 1)
  - [ ] Apply at combat start
  - [ ] Remove at combat end
  - [ ] Track active combat upgrades
- [ ] Implement Run Upgrades (AC: 2)
  - [ ] Apply when acquired
  - [ ] Persist through combats
  - [ ] Clear on run end
- [ ] Implement Permanent Upgrades (AC: 3)
  - [ ] Save to player profile
  - [ ] Load on game start
  - [ ] Apply globally
- [ ] Visual distinction (AC: 4)
  - [ ] Combat: Blue border/icon
  - [ ] Run: Green border/icon
  - [ ] Permanent: Gold border/icon
- [ ] Active upgrades UI (AC: 5)
  - [ ] Combat upgrades in combat HUD
  - [ ] Run upgrades in character panel
  - [ ] Permanent upgrades in profile
- [ ] Balance upgrade costs (AC: 6)
  - [ ] Combat: Cheap/free
  - [ ] Run: Medium cost
  - [ ] Permanent: Expensive/rare
- [ ] Integrate with game systems (AC: 7)
  - [ ] Shrines offer all three types
  - [ ] Merchants sell Run upgrades
  - [ ] Achievements grant Permanent

## Dev Notes

### Type Definitions

```typescript
enum UpgradeDuration {
  COMBAT = 'combat',    // Clears at combat end
  RUN = 'run',          // Clears at run end
  PERMANENT = 'permanent' // Never clears
}

interface Upgrade {
  id: string;
  name: string;
  description: string;
  duration: UpgradeDuration;
  effect: UpgradeEffect;
  source: string; // shrine, merchant, achievement, etc.
}
```

### Example Upgrades Per Tier

**Combat (Tier 1)**:
| Name | Effect | Source |
|------|--------|--------|
| Battle Focus | +1 card draw per turn | Shrine |
| Adrenaline | +2 damage dealt | Potion |
| Stone Skin | +3 block per turn | Card effect |

**Run (Tier 2)**:
| Name | Effect | Source |
|------|--------|--------|
| Vitality | +10 max HP | Shrine |
| Swift Hands | Start combats with +1 card | Merchant |
| Gold Sense | +20% gold from combats | Boss reward |

**Permanent (Tier 3)**:
| Name | Effect | Source |
|------|--------|--------|
| Cleric Mastery I | Cleric starts +5 HP | Class completion |
| Card Collector | Unlock [Card Name] | Achievement |
| Merchant Favor | Shop prices -5% | Meta progression |

### Relevant Files
- `src/types/upgrades.ts` (new)
- `src/services/UpgradeService.ts` (new)
- `src/engine/CombatEngine.ts` - apply combat upgrades
- `src/services/RunService.ts` - apply run upgrades
- `src/services/ProfileService.ts` - apply permanent upgrades

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-04 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

_To be filled by Dev agent_

---

## QA Results

_To be filled by QA agent_
